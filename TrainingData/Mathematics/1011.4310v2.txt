Combinatorial theorems in sparse random sets

arXiv:1011.4310v2 [math.CO] 2 Feb 2015

D. Conlon∗

W. T. Gowers

†

Abstract
We develop a new technique that allows us to show in a uniﬁed way that many well-known
combinatorial theorems, including Tur´an’s theorem, Szemer´edi’s theorem and Ramsey’s theorem,
hold almost surely inside sparse random sets. For instance, we extend Tur´an’s theorem to the
random setting by showing that for every ǫ > 0 and every positive integer t ≥ 3 there exists a
constant C such that, if G is a random graph on n vertices where each edge is chosen independently
with probability at least Cn−2/(t+1) , then, with probability tending to 1 as n tends to inﬁnity, every
1
subgraph of G with at least 1 − t−1
+ ǫ e(G) edges contains a copy of Kt . This is sharp up to
the constant C. We also show how to prove sparse analogues of structural results, giving two main
applications, a stability version of the random Tur´an theorem stated above and a sparse hypergraph
removal lemma. Many similar results have recently been obtained independently in a diﬀerent way
by Schacht and by Friedgut, R¨
odl and Schacht.

1

Introduction

In recent years there has been a trend in combinatorics towards proving that certain well-known
theorems, such as Ramsey’s theorem, Tur´
an’s theorem and Szemer´edi’s theorem, have “sparse random”
analogues. For instance, the ﬁrst non-trivial case of Tur´
an’s theorem asserts that a subgraph of Kn
with more than ⌊n/2⌋⌈n/2⌉ edges must contain a triangle. A sparse random analogue of this theorem
is the assertion that if one deﬁnes a random subgraph G of Kn by choosing each edge independently
at random with some very small probability p, then with high probability every subgraph H of G such
that |E(H)| ≥ 12 + ǫ |E(G)| will contain a triangle. Several results of this kind have been proved,
and in some cases, including this one, the exact bounds on what p one can take are known up to a
constant factor.
The greatest success in this line of research has been with analogues of Ramsey’s theorem [43].
Recall that Ramsey’s theorem (in one of its many forms) states that, for every graph H and every
natural number r, there exists n such that if the edges of the complete graph Kn are coloured with
r colours, then there must be a copy of H with all its edges of the same colour. Such a copy of H is
called monochromatic.
Let us say that a graph G is (H, r)-Ramsey if, however the edges of G are coloured with r colours,
there must be a monochromatic copy of H. After eﬀorts by several researchers [9, 39, 45, 46, 47], most
notably R¨
odl and Ruci´
nski, the following impressive theorem, a “sparse random version” of Ramsey’s
theorem, is now known. We write Gn,p for the standard binomial model of random graphs, where each
∗

Mathematical Institute, Oxford OX2 6GG, UK. E-mail: david.conlon@maths.ox.ac.uk. Research supported by a
Royal Society University Research Fellowship.
†
Department of Pure Mathematics and Mathematical Statistics, Wilberforce Road, Cambridge CB3 0WB, UK. Email:
W.T.Gowers@dpmms.cam.ac.uk. Research supported by a Royal Society 2010 Anniversary Research Professorship.

1

edge in an n-vertex graph is chosen independently with probability p. We also write vH and eH for
the number of vertices and edges, respectively, in a graph H.
Theorem 1.1. Let r ≥ 2 be a natural number and let H be a graph that is not a forest consisting of
stars and paths of length 3. Then there exist positive constants c and C such that
0, if p < cn−1/m2 (H) ,
1, if p > Cn−1/m2 (H) ,

lim P(Gn,p is (H, r)-Ramsey) =

n→∞

where
m2 (H) =

eK − 1
.
K⊂H,vK ≥3 vK − 2
max

That is, given a graph G that is not a disjoint union of stars and paths of length 3, there is
a threshold at approximately p = n−1/m2 (H) where the probability that the random graph Gn,p is
(H, r)-Ramsey changes from 0 to 1.
This theorem comes in two parts: the statement that above the threshold the graph is almost
certainly (H, r)-Ramsey and the statement that below the threshold it almost certainly is not. We
shall follow standard practice and call these the 1-statement and the 0-statement, respectively.
There have also been some eﬀorts towards proving sparse random versions of Tur´
an’s theorem,
but these have up to now been less successful. Tur´
an’s theorem [62], or rather its generalization, the
Erd˝os-Stone-Simonovits theorem (see for example [3]), states that if H is some ﬁxed graph, then any
graph with n vertices that contains more than
1−

1
+ o(1)
χ(H) − 1

n
2

edges must contain a copy of H. Here, χ(H) is the chromatic number of H.
Let us say that a graph G is (H, ǫ)-Tur´
an if every subgraph of G with at least
1−

1
+ ǫ e(G)
χ(H) − 1

edges contains a copy of H. One may then ask for the threshold at which a random graph becomes
(H, ǫ)-Tur´
an. The conjectured answer [26, 27, 36] is that the threshold is the same as it is for the
corresponding Ramsey property.
Conjecture 1.2. For every ǫ > 0 and every graph H there exist positive constants c and C such that
lim P(Gn,p is (H, ǫ)-Tur´
an) =

n→∞

0, if p < cn−1/m2 (H) ,
1, if p > Cn−1/m2 (H) ,

where
m2 (H) =

max

K⊂H,vK ≥3

eK − 1
.
vK − 2

A diﬀerence between this conjecture and Theorem 1.1 is that the 0-statement in this conjecture is
very simple to prove. To see this, suppose that p is such that the expected number of copies of H in
Gn,p is signiﬁcantly less than the expected number of edges in Gn,p . Then, since the number of copies
of H and the number of edges are both concentrated around their expectations, we can almost always
2

remove a small number of edges from Gn,p and get rid of all copies of H, which proves that Gn,p is
not (H, ǫ)-Tur´
an. The expected number of copies of H (if we label the vertices of H) is approximately
nvH peH , while the expected number of edges in Gn,p is approximately pn2 . The former becomes less
than the latter when p = n−(vH −2)/(eH −1) .
A further observation raises this bound. Suppose, for example, that H is a triangle with an
extra edge attached to one of its vertices. It is clear that the real obstacle to ﬁnding copies of H is
ﬁnding triangles: it is not hard to add edges to them. More generally, if H has a subgraph K with
eH −1
eK −1
−(vK −2)/(eK −1) , since if we can get rid of
vK −2 > vH −2 , then we can increase our estimate of p to n
copies of K then we have got rid of copies of H. Beyond this extra observation, there is no obvious
way of improving the bound for the 0-statement, which is why it is the conjectured upper bound as
well.
An argument along these lines does not work at all for the Ramsey property, since if one removes
a few edges in order to eliminate all copies of H in one colour, then one has to give them another
colour. Since the set of removed edges is likely to look fairly random, it is not at all clear that this
can be done in such a way as to eliminate all monochromatic copies of H.
Conjecture 1.2 is known to be true for some graphs, for example K3 , K4 , K5 (see [9, 36, 18],
respectively) and all cycles (see [13, 26, 27]), but it is open in general. Some partial results towards
the general conjecture, where the 1-statement is proved with a weaker exponent, have been given by
Kohayakawa, R¨
odl and Schacht [37] and Szab´
o and Vu [58]. The paper of Szab´
o and Vu contains the
best known upper bound in the case where H is the complete graph Kt for some t ≥ 6; the bound they
obtain is p = n−1/(t−1.5) , whereas the conjectured best possible bound is p = n−2/(t+1) (since m2 (Kt )
works out to be (t + 1)/2). Thus, there is quite a signiﬁcant gap. The full conjecture has also been
proved to be a consequence of the so-called KLR conjecture [36] of Kohayakawa, Luczak and R¨
odl.
This conjecture, regarding the number of H-free graphs of a certain type, remains open, except in a
few special cases [16, 17, 18, 35].1
As noted in [34, 36], the KLR conjecture would also imply the following structural result about Hfree graphs which contain nearly the extremal number of edges. The analogous result in the dense case,
due to Simonovits [57], is known as the stability theorem. Roughly speaking, it says that if an H-free
n
1
graph contains almost 1 − χ(H)−1
2 edges, then it must be very close to being (χ(H) − 1)-partite.
Conjecture 1.3. Let H be a graph with χ(H) ≥ 3 and let
m2 (H) =

eK − 1
.
K⊂H,vK ≥3 vK − 2
max

Then, for every δ > 0, there exist positive constants ǫ and C such that if G is a random graph on n vertices, where each edge is chosen independently with probability p at least Cn−1/m2 (H) , then, with proba1
− ǫ e(G)
bility tending to 1 as n tends to infinity, every H-free subgraph of G with at least 1 − χ(H)−1
edges may be made (χ(H) − 1)-partite by removing at most δpn2 edges.
Another example where some success has been achieved is Szemer´edi’s theorem [59]. This celebrated theorem states that, for every positive real number δ and every natural number k, there exists
1

The full KLR conjecture was subsequently established by Balogh, Morris and Samotij [1] and by Saxton and Thomason [54] (see also [6]). Their methods also allow one to give alternative proofs for many of the results in this paper. We
refer the reader to [5] for a more complete overview.

3

a positive integer n such that every subset of the set [n] = {1, 2, · · · , n} of size at least δn contains
a k-term arithmetic progression. The particular case where k = 3 had been proved much earlier by
Roth [52], and is accordingly known as Roth’s theorem. A sparse random version of Roth’s theorem
was proved by Kohayakawa, Luczak and R¨
odl [35]. To state the theorem, let us say that a subset
I of the integers is δ-Roth if every subset of I of size δ|I| contains a 3-term arithmetic progression.
We shall also write [n]p for a random set in which each element of [n] is chosen independently with
probability p.
Theorem 1.4. For every δ > 0 there exist positive constants c and C such that
lim P([n]p is δ-Roth) =

n→∞

0, if p < cn−1/2 ,
1, if p > Cn−1/2 .

Once again the 0-statement is trivial (as it tends to be for density theorems): if p = n−1/2 /2, then
the expected number of 3-term progressions in [n]p is less than n1/2 /8, while the expected number of
elements of [n]p is n1/2 /2. Therefore, one can almost always remove an element from each progression
and still be left with at least half the elements of [n]p .
For longer progressions, the situation has been much less satisfactory. Let us deﬁne a set I of
integers to be (δ, k)-Szemer´edi if every subset of I of cardinality at least δ|I| contains a k-term
arithmetic progression. Until recently, hardly anything was known at all about which random sets
were (δ, k)-Szemer´edi. However, that changed with the seminal paper of Green and Tao [24], who,
on the way to proving that the primes contain arbitrarily long arithmetic progressions, showed that
every pseudorandom set is (δ, k)-Szemer´edi, if “pseudorandom” is deﬁned in an appropriate way. Their
deﬁnition of pseudorandomness is somewhat complicated, but it is straightforward to show that quite
sparse random sets are pseudorandom in their sense. From this the following result follows, though
we are not sure whether it has appeared explicitly in print.
Theorem 1.5. For every δ > 0 and every k ∈ N there exists a function p = p(n) tending to zero with
n such that
lim P([n]p is (δ, k)-Szemer´edi) = 1.
n→∞

The approach of Green and Tao depends heavily on the use of a set of norms known as uniformity
norms, introduced in [19]. In order to deal with k-term arithmetic progressions, one must use a
uniformity norm that is based on a count of certain conﬁgurations that can be thought of as (k − 1)dimensional parallelepipeds. These conﬁgurations have k degrees of freedom (one for each dimension
and one because the parallelepipeds can be translated) and size 2k−1 . A simple argument (similar to
the arguments for the 0-statements in the density theorems above) shows that the best bound that
k−1
one can hope to obtain by their methods is therefore at most p = n−k/2 . This is far larger than
the bound that arises in the obvious 0-statement for Szemer´edi’s theorem: the same argument that
gives a bound of cn−1/2 for the Roth property gives a bound of cn−1/(k−1) for the Szemer´edi property.
k−1
is not the bound that they actually obtain, because they need in addition
However, even p = n−k/2
a “correlation condition” that is not guaranteed by the smallness of the uniformity norm. This means
that the bound they obtain is of the form n−o(1) .
The natural conjecture is that the obvious bound for the 0-statement is in fact correct, so it is far
stronger than the bound of Green and Tao.

4

Conjecture 1.6. For every δ > 0 and every positive integer k ≥ 3, there exist positive constants c
and C such that
0, if p < cn−1/(k−1) ,
lim P([n]p is (δ, k)-Szemer´edi) =
n→∞
1, if p > Cn−1/(k−1) .
One approach to proving Szemer´edi’s theorem is known as the hypergraph removal lemma. Proved
independently by Nagle, R¨
odl, Schacht and Skokan [40, 51] and by the second author [21] (see also [61]),
this theorem states that for every δ > 0 and every positive integer k ≥ 2 there exists a constant ǫ > 0
such that if G is a k-uniform hypergraph containing at most ǫnk+1 copies of the complete k-uniform
(k)
(k)
hypergraph Kk+1 on k + 1 vertices, then it may be made Kk+1 -free by removing at most δnk edges.
Once this theorem is known, Szemer´edi’s theorem follows as an easy consequence. The question of
whether an analogous result holds within random hypergraphs was posed by Luczak [38]. For k = 2,
this follows from the work of Kohayakawa, Luczak and R¨
odl [35].
Conjecture 1.7. For every δ > 0 and every integer k ≥ 2 there exist constants ǫ > 0 and C such that,
if H is a random k-uniform hypergraph on n vertices where each edge is chosen independently with
probability p at least Cn−1/k , then, with probability tending to 1 as n tends to infinity, every subgraph
(k)
of H containing at most ǫpk+1 nk+1 copies of the complete k-uniform hypergraph Kk+1 on k +1 vertices
(k)

may be made Kk+1 -free by removing at most δpnk edges.

1.1

The main results of this paper

In the next few sections we shall give a very general method for proving sparse random versions of
combinatorial theorems. This method allows one to obtain sharp bounds for several theorems, of
which the principal (but by no means only) examples are positive answers to the conjectures we have
just mentioned. This statement comes with one caveat. When dealing with graphs and hypergraphs,
we shall restrict our attention to those which are well-balanced in the following sense. Note that most
graphs of interest, including complete graphs and cycles, satisfy this condition.
Definition 1.8. A k-uniform hypergraph K is said to be strictly k-balanced if, for every subgraph L
of K,
eL − 1
eK − 1
>
.
vK − k
vL − k
The main results we shall prove in this paper (in the order in which we discussed them above, but
not the order in which we shall prove them) are as follows. The ﬁrst is a sparse random version of
Ramsey’s theorem. Of course, as we have already mentioned, this is known: however, our theorem
applies not just to graphs but to hypergraphs, where the problem was wide open apart from a few
special cases [49, 50]. As we shall see, our methods apply just as easily to hypergraphs as they do
(k)
to graphs. We write Gn,p for a random k-uniform hypergraph on n vertices, where each hyperedge
is chosen independently with probability p. If K is some ﬁxed k-uniform hypergraph, we say that a
hypergraph is (K, r)-Ramsey if every r-colouring of its edges contains a monochromatic copy of K.
Theorem 1.9. Given a natural number r and a strictly k-balanced k-uniform hypergraph K, there
exists a positive constant C such that
−1/mk (K)
lim P(G(k)
,
n,p is (K, r)-Ramsey) = 1, if p > Cn

n→∞

where mk (K) = (eK − 1)/(vK − k).
5

One problem that the results of this paper leave open is to establish a corresponding 0-statement
for Theorem 1.9. The above bound is the threshold below which the number of copies of K becomes
less than the number of hyperedges, so the results for graphs make it highly plausible that the 0statement holds when p < cn−1/mk (K) for small enough c. However, the example of stars, for which
the threshold is lower than expected, shows that we cannot take this result for granted.
We shall also prove Conjecture 1.2 for strictly 2-balanced graphs. In particular, it holds for complete
graphs.
Theorem 1.10. Given ǫ > 0 and a strictly 2-balanced graph H, there exists a positive constant C
such that
lim P(Gn,p is (H, ǫ)-Tur´
an) = 1, if p > Cn−1/m2 (H) ,
n→∞

where m2 (H) = (eH − 1)/(vH − 2).
A slightly more careful application of our methods also allows us to prove its structural counterpart,
Conjecture 1.3, for strictly 2-balanced graphs.
Theorem 1.11. Given a strictly 2-balanced graph H with χ(H) ≥ 3 and a constant δ > 0, there exist
positive constants C and ǫ such that in the random graph Gn,p chosen with probability p ≥ Cn−1/m2 (H) ,
where m2 (H) = (eH −1)/(vH −2), the following holds with probability tending to 1 as n tends to infinity.
1
− ǫ e(G) edges may be made (χ(H) − 1)Every H-free subgraph of Gn,p with at least 1 − χ(H)−1
partite by removing at most δpn2 edges.
We also prove Conjecture 1.6, obtaining bounds for the Szemer´edi property that are essentially
best possible.
Theorem 1.12. Given δ > 0 and a natural number k ≥ 3, there exists a constant C such that
lim P([n]p is (δ, k)-Szemer´edi) = 1, if p > Cn−1/(k−1) .

n→∞

Our ﬁnal main result is a proof of Conjecture 1.7, the sparse hypergraph removal lemma. As we
have mentioned, the dense hypergraph removal lemma implies Szemer´edi’s theorem, but it turns out
that the sparse hypergraph removal lemma does not imply Theorem 1.12. The diﬃculty is this. When
we prove Szemer´edi’s theorem using the removal lemma, we ﬁrst pass to a hypergraph to which the
removal lemma can be applied. Unfortunately, in the sparse case, passing from the sparse random set
to the corresponding hypergraph gives us a sparse hypergraph with dependencies between its edges,
whereas in the sparse hypergraph removal lemma we assume that the edges of the sparse random
hypergraph are independent. While it is likely that this problem can be overcome, we did not, in the
light of Theorem 1.12, see a strong reason for doing so.
In addition to these main results, we shall discuss other density theorems, such as Tur´
an’s theorem
for hypergraphs (where, even though the correct bounds are not known in the dense case, we can
obtain the threshold at which the bounds in the sparse random case will be the same), the multidimensional Szemer´edi theorem of Furstenberg and Katznelson [15] and the Bergelson-Leibman theorem
[2] concerning polynomial conﬁgurations in dense sets. In the colouring case, we shall discuss Schur’s
theorem [56] as a further example. Note that many similar results have also been obtained by a
diﬀerent method by Schacht [55] and by Friedgut, R¨
odl and Schacht [12].
6

1.2

A preliminary description of the argument

The basic idea behind our proof is to use a transference principle to deduce sparse random versions
of density and colouring results from their dense counterparts. To oversimplify slightly, a transference
principle in this context is a statement along the following lines. Let X be a structure such as the
complete graph Kn or the set {1, 2, . . . , n}, and let U be a sparse random subset of X. Then, for every
subset A ⊂ U , there is a subset B ⊂ X that has similar properties to A. In particular, the density of
B is approximately the same as the relative density of A in U , and the number of substructures of a
given kind in A is an appropriate multiple of the number of substructures of the same kind in B.
Given a strong enough principle of this kind, one can prove a sparse random version of Szemer´edi’s
theorem, say, as follows. Let A be a subset of [n]p of relative density δ. Then there exists a subset
B of [n] of size approximately δn such that the number of k-term progressions in B is approximately
p−k times the number of k-term progressions in A. From Szemer´edi’s theorem it can be deduced that
the number of k-term progressions in B is at least c(δ)n2 , so the number of k-term progressions in A
is at least c(δ)pk n2 /2. Since the size of A is about pn, we have roughly pn degenerate progressions.
Hence, there are non-degenerate progressions within A as long as pk n2 is signiﬁcantly larger than pn,
that is, as long as p is at least Cn−1/(k−1) for some large C.
It is very important to the success of the above argument that a dense subset of [n] should contain
not just one progression but several, where “several” means a number that is within a constant of the
trivial upper bound of n2 . The other combinatorial theorems discussed above have similarly “robust”
versions and again these are essential to us. Very roughly, our general theorems say that a typical
combinatorial theorem that is robust in this sense will have a sparse random version with an upper
bound for the probability threshold that is very close to a natural lower bound that is trivial for
density theorems and often true, even if no longer trivial, for Ramsey theorems.
It is also very helpful to have a certain degree of homogeneity. For instance, in order to prove
the sparse version of Szemer´edi’s theorem we use the fact that it is equivalent to the sparse version
of Szemer´edi’s theorem in Zn , where we have the nice property that for every k and every j with
1 ≤ j ≤ k, every element x appears in the jth place of a k-term arithmetic progression in exactly
n ways (or n − 1 if you discount the degenerate progression with common diﬀerence 0). It will also
be convenient to assume that n is prime, since in this case we know that for every pair of points x, y
in Zn there is exactly one arithmetic progression of length k that starts with x and ends in y. This
simple homogeneity property will prove useful when we come to do our probabilistic estimates.
The idea of using a transference principle to obtain sparse random versions of robust combinatorial
statements is not what is new about this paper. In fact, this was exactly the strategy of Green and
Tao in their paper on the primes, and could be said to be the main idea behind their proof (though of
course it took many further ideas to get it to work). Since it is diﬃcult to say what is new about our
argument without going into slightly more detail, we postpone further discussion for now. However,
there are three further main ideas involved and we shall highlight them as they appear.
In the next few sections, we shall ﬁnd a very general set of criteria under which one may transfer
combinatorial statements to the sparse random setting. In Sections 5-8, we shall show how to prove
that these criteria hold. Section 9 is a brief summary of the general results, both conditional and
unconditional, that have been proved up to that point. In Section 10, we show how these results may
be applied to prove the various theorems promised in the introduction. In Section 11, we conclude by
brieﬂy mentioning some questions that are still open.

7

1.3

Notation

We ﬁnish this section with some notation and terminology that we shall need throughout the course
of the paper. By a measure on a ﬁnite set X we shall mean a non-negative function from X to R.
Usually our measures will have average value 1, or very close to 1. The characteristic measure µ of a
subset U of X will be the function deﬁned by µ(x) = |X|/|U | if x ∈ U and µ(x) = 0 otherwise.
Often our set U will be a random subset of X with each element of X chosen with probability
p, the choices being independent. In this case, we shall use the shorthand U = Xp , just as we wrote
[n]p for a random subset of [n] in the statement of the sparse random version of Szemer´edi’s theorem
earlier. When U = Xp it is more convenient to consider the measure µ that is equal to p−1 times the
characteristic function of U . That is, µ(x) = p−1 if x ∈ U and 0 otherwise. To avoid confusion, we
shall call this the associated measure of U . Strictly speaking, we should not say this, since it depends
not just on U but on the value of p used when U was chosen, but this will always be clear from the
context so we shall not bother to call it the associated measure of (U, p).
For an arbitrary function f from X to R we shall write Ex f (x) for |X|−1 x∈X f (x). Note that
if µ is the characteristic measure of a set U , then Ex µ(x) = 1 and Ex µ(x)f (x) = Ex∈U f (x) for any
function f . If U = Xp and µ is the associated measure of U , then we can no longer say this. However,
we can say that the expectation of Ex µ(x) is 1. Also, with very high probability the cardinality of
U is roughly p|X|, so with high probability Ex µ(x) is close to 1. More generally, if |f (x)| ≤ 1 for
every x ∈ X, then with high probability Ex µ(x)f (x) is close to Ex∈U f (x). We also take expectations
over several variables: if it is clear from the context that k variables x1 , . . . , xk range over ﬁnite sets
X1 , . . . , Xk , respectively, then Ex1 ,...,xk will be shorthand for |X1 |−1 . . . |Xk |−1 x1 ∈X1 · · · xk ∈Xk . If
the range of a variable is not clear from the context then we shall specify it.
We deﬁne an inner product for real-valued functions on X by the formula f, g = Ex f (x)g(x),
and we deﬁne the Lp norm by f p = (Ex |f (x)|p )1/p . In particular, f 1 = Ex |f (x)| and f ∞ =
maxx |f (x)|.
Let . be a norm on the space RX . The dual norm . ∗ of . is a norm on the collection of linear
functionals φ acting on RX given by
φ

∗

= sup{| f, φ | : f ≤ 1}.

It follows trivially from this deﬁnition that | f, φ | ≤ f φ ∗ . Almost as trivially, it follows that if
| f, φ | ≤ 1 whenever f ≤ η, then φ ∗ ≤ η −1 , a fact that will be used repeatedly.

2

Transference principles

As we have already mentioned, a central notion in this paper is that of transference. Roughly speaking,
a transference principle is a theorem that states that every function f in one class can be replaced by
a function g in another, more convenient class in such a way that the properties of f and g are similar.
To understand this concept and why it is useful, let us look at the sparse random version of
Szemer´edi’s theorem that we shall prove. Instead of attacking this directly, it is convenient to prove
a functional generalization of it. The statement we shall prove is the following.
Theorem 2.1. For every positive integer k and every δ > 0 there are positive constants c and C with
the following property. Let p ≥ Cn−1/(k−1) , let U be a random subset of Zn where each element is
8

chosen independently with probability p and let µ be the associated measure of U . Then, with probability
tending to 1 as n tends to infinity, every function f such that 0 ≤ f ≤ µ and Ex f (x) ≥ δ satisfies the
inequality
Ex,d f (x)f (x + d) . . . f (x + (k − 1)d) ≥ c.
To understand the normalization, it is a good exercise (and an easy one) to check that with high
probability Ex,d µ(x)µ(x + d) . . . µ(x + (k − 1)d) is close to 1, so that the conclusion of Theorem 2.1 is
stating that Ex,d f (x)f (x + d) . . . f (x + (k − 1)d) is within a constant of its trivial maximum. (If p is
smaller than n−1/(k−1) then this is no longer true: the main contribution to Ex,d µ(x)µ(x + d) . . . µ(x +
(k − 1)d) comes from the degenerate progressions where d = 0.)
Our strategy for proving this theorem is to “transfer” the function f from the sparse set U to Zn
itself and then to deduce the conclusion from the following robust functional version of Szemer´edi’s
theorem, which can be proved by a simple averaging argument due essentially to Varnavides [64].
Theorem 2.2. For every δ > 0 and every positive integer k there is a constant c > 0 such that, for
every positive integer n, every function g : Zn → [0, 1] with Ex g(x) ≥ δ satisfies the inequality
Ex,d g(x)g(x + d) . . . g(x + (k − 1)d) ≥ c.
Note that in this statement we are no longer talking about dense subsets of Zn , but rather about
[0, 1]-valued functions deﬁned on Zn with positive expectation. It will be important in what follows
that any particular theorem we wish to transfer has such an equivalent functional formulation. As we
shall see in Section 4, all of the theorems that we consider do have such formulations.
Returning to transference principles, our aim is to ﬁnd a function g with 0 ≤ g ≤ 1 for which we
can prove that Ex g(x) ≈ Ex f (x) and that
Ex,d g(x)g(x + d) . . . g(x + (k − 1)d) ≈ Ex,d f (x)f (x + d) . . . f (x + (k − 1)d).
We can then argue as follows: if Ex f (x) ≥ δ, then Ex g(x) ≥ δ/2; by Theorem 2.2 it follows that
Ex,d g(x)g(x+d) . . . g(x+(k−1)d) is bounded below by a constant c; and this implies that Ex,d f (x)f (x+
d) . . . f (x + (k − 1)d) ≥ c/2.
In the rest of this section we shall show how the Hahn-Banach theorem can be used to prove general
transference principles. This was ﬁrst demonstrated by the second author in [22], and independently
(in a slightly diﬀerent language) by Reingold, Trevisan, Tulsiani and Vadhan [44], and leads to simpler
proofs than the method used by Green and Tao. The ﬁrst transference principle we shall prove is
particularly appropriate for density theorems: this one was shown in [22] but for convenience we
repeat the proof. Then we shall prove a modiﬁcation of it for use with colouring theorems.
Let us begin by stating the ﬁnite-dimensional Hahn-Banach theorem in its separation version.
Lemma 2.3. Let K be a closed convex set in Rn and let v be a vector that does not belong to K.
Then there is a real number t and a linear functional φ such that φ(v) > t and such that φ(w) ≤ t for
every w ∈ K.
The reason the Hahn-Banach theorem is useful to us is that one often wishes to prove that one
function is a sum of others with certain properties, and often the sets of functions that satisfy those
properties are convex (or can easily be made convex). For instance, we shall want to write a function
f with 0 ≤ f ≤ µ as a sum g + h with 0 ≤ g ≤ 1 and with h small in a certain norm. The following
9

lemma, an almost immediate consequence of Lemma 2.3, tells us what happens when a function cannot
be decomposed in this way. We implicitly use the fact that every linear functional on RY has the form
f → f, φ for some φ.
Lemma 2.4. Let Y be a finite set and let K and L be two subsets of RY that are closed and convex
and that contain 0. Suppose that f ∈
/ K + L. Then there exists a function φ ∈ RY such that f, φ > 1
and such that g, φ ≤ 1 for every g ∈ K and h, φ ≤ 1 for every h ∈ L.
Proof. By Lemma 2.3 there is a function φ and a real number t such that f, φ > t and such that
g + h, φ ≤ t whenever g ∈ K and h ∈ L. Setting h = 0 we deduce that g, φ ≤ t for every g ∈ K,
and setting g = 0 we deduce that h, φ ≤ t for every h ∈ L. Setting g = h = 0 we deduce that t ≥ 0.
✷
Dividing through by t (or by 12 f, φ if t = 0) we see that we may take t to be 1.
Now let us prove our two transference principles, beginning with the density one. In the statement
of the theorem below we write φ+ for the positive part of φ.
Lemma 2.5. Let ǫ and η be positive real numbers, let µ and ν be non-negative functions defined on a
finite set X and let . be a norm on RX . Suppose that µ−ν, φ+ ≤ ǫ whenever φ ∗ ≤ η −1 . Then for
every function f with 0 ≤ f ≤ µ there exists a function g with 0 ≤ g ≤ ν such that (1+ǫ)−1 f −g ≤ η.
Proof. If we cannot approximate (1 + ǫ)−1 f in this way, then we cannot write (1 + ǫ)−1 f as a sum
g + h with 0 ≤ g ≤ ν and h ≤ η. Now the sets K = {g : 0 ≤ g ≤ ν} and L = {h : h ≤ η} are
closed and convex and they both contain 0. It follows from Lemma 2.4, with Y = X, that there is a
function φ with the following three properties.
• (1 + ǫ)−1 f, φ > 1;
• g, φ ≤ 1 whenever 0 ≤ g ≤ ν;
• h, φ ≤ 1 whenever h ≤ η.
From the ﬁrst of these properties we deduce that f, φ > 1 + ǫ. From the second we deduce that
ν, φ+ ≤ 1, since the function g that takes the value ν(x) when φ(x) ≥ 0 and 0 otherwise maximizes
the value of g, φ over all g ∈ K. And from the third property we deduce immediately that φ ∗ ≤ η −1 .
But our hypothesis implies that µ, φ+ ≤ ν, φ+ + ǫ. It therefore follows that
1 + ǫ < f, φ ≤ f, φ+ ≤ µ, φ+ ≤ ν, φ+ + ǫ ≤ 1 + ǫ,
which is a contradiction.

✷

Later we shall apply Lemma 2.5 with µ the associated measure of a sparse random set and ν the
constant measure 1.
The next transference principle is the one that we shall use for obtaining sparse random colouring
theorems. It may seem strange that the condition we obtain on g1 + · · · + gr is merely that it is less
than ν (rather than equal to ν). However, we also show that fi and gi are close in a certain sense,
and in applications that will imply that g1 + · · · + gr is indeed approximately equal to ν (which will
be the constant measure 1). With a bit more eﬀort, one could obtain equality from the Hahn-Banach
method, but this would not make life easier later, since the robust versions of Ramsey theorems hold
just as well when you colour almost everything as they do when you colour everything.
10

Lemma 2.6. Let ǫ and η be positive real numbers, let r be a positive integer, let µ and ν be non-negative
functions defined on a finite set X and let . be a norm on RX . Suppose that µ−ν, (max1≤i≤r φi )+ ≤
ǫ whenever φ1 , . . . , φr are functions with φi ∗ ≤ η −1 for each i. Then for every sequence of r functions
f1 , . . . , fr with fi ≥ 0 for each i and f1 + · · · + fr ≤ µ there exist functions g1 , . . . , gr with gi ≥ 0 for
each i and g1 + · · · + gr ≤ ν such that (1 + ǫ)−1 fi − gi ≤ η for each i.
Proof. Suppose that the result does not hold for the r-tuple (f1 , . . . , fr ). Let K be the closed convex
set of all r-tuples of functions (g1 , . . . , gr ) such that gi ≥ 0 for each i and g1 + · · · + gr ≤ ν, and let L
be the closed convex set of all r-tuples (h1 , . . . , hr ) such that hi ≤ η for each i. Then both K and
L contain 0 and our hypothesis is that (1 + ǫ)−1 (f1 , . . . , fr ) ∈
/ K + L. Therefore, Lemma 2.4, with
Y = X r , gives us an r-tuple of functions (φ1 , . . . , φr ) with the following three properties.
•

r
i=1

(1 + ǫ)−1 fi , φi > 1;

•

r
i=1

gi , φi ≤ 1 whenever gi ≥ 0 for each i and g1 + · · · + gr ≤ ν;

•

r
i=1

hi , φi ≤ 1 whenever hi ≤ η for each i.

The ﬁrst of these conditions implies that ri=1 fi , φi > 1 + ǫ. In the second condition, let us choose
the functions gi as follows. For each x, pick an i such that φi (x) is maximal. If φi (x) ≥ 0, then set gi (x)
to be ν(x), and otherwise set gi (x) = 0. For each j = i, set gj (x) to be zero. Then ri=1 gi (x)φi (x) is
equal to ν(x) maxi φi (x) if this maximum is non-negative, and 0 otherwise. Therefore, ri=1 gi , φi =
ν, (maxi φi )+ . Thus, it follows from the second condition that ν, (maxi φi )+ ≤ 1. Let us write φ
for maxi φi . The third condition implies that φi ∗ ≤ η −1 for each i.
Using this information together with our hypothesis about µ − ν, we ﬁnd that
r

r

fi , φ+ ≤ µ, φ+ ≤ ν, φ+ + ǫ ≤ 1 + ǫ,

fi , φi ≤

1+ǫ<
i=1

i=1

a contradiction.

3

✷

The counting lemma

We now come to the second main idea of the paper, and perhaps the main new idea. Lemmas 2.5
and 2.6 will be very useful to us, but as they stand they are rather abstract: in order to make use
of them we need to ﬁnd a norm . such that if f − g is small then f and g behave similarly in a
relevant way. Several norms have been devised for exactly this purpose, such as the uniformity norms
mentioned earlier, and also “box norms” for multidimensional structures and “octahedral norms” for
graphs and hypergraphs. It might therefore seem natural to try to apply Lemmas 2.5 and 2.6 to these
norms. However, as we have already commented in the case of uniformity norms, if we do this then we
cannot obtain sharp bounds: except in a few cases, these norms are related to counts of conﬁgurations
that are too large to appear non-degenerately in very sparse random sets.
We are therefore forced to adopt a diﬀerent approach. Instead of trying to use an oﬀ-the-shelf
norm, we use a bespoke norm, designed to ﬁt perfectly the problem at hand. Notice that Lemmas
2.5 and 2.6 become harder to apply as the norm . gets bigger, since then the dual norm . ∗ gets
smaller and there are more functions φ with φ ∗ ≤ η −1 , and therefore more functions of the form
11

φ+ for which one must show that µ − ν, φ+ ≤ ǫ (and similarly for (max1≤i≤r φi )+ with colouring
problems). Therefore, we shall try to make our norm as small as possible, subject to the condition we
need it to satisfy: that f and g behave similarly if f − g is small.
Thus, our norm will be deﬁned by means of a universal construction. As with other universal
constructions, this makes the norm easy to deﬁne but hard to understand concretely. However, we can
get away with surprisingly little understanding of its detailed behaviour, as will become clear later.
An advantage of this abstract approach is that it has very little dependence on the particular problem
that is being studied: it is for that reason that we have ended up with a very general result.
Before we deﬁne the norm, let us describe the general set-up that we shall analyse. We shall begin
with a ﬁnite set X and a collection S of ordered subsets of X, each of size k. Thus, any element s ∈ S
may be expressed in the form s = (s1 , . . . , sk ).
Here are two examples. When we apply our results to Szemer´edi’s theorem, we shall take X to be
Zn , and S to be the set of ordered k-tuples of the form (x, x+d, . . . , x+(k−1)d), and when we apply it to
Ramsey’s theorem or Tur´
an’s theorem for K4 , we shall take X to be the edge set of the complete graph
Kn and S to be the set of ordered sextuples of pairs of the form (x1 x2 , x1 x3 , x1 x4 , x2 x3 , x2 x4 , x3 x4 ),
where x1 , x2 , x3 and x4 are vertices of Kn . Depending on the particular circumstance, we shall
choose whether to include or ignore degenerate conﬁgurations. For example, for Szemer´edi’s theorem,
it is convenient to include the possibility that d = 0, but for theorems involving K4 , we restrict to
conﬁgurations where x1 , x2 , x3 and x4 are all distinct. In practice, it makes little diﬀerence, since the
number of degenerate conﬁgurations is never very large.
In both these two examples, the collection S of ordered subsets of X has some nice homogeneity
properties, which we shall assume for our general result because it makes the proofs cleaner, even if
one sometimes has to work a little to show that these properties may be assumed.
Definition 3.1. Let S be a collection of ordered k-tuples s = (s1 , . . . , sk ) of elements of a finite set X,
and let us write Sj (x) for the set of all s in S such that sj = x. We shall say that S is homogeneous
if for each j the sets Sj (x) all have the same size.
We shall assume throughout that our sets of ordered k-tuples are homogeneous in this sense. Note
that this assumption does not hold for arithmetic progressions of length k if we work in the set [n]
rather than the set Zn . However, sparse random Szemer´edi for Zn implies sparse random Szemer´edi
for [n], so this does not bother us. Similar observations can be used to convert several other problems
into equivalent ones for which the set S is homogeneous. Moreover, such observations will easily
accommodate any further homogeneity assumptions that we have to introduce in later sections.
The functional version of a combinatorial theorem about the ordered sets in S will involve expressions such as
Es∈S f (s1 ) . . . f (sk ).
Thus, what we wish to do is deﬁne a norm . with the property that
Es∈S f (s1 ) . . . f (sk ) − Es∈S g(s1 ) . . . g(sk )
can be bounded above in terms of f − g whenever 0 ≤ f ≤ µ and 0 ≤ g ≤ ν. This is what we mean
by saying that f and g should behave similarly when f − g is small.

12

The feature of the problem that gives us a simple and natural norm is the k-linearity of the
expression Es∈S f (s1 ) . . . f (sk ), which allows us to write the above diﬀerence as
k

Es∈S g(s1 ) . . . g(sj−1 )(f − g)(sj )f (sj+1 ) . . . f (sk ).
j=1

Because we are assuming that the sets Sj (x) all have the same size, we can write any expression of
the form Es∈S h1 (s1 ) . . . hk (sk ) as
Ex∈X hj (x)Es∈Sj (x) h1 (s1 ) . . . hj−1 (sj−1 )hj+1 (sj+1 ) . . . hk (sk ).
It will be very convenient to introduce some terminology and notation for expressions of the kind that
are beginning to appear.
Definition 3.2. Let X be a finite set and let S be a homogeneous collection of ordered subsets of X,
each of size k. Then, given k functions h1 , . . . , hk from X to R, their jth convolution is defined to be
the function
∗j (h1 , . . . , hk )(x) = Es∈Sj (x) h1 (s1 ) . . . hj−1 (sj−1 )hj+1 (sj+1 ) . . . hk (sk ).
We call this a convolution because in the special case where S is the set of arithmetic progressions
of length 3 in ZN , we obtain convolutions in the conventional sense. Using this notation and the
observation made above, we can rewrite
Es∈S g(s1 ) . . . g(sj−1 )(f − g)(sj )f (sj+1 ) . . . f (sk )
as f − g, ∗j (g . . . , g, f, . . . , f ) (where it is understood that there are j − 1 occurrences of g and k − j
occurrences of f ), and from that we obtain the identity
k

f − g, ∗j (g . . . , g, f, . . . , f ) .

Es∈S f (s1 ) . . . f (sk ) − Es∈S g(s1 ) . . . g(sk ) =
j=1

This, together with the triangle inequality, gives us the following lemma.
Lemma 3.3. Let X be a finite set and let S be a homogeneous collection of ordered subsets of X, each
of size k. Let f and g be two functions defined on X. Then
k

| f − g, ∗j (g, . . . , g, f, . . . , f ) |.

|Es∈S f (s1 ) . . . f (sk ) − Es∈S g(s1 ) . . . g(sk )| ≤
j=1

It follows that if f − g has small inner product with all functions of the form ∗j (g . . . , g, f, . . . , f ),
then Es∈S f (s1 ) . . . f (sk ) and Es∈S g(s1 ) . . . g(sk ) are close. It is tempting, therefore, to deﬁne a norm .
by taking h to be the maximum value of | h, φ | over all functions φ of the form ∗j (g, . . . , g, f, . . . , f )
for which 0 ≤ g ≤ ν and 0 ≤ f ≤ µ. If we did that, then we would know that |Es∈S f (s1 ) . . . f (sk ) −
Es∈S g(s1 ) . . . g(sk )| was small whenever f − g was small, which is exactly the property we need our
norm to have. Unfortunately, this deﬁnition leads to diﬃculties. To see why we need to look in more
detail at the convolutions.
13

Any convolution ∗j (g, . . . , g, f, . . . , f ) is bounded above by ∗j (ν, . . . , ν, µ, . . . , µ). For the sake of
example, let us consider the case of Szemer´edi’s theorem. Taking ν = 1, we see that the jth convolution
is bounded above by the function
Pj (x) = Ed µ(x + d) . . . µ(x + (k − j)d).
Up to normalization, this counts the number of progressions of length k − j + 1 beginning at x. If
j > 1, probabilistic estimates imply that, at the critical probability p = Cn−1/(k−1) , Pj is, with
high probability, L∞ -bounded (that is, the largest value of the function is bounded by some absolute
constant). However, functions of the form ∗1 (f, . . . , f ) with 0 ≤ f ≤ µ are almost always unbounded.
This makes it much more diﬃcult to control their inner products with µ − 1, and we need to do that
if we wish to apply the abstract transference principle from the previous section.
For graphs, a similar problem arises. The jth convolution will count, up to normalization, the
number of copies of some subgraph of the given graph H that are rooted on a particular edge. If we
assume that the graph is balanced, as we are doing, then, at probability p = Cn−1/m2 (H) , this count
will be L∞ -bounded for any proper subgraph of H. However, for H itself, we do not have this luxury
and the function ∗1 (f, . . . , f ) is again likely to be unbounded.
If we were prepared to increase the density of the random set by a polylogarithmic factor, we could
ensure that even ∗1 (f, . . . , f ) was bounded and this problem would go away. Thus, a signiﬁcant part of
the complication of this paper is due to our wish to get a bound that is best possible up to a constant.
There are two natural ways of getting around the diﬃculty if we are not prepared to sacriﬁce a
polylogarithmic factor. One is to try to exploit the fact that although ∗1 (f, . . . , f ) is not bounded,
it typically takes large values very infrequently, so it is “close to bounded” in a certain sense. The
other is to replace ∗1 (f, . . . , f ) by a modiﬁcation of the function that has been truncated at a certain
maximum. It seems likely that both approaches can be made to work: we have found it technically
easier to go for the second. The relevant deﬁnition is as follows.
Definition 3.4. Let X be a finite set and let S be a homogeneous collection of ordered subsets of
X, each of size k. Then, given k non-negative functions h1 , . . . , hk from X to R, their jth capped
convolution ◦j (h1 , . . . , hk ) is defined by
◦j (h1 , . . . , hk )(x) = min{∗j (h1 , . . . , hk )(x), 2}.
Unlike with ordinary convolutions, there is no obvious way of controlling the diﬀerence between
Es∈S f (s1 ) . . . f (sk ) and Es∈S g(s1 ) . . . g(sk ) in terms of the inner product between f − g and suitably
chosen capped convolutions. So instead we shall look at a quantity that is related in a diﬀerent way to
the number of substructures of the required type. Roughly speaking, this quantity counts the number
of substructures, but does not count too many if they start from the same point.
A natural quantity that ﬁts this description is f, ◦1 (f, f, . . . , f ) , and this is indeed closely related
to the quantity we shall actually consider. However, there is an additional complication, which is that
it is very convenient to think of our random set U as a union of m random sets U1 , . . . , Um , and of
a function deﬁned on U as an average m−1 (f1 + · · · + fm ) of functions with fi deﬁned on Ui . More
precisely, we shall take m independent random sets U1 , . . . , Um , each distributed as Xp . (Recall that
Xp stands for a random subset of X where the elements are chosen independently with probability
p.) Writing µ1 , . . . , µm for their associated measures, for each i we shall take a function fi such that
0 ≤ fi ≤ µi . Our assertion will then be about the average f = m−1 (f1 + · · · + fm ). Note that
14

0 ≤ f ≤ µ, where µ = m−1 (µ1 + · · · + µm ), and that every function f with 0 ≤ f ≤ µ can be expressed
as an average of functions fi with 0 ≤ fi ≤ µi . Note also that if U = U1 ∪ · · · ∪ Um then µ is neither
the characteristic measure of U nor the associated measure of U . However, provided p is fairly small,
it is close to both with high probability, and this is all that matters.
Having chosen f in this way, the quantity we shall then look at is
f, m−(k−1)

◦1 (fi2 , . . . , fik ) = Ei1 ,...,ik ∈{1,...,m} fi1 , ◦1 (fi2 , . . . , fik ) .
i2 ,...,ik

In other words, we expand the expression f, ∗1 (f, f, . . . , f ) in terms of f1 , . . . , fm and then do the
capping term by term.
Central to our approach is a “counting lemma”, which is an easy corollary of the following result,
which keeps track of the errors that are introduced by our “capping”. (To understand the statement,
observe that if we replaced the capped convolutions ◦j by their “genuine” counterparts ∗j , then the
two quantities that we are comparing would become equal.) In the next lemma, we assume that a
homogeneous set S of ordered k-tuples has been given.
Lemma 3.5. Let η > 0, let m ≥ 2k3 /η and let µ1 , . . . , µm be non-negative functions defined on X
with µi 1 ≤ 2 for all i. Suppose that ∗1 (µi2 , . . . , µik ) − ◦1 (µi2 , . . . , µik ) 1 ≤ η whenever i2 , . . . , ik
are distinct integers between 1 and m, and also that ∗j (1, 1, . . . , 1, µij+1 , . . . , µik ) is uniformly bounded
above by 2 whenever j ≥ 2 and ij+1 , . . . , ik are distinct. For each i, let fi be a function with 0 ≤ fi ≤ µi ,
let f = Ei fi and let g be a function with 0 ≤ g ≤ 1. Then
Ei1 ,...,ik ∈{1,...,m} fi1 , ◦1 (fi2 , . . . , fik ) − g, ∗1 (g, g, . . . , g)
differs from
k

f − g, Eij+1 ,...,ik ◦j (g, g, . . . , g, fij+1 , . . . , fik )
j=1

by at most 2η.
Proof. Note ﬁrst that
Ei1 ,...,ik fi1 , ◦1 (fi2 , . . . , fik )

= Ei1 ,...,ik fi1 − g, ◦1 (fi2 , . . . , fik ) + Ei2 ,...,ik g, ◦1 (fi2 , . . . , fik )
= Ei2 ,...,ik f − g, ◦1 (fi2 , . . . , fik ) + Ei2 ,...,ik g, ◦1 (fi2 , . . . , fik ) .

Since 0 ≤ ∗1 (fi2 , . . . , fik ) ≤ ∗1 (µi2 , . . . , µik ), our assumption implies that, whenever i2 , . . . , ik are
distinct, ∗1 (fi2 , . . . , fik ) − ◦1 (fi2 , . . . , fik ) 1 ≤ η. In this case, therefore,
0 ≤ g, ∗1 (fi2 , . . . , fik ) − g, ◦1 (fi2 , . . . , fik ) ≤ η.
We also know that g, ∗1 (fi2 , . . . , fik ) = fi2 , ∗2 (g, fi3 , . . . , fik ) and that if i3 , . . . , ik are distinct then
∗2 (g, fi3 , . . . , fik ) = ◦2 (g, fi3 , . . . , fik ). Therefore,
0 ≤ fi2 , ◦2 (g, fi3 , . . . , fik ) − g, ◦1 (fi2 , . . . , fik ) ≤ η.

15

Now the assumption that ∗j (1, 1, . . . , 1, µij+1 , . . . , µik ) is bounded above by 2 whenever j ≥ 2 and
ij+1 , . . . , ik are distinct implies that ◦j (g, g, . . . , g, fij+1 , . . . , fik ) and ∗j (g, g, . . . , g, fij+1 , . . . , fik ) are
equal under these circumstances. From this it is a small exercise to show that
k

fij − g, ◦j (g, g, . . . , g, fij+1 , . . . , fik ) .

fi2 , ◦2 (g, fi3 , . . . , fik ) − g, ◦k (g, g, . . . , g) =
j=2

Therefore, for i2 , . . . , ik distinct,
g, ◦1 (fi2 , . . . , fik ) − g, ◦k (g, g, . . . , g)
diﬀers from

(1)

k

fij − g, ◦j (g, g, . . . , g, fij+1 , . . . , fik )

(2)

j=2

by at most η.
The probability that i1 , . . . , ik are not distinct is at most k2 m−1 ≤ η/4k, and if they are not distinct
then the diﬀerence between (1) and (2) is certainly no more than 4k (since all capped convolutions
take values in [0, 2] and fij 1 ≤ µij 1 ≤ 2). Therefore, taking the expectation over all (i1 , . . . , ik )
(not necessarily distinct) and noting that g, ◦k (g, g, . . . , g) = g, ∗1 (g, g, . . . , g) , we ﬁnd that
Ei1 ,...,ik fi1 , ◦1 (fi2 , . . . , fik ) − g, ∗1 (g, g, . . . , g)
diﬀers from

k

f − g, Eij+1 ,...,ik ◦j (g, g, . . . , g, fij+1 , . . . , fik )
j=1

by at most 2η, as claimed.

✷

To state our counting lemma, we need to deﬁne the norm that we shall actually use.
Definition 3.6. Let X be a finite set and let S be a homogeneous collection of ordered subsets of X,
each of size k. Let µ = (µ1 , . . . , µm ) be a sequence of measures on X. A (µ, 1)-basic anti-uniform
function is a function of the form ◦j (g, . . . , g, fij+1 , . . . , fik ), where 1 ≤ j ≤ k, ij+1 , . . . , ik are distinct,
0 ≤ g ≤ 1 and 0 ≤ fih ≤ µih for every h between j + 1 and k. Let Φµ,1 be the set of all (µ, 1)-basic
anti-uniform functions and define the norm . µ,1 by taking h µ,1 to be max{| h, φ | : φ ∈ Φµ,1 }.
The phrase “basic anti-uniform function” is borrowed from Green and Tao, since our basic antiuniform functions are closely related to functions of the same name that appear in their paper [24].
Our counting lemma is now as follows. It says that if f − g µ,1 is small, then the “sparse”
expression given by Ei1 ,...,ik ∈{1,...,m} fi1 , ◦1 (fi2 , . . . , fik ) is approximated by the “dense” expression
g, ∗1 (g, g, . . . , g) . This lemma modiﬁes Lemma 3.3 in two ways: it splits f up into m−1 (f1 + · · · + fm )
and it caps all the convolutions that appear when one expands out the expression f, ∗1 (f, . . . , f ) in
terms of the fi .
Corollary 3.7. Suppose that the assumptions of Lemma 3.5 hold, and that | f − g, φ | ≤ η/k for every
basic anti-uniform function φ ∈ Φµ,1 . Then Ex g(x) ≥ Ex f (x) − η/k, and
Ei1 ,...,ik ∈{1,...,m} fi1 , ◦1 (fi2 , . . . , fik ) − g, ∗1 (g, g, . . . , g)
16

≤ 4η.

Proof. The function ◦k (1, 1, . . . , 1) is a basic anti-uniform function, and it takes the constant value 1.
Since Ex h(x) = h, 1 for any function h, this implies the ﬁrst assertion.
Now the probability that i1 , . . . , ik are distinct is again at most η/4k, and if they are not distinct
we at least know that | f − g, ◦j (g, g, . . . , g, fij+1 , . . . , fik ) | ≤ 4. Therefore, our hypothesis also implies
that
k

| f − g, Eij+1 ,...,ik ◦j (g, g, . . . , g, fij+1 , . . . , fik ) | ≤ k(η/k) + 4k(η/4k) = 2η.
j=1

Combining this with Lemma 3.5, we obtain the result.

✷

In order to prove analogues of structural results such as the Erd˝os-Simonovits stability theorem
and the hypergraph removal lemma we shall need to preserve slightly more information when we
replace our sparsely supported function f by a densely supported function g. For example, to prove
the stability theorem, we proceed as follows. Given a subgraph A of the random graph Gn,p , we create
a weighted subgraph B of Kn that contains the same number of copies of H, up to normalization.
However, to make the proof work, we also need the edge density of B within any large vertex set
to correspond to the edge density of A within that set. Suppose that we have this property as well
and that A is H-free. Then B has very few copies of H. A robust version of the stability theorem
then tells us that B may be made (χ(H) − 1)-partite by removing a small number of edges (or rather
a small weight of weighted edges). Let us look at the resulting weighted graph B ′ . It consists of
χ(H) − 1 vertex sets, all of which have zero weight inside. Therefore, in B, each of these sets had
only a small weight to begin with. Since all “local densities” of A reﬂect those of B, these vertex sets
contain only a very small proportion of the edges in A as well. Removing these edges makes A into a
(χ(H) − 1)-partite graph and we are done.
How do we ensure that local densities are preserved? All we have to do is enrich our set of basic
anti-uniform functions by adding an appropriate set of functions that will allow us to transfer local
densities from the sparse structure to the dense one. For example, in the case above we need to
know that A and B have roughly the same inner product (when appropriately weighted) with the
characteristic function of the complete graph on any large set V of vertices. We therefore add these
characteristic functions to our stock of basic anti-uniform functions. For other applications, we need to
maintain more intricate local density conditions. However, as we shall see, as long as the corresponding
set of additional functions is suﬃciently small, this does not pose a problem.

4

A conditional proof of the main theorems

In this section, we shall collect together the results of Sections 2 and 3 in order to make clear what is
left to prove. We start with a simple and general lemma about duality in normed spaces.
Lemma 4.1. Let Φ be a bounded set of real-valued functions defined on a finite set X such that the
linear span of Φ is RX . Let a norm on RX be defined by f = max{| f, φ | : φ ∈ Φ}. Let . ∗ be the
dual norm. Then ψ ∗ ≤ 1 if and only if ψ belongs to the closed convex hull of Φ ∪ (−Φ).
Proof. If ψ = i λi φi with φi ∈ Φ ∪ (−Φ), λi ≥ 0 for each i and i λi = 1, and if f ≤ 1, then
| f, ψ | ≤ i λi | f, φi | ≤ 1. The same is then true if ψ belongs to the closure of the convex hull of
Φ ∪ (−Φ).
17

If ψ does not belong to this closed convex hull, then by the Hahn-Banach theorem there must be
a function f such that | f, φ | ≤ 1 for every φ ∈ Φ and f, ψ > 1. The ﬁrst condition tells us that
f ≤ 1, so the second implies that ψ ∗ > 1.
✷
So we already know a great deal about functions φ with bounded dual norm. Recall, however,
that we must consider positive parts of such functions: we would like to show that µ − ν, φ+ is small
whenever φ ∗ is of reasonable size. We need the following extra lemma to gain some control over
these.
Lemma 4.2. Let Ψ be a set of functions that take values in [−2, 2] and let ǫ > 0. Then there exist
constants d and M , depending on ǫ only, such that for every function ψ in the convex hull of Ψ, there
is a function ω that belongs to M times the convex hull of all products ±φ1 . . . φj with j ≤ d and
φ1 , . . . , φj ∈ Ψ, such that ψ+ − ω ∞ < ǫ.
Proof. We start with the well-known fact that continuous functions on closed bounded intervals can
be uniformly approximated by polynomials. Therefore, if K(x) is the function deﬁned on [−2, 2] that
takes the value 0 if x ≤ 0 and x if x ≥ 0, then there is a polynomial P such that |P (x) − K(x)| ≤ ǫ for
every x ∈ [−2, 2]. It follows that if ψ is a function that takes values in [−2, 2], then P (ψ) − ψ+ ∞ ≤ ǫ.
Let us apply this observation in the case where ψ is a convex combination i λi φi of functions
φi ∈ Ψ. If P (t) = dj=1 aj tj , then
d

λi1 . . . λij φi1 . . . φij .

aj

P (ψ) =
j=1

i1 ,...,ij

But i1 ,...,ij λi1 . . . λij = 1 for every j, so this proves that we can take M to be
and the degree d depend on ǫ only, as claimed.

d
j=1 |aj |.

This bound
✷

Similarly, for colouring problems, where we need to deal with the function (max1≤i≤r φi )+ , we have
the following lemma. The proof is very similar to that of Lemma 4.2, though we must replace the
function K(x) that has to be approximated with the function K(x1 , . . . , xr ) = max{0, x1 , . . . , xr } and
apply a multivariate version of the uniform approximation theorem inside the set [−2, 2]r (though the
case we actually need follows easily from the one-dimensional theorem).
Lemma 4.3. Let Ψ be a set of functions that take values in [−2, 2] and let ǫ > 0. Then there exist
constants d and M , depending on ǫ only, such that for every set of functions ψ1 , . . . , ψr in the convex
hull of Ψ, there is a function ω that belongs to M times the convex hull of all products ±φ1 . . . φj with
j ≤ d and φ1 , . . . , φj ∈ Ψ, such that (max1≤i≤r ψi )+ − ω ∞ < ǫ.
We shall split up the rest of the proof of our main result as follows. First, we shall state a set of
assumptions about the set S of ordered subsets of X. Then we shall show how the transference results
we are aiming for follow from these assumptions. Then over the next few sections we shall show how
to prove these assumptions for a large class of sets S.
The reason for doing things this way is twofold. First, it splits the proof into a deterministic part
(the part we do now) and a probabilistic part (verifying the assumptions). Secondly, it splits the
proof into a part that is completely general (again, the part we do now) and a part that depends
more on the speciﬁc set S. Having said that, when it comes to verifying the assumptions, we do not
18

do so for individual sets S. Rather, we identify two broad classes of set S that between them cover
all the problems that have traditionally interested people. This second shift, from the general to the
particular, will not be necessary until Section 7. For now, the argument remains quite general.
Suppose now that µ1 , . . . , µm are measures on a ﬁnite set X and µ = m−1 (µ1 + · · · + µm ). In
subsequent sections, we will take µ1 , . . . , µm to be the associated measures of random sets U1 , . . . , Um ,
each distributed as Xp , but for now we will continue to work deterministically. We shall be particularly
interested in the following four properties that such a sequence of measures may have.
Four key properties.
P0. µi

1

= 1 + o(1) for each i, where o(1) → 0 as |X| → ∞.

P1.

∗1 (µi2 , . . . , µik ) − ◦1 (µi2 , . . . , µik )
m.

P2.

∗j (1, 1, . . . , 1, µij+1 , . . . , µik )
1 and m.

∞

1

≤ η whenever i2 , . . . , ik are distinct integers between 1 and

≤ 2 whenever j ≥ 2 and ij+1 , . . . , ik are distinct integers between

P3. | µ − 1, ξ | < λ whenever ξ is a product of at most d basic anti-uniform functions from Φµ,1 .
In the remainder of this section, we will prove that if µ1 , . . . , µm satisfy these four properties,
then any robust density theorem or colouring theorem also holds relative to the measure µ. To prove
this for density statements, we ﬁrst need a simple lemma showing that any density theorem implies
an equivalent functional formulation. For convenience, we will assume that each set in S consists of
distinct elements from X.
Lemma 4.4. Let k be an integer and ρ, β, ǫ > 0 be real numbers. Let X be a sufficiently large finite
set and let S be a collection of ordered subsets of X, each of size k and with no repeated elements.
Suppose that for every subset B of X of size at least ρ|X| there are at least β|S| elements (s1 , . . . , sk )
of S such that si ∈ B for each i. Let g be a function on X such that 0 ≤ g ≤ 1 and g 1 ≥ ρ + ǫ.
Then
Es∈S g(s1 ) . . . g(sk ) ≥ β − ǫ.
Proof. Let us choose a subset B of X randomly by choosing each x ∈ X with probability g(x), with
the choices independent. The expected number of elements of B is x g(x) ≥ (ρ+ ǫ)|X| and therefore,
by applying standard large deviation inequalities, one may show that if |X| is suﬃciently large the
probability that |B| < ρ|X| is at most ǫ. Therefore, with probability at least 1 − ǫ there are at least
β|S| elements s of S such that si ∈ B for every i. It follows that the expected number of such sequences
is at least β|S|(1 − ǫ) ≥ (β − ǫ)|S|. But each sequence s has probability g(s1 ) . . . g(sk ) of belonging to
B, so the expected number is also s∈S g(s1 ) . . . g(sk ), which proves the lemma.
✷
Note that the converse to the above result is trivial (and does not need an extra ǫ), since if B is a
set of density ρ, then the characteristic function of B has L1 -norm ρ.
We remark here that the condition that no sequence in S should have repeated elements is not a
serious restriction. For one thing, all it typically does is rule out degenerate cases (such as arithmetic
progressions with common diﬀerence zero) that do not interest us. Secondly, these degenerate cases
tend to be suﬃciently infrequent that including them would have only a very small eﬀect on the
constants. The reason we do not allow them is that it makes the proof neater.
19

With Lemma 4.4 in hand, we are now ready to prove that a transference principle holds for density
theorems.
Theorem 4.5. Let k be a positive integer and let ρ, β, ǫ > 0 be real numbers. Let X be a finite
set and let S be a homogeneous collection of ordered subsets of X, each of size k and having no
repeated elements. Suppose that for every subset B of X of size at least ρ|X| there are at least β|S|
elements (s1 , . . . , sk ) of S such that si ∈ B for each i. Then there are positive constants η and λ
and positive integers d and m with the following property. If µ1 , . . . , µm are such that P0, P1, P2
and P3 hold for the constants η, λ and d, µ = m−1 (µ1 + · · · + µm ), and |X| is sufficiently large, then
Es∈S f (s1 ) . . . f (sk ) ≥ β − ǫ for every function f such that 0 ≤ f ≤ µ and Ex f (x) ≥ ρ + ǫ.
Proof. To begin, we apply Lemma 4.4 with 2ǫ to conclude that if |X| is suﬃciently large and g is any
function on X with 0 ≤ g ≤ 1 and g 1 ≥ ρ + 2ǫ , then
ǫ
Es∈S g(s1 ) . . . g(sk ) ≥ β − .
2
For each function h, let h be deﬁned to be the maximum of | h, φ | over all basic anti-uniform
ǫ
. We claim that, given f with 0 ≤ f ≤ µ, there exists a g with
functions φ ∈ Φµ,1 . Let η = 10
ǫ −1
0 ≤ g ≤ 1 such that (1 + 4 ) f − g ≤ η/k. Equivalently, this shows that | (1 + 4ǫ )−1 f − g, φ | ≤ η/k
for every φ ∈ Φµ,1 . We will prove this claim in a moment. However, let us ﬁrst note that it is a
suﬃcient condition to imply that
Es∈S f (s1 ) . . . f (sk ) ≥ β − ǫ
whenever 0 ≤ f ≤ µ and Ex f (x) ≥ ρ+ǫ. Let m = 2k 3 /η and write (1+ 4ǫ )−1 f as m−1 (f1 +· · ·+fm ) with
0 ≤ fi ≤ µi . Corollary 3.7, together with P1 and P2, then implies that Ex g(x) ≥ (1+ 4ǫ )−1 Ex f (x)−η/k
and that
Ei1 ,...,ik ∈{1,...,m} fi1 , ◦1 (fi2 , . . . , fik ) − g, ∗1 (g, g, . . . , g) ≤ 4η.
Since η/k < ǫ/8, (1 + 4ǫ )−1 ≥ 1 −
Ex g(x) ≥ 1 +

ǫ
4

ǫ
4

and 1 + o(1) ≥ Ex f (x) ≥ ρ + ǫ,
−1

Ex f (x) − η/k ≥ ρ + ǫ −

ǫ
ǫ
ǫ
− − o(1) ≥ ρ + ,
4 8
2

for |X| suﬃciently large, so our assumption about g implies that g, ∗1 (g, g, . . . , g) ≥ β − 2ǫ . Since in
addition 8η < ǫ, we can deduce the inequality Ei1 ,...,ik fi1 , ◦1 (fi2 , . . . , fik ) ≥ β − ǫ, which, since the
capped convolution is smaller than the standard convolution, implies that
Es∈S f (s1 ) . . . f (sk ) = f, ∗1 (f, f, . . . , f ) ≥ Ei1 ,...,ik fi1 , ◦1 (fi2 , . . . , fik ) ≥ β − ǫ.
It remains to prove that for any f with 0 ≤ f ≤ µ, there exists a g with 0 ≤ g ≤ 1 such that
(1 + 4ǫ )−1 f − g ≤ η/k. An application of Lemma 2.5 tells us that if µ − 1, ψ+ < 4ǫ for every
function ψ with ψ ∗ ≤ kη −1 , then this will indeed be the case. Now let us try to ﬁnd a suﬃcient
condition for this. First, if ψ ∗ ≤ kη −1 , then Lemma 4.1 implies that ψ is contained in kη −1 times
the convex hull of Φ ∪ {−Φ}, where Φ is the set of all basic anti-uniform functions. Since functions in
Φ ∪ {−Φ} take values in [−2, 2], we can apply Lemma 4.2 to ﬁnd constants d and M and a function
ω that can be written as M times a convex combination of products of at most d functions from
Φ ∪ {−Φ} such that ψ+ − ω ∞ ≤ ǫ/20. Hence, for such an ω,
ǫ
ǫ
< ,
µ − 1, ψ+ − ω ≤ µ − 1 1 ψ+ − ω ∞ ≤ (2 + o(1))
20
8
20

for |X| suﬃciently large. From this it follows that if | µ − 1, ξ | < ǫ/8M whenever ξ is a product of at
most d functions from Φ ∪ {−Φ}, then
µ − 1, ψ+ = µ − 1, ω + µ − 1, ψ+ − ω < ǫ/8 + ǫ/8 = ǫ/4.
Therefore, applying P3 with d and λ = ǫ/8M completes the proof.

✷

To prove a corresponding theorem for colouring problems, we will again need a lemma saying that
colouring theorems always have a functional reformulation.
Lemma 4.6. Let k, r be positive integers and let β > 0 be a real number. Let X be a finite set and
let S be a collection of ordered subsets of X, each of size k and having no repeated elements. Suppose
that for every r-colouring of X there are at least β|S| elements (s1 , . . . , sk ) of S such that each si has
the same colour. Let g1 , . . . , gr be functions from X to [0, 1] such that g1 + · · · + gr = 1. Then
r

gi (s1 ) . . . gi (sk ) ≥ β.

Es∈S
i=1

Proof. Deﬁne a random r-colouring of X as follows. For each x ∈ X, let x have colour i with probability gi (x), and let the colours be chosen independently. By hypothesis, the number of monochromatic
sequences is at least β|S|, regardless of what the colouring is. But the expected number of monochromatic sequences is s∈S ri=1 gi (s1 ) . . . gi (sk ), so the lemma is proved.
✷
We actually need a slightly stronger conclusion than the one we have just obtained. However, if S
is homogeneous then it is an easy matter to strengthen the above result to what we need.
Lemma 4.7. Let k, r be positive integers and let β > 0 be a real number. Let X be a finite set and let
S be a homogeneous collection of ordered subsets of X, each of size k and having no repeated elements.
Suppose that for every r-colouring of X there are at least β|S| elements (s1 , . . . , sk ) of S such that
each si has the same colour. Then there exists δ > 0 with the following property. If g1 , . . . , gr are any
r functions from X to [0, 1] such that g1 (x) + · · · + gr (x) ≥ 1/2 for at least (1 − δ)|X| values of x, then
r

gi (s1 ) . . . gi (sk ) ≥ 2−(k+1) β.

Es∈S
i=1

Proof. Let Y be the set of x such that g1 (x) + · · · + gr (x) < 1/2. Then we can ﬁnd functions h1 , . . . , hr
from X to [0, 1] such that h1 + · · · + hr = 1 and hi (x) ≤ 2gi (x) for every x ∈ X \ Y . By the previous
lemma, we know that
r

hi (s1 ) . . . hi (sk ) ≥ β.

Es∈S
i=1

Let T be the set of sequences s ∈ S such that si ∈ Y for at least one i. Since S is homogeneous, for
each i the set of s such that si ∈ Y has size |S||Y |/|X| ≤ δ|S|. Therefore, |T | ≤ kδ|S|. It follows that
r

r

gi (s1 ) . . . gi (sk ) ≥
s∈S i=1

gi (s1 ) . . . gi (sk )
s∈S\T i=1
r
−k

hi (s1 ) . . . hi (sk ) − |T |

≥ 2

s∈S i=1
−k

≥ (2

21

β − kδ)|S|.

Thus, the lemma is proved if we take δ = 2−(k+1) β/k.

✷

We now prove our main transference principle for colouring theorems. The proof is similar to that
of Theorem 4.5 and reduces to the same conditions, but we include the proof for completeness.
Theorem 4.8. Let k, r be positive integers and β > 0 be a real number. Let X be a finite set and let
S be a homogeneous collection of ordered subsets of X, each of size k and with no repeated elements.
Suppose that for every r-colouring of X there are at least β|S| elements (s1 , . . . , sk ) of S such that each
si has the same colour. Then there are positive constants η and λ and positive integers d and m with
the following property. If µ1 , . . . , µm are such that P0, P1, P2 and P3 hold for the constants η, λ and
d, µ = m−1 (µ1 + · · · + µm ), and |X| is sufficiently large, then Es∈S ri=1 fi (s1 ) . . . fi (sk ) ≥ 2−(k+2) β
for every sequence of functions f1 , . . . , fr such that 0 ≤ fi ≤ µ for each i and ri=1 fi = µ.
Proof. An application of Lemmas 4.6 and 4.7 tells us that there exists δ > 0 with the following
property. If g1 , . . . , gr are any r functions from X to [0, 1] such that g1 (x) + · · · + gr (x) ≥ 1/2 for at
least (1 − δ)|X| values of x, then
r

gi (s1 ) . . . gi (sk ) ≥ 2−(k+1) β.

Es∈S
i=1

Again we deﬁne the norm . by taking h to be the maximum of | h, φ | over all basic anti-uniform
functions φ ∈ Φµ,1 . Let η be such that 8ηr < min(δ, 2−(k+1) β). We claim that, given functions
f1 , . . . , fr with 0 ≤ fi ≤ µ and ri=1 fi = µ, there are functions gi such that 0 ≤ gi ≤ 1, g1 +· · ·+gr ≤ 1
and (1 + 4δ )−1 fi − gi ≤ η/k. Equivalently, this means that | (1 + δ4 )−1 fi − gi , φ | ≤ η/k for every i
and every φ ∈ Φµ,1 . We will return to the proof of this statement. For now, let us show that it implies
r

fi (s1 ) . . . fi (sk ) ≥ 2−(k+2) β.

Es∈S
i=1
δ −1
4 ) fi

as m−1 (fi,1 + · · · + fi,m ) with 0 ≤ fi,j ≤ µj . Corollary 3.7,
Let m =
and write (1 +
together with P1 and P2, then implies that Ex gi (x) ≥ (1 + δ4 )−1 Ex fi (x) − η/k and that
2k3 /η

Ej1 ,...,jk ∈{1,...,m} fi,j1 , ◦1 (fi,j2 , . . . , fi,jk ) − gi , ∗1 (gi , gi , . . . , gi ) ≤ 4η.
Suppose that there were at least δ|X| values of x for which ri=1 gi (x) < 12 . Then this would imply
that
r
δ
1
gi (x) < δ + (1 − δ) ≤ 1 − .
Ex∈X
2
2
i=1

δ −1
4 ) Ex fi (x)

But Ex gi (x) ≥ (1 +
(1 + 4δ )−1 ≥ 1 − δ4 , that

− η/k. Therefore, adding over all i, we have, since η ≤ δ/8r and

r

Ex∈X gi (x) ≥
i=1

1+

δ
4

−1

(1 + o(1)) −

ηr
δ
≥1− ,
k
2

for |X| suﬃciently large, a contradiction. Our assumption about the gi therefore implies the inequality
r
−(k+1) β. Since 8rη < 2−(k+1) β, we can deduce the inequality
i=1 gi , ∗1 (gi , gi , . . . , gi ) ≥ 2
r

Ej1 ,...,jk fi,j1 , ◦1 (fi,j2 , . . . , fi,jk ) ≥ 2−(k+2) β,
i=1

22

which, since the capped convolution is smaller than the standard convolution, implies that
Ej1,...,jk fi,j1 , ◦1 (fi,j2 , . . . , fi,jk ) ≥ 2−(k+2) β.

fi , ∗1 (fi , fi , . . . , fi ) ≥

fi (s1 ) . . . fi (sk ) =
i=1

r

r

r

Es∈S

i=1

i=1

As in Theorem 4.5, we have proved our result conditional upon an assumption, this time that for any
functions f1 , . . . , fr with 0 ≤ fi ≤ µ and ri=1 fi = µ, there are functions gi such that 0 ≤ gi ≤ 1,
g1 + · · · + gr ≤ 1 and (1 + 4δ )−1 fi − gi ≤ η/k. An application of Lemma 2.6 tells us that if
µ − 1, (max1≤i≤r ψi )+ < δ/4 for every collection of functions ψi with ψi ∗ ≤ kη −1 , then this will
indeed be the case. By Lemma 4.1, each ψi is contained in kη −1 times the convex hull of Φ ∪ {−Φ},
where Φ is the set of all basic anti-uniform functions. Since functions in Φ ∪ {−Φ} take values in
[−2, 2], we can apply Lemma 4.3 to ﬁnd constants d and M and a function ω that can be written
as M times a convex combination of products of at most d functions from Φ ∪ {−Φ}, such that
(max1≤i≤r ψi )+ − ω ∞ ≤ δ/20. From this it follows that if |X| is suﬃciently large and | µ − 1, ξ | <
δ/8M whenever ξ is a product of at most d functions from Φ∪{−Φ}, then µ−1, (max1≤i≤r φi )+ < δ/4.
Therefore, applying P3 with d and λ = δ/8M proves the theorem.
✷
Finally, we would like to talk a little about structure theorems. To motivate the result that we
are about to state, let us begin by giving a very brief sketch of how to prove a sparse version of the
triangle removal lemma. (For a precise statement, see Conjecture 1.7 in the introduction, and the
discussion preceding it.)
The dense version of the lemma states that if a dense graph has almost no triangles, then it is
possible to remove a small number of edges in order to make it triangle free. To prove this, one ﬁrst
applies Szemer´edi’s regularity lemma [60] to the graph, and then removes all edges from pairs that
are sparse or irregular. Because sparse pairs contain few edges, and very few pairs are irregular, not
many edges are removed. If a triangle is left in the resulting graph, then each edge of the triangle
belongs to a dense regular pair, and then a simple lemma can be used to show that there must be
many triangles in the graph. Since we are assuming that there are very few triangles in the graph,
this is a contradiction.
The sparse version of the lemma states that essentially the same result holds in a sparse random
graph, given natural interpretations of phrases such as “almost no triangles”. If a random graph with
n vertices has edge probability p, then the expected number of (labelled) triangles is approximately
p3 n3 , and the expected number of (labelled) edges is pn2 . Therefore, the obvious statement to try to
prove, given a random graph G0 with edge probability p, is this: for every δ > 0 there exists ǫ > 0 such
that if G is any subgraph of G0 that contains at most ǫp3 n3 triangles, then it is possible to remove at
most δpn2 edges from G and end up with no triangles.
How might one prove such a statement? The obvious idea is to use the transference methods
explained earlier to ﬁnd a [0, 1]-valued function g deﬁned on pairs of vertices (which we can think of as
a weighted graph) that has similar triangle-containing behaviour to G. For the sake of discussion, let
us suppose that g is in fact the characteristic function of a graph and let us call that graph Γ (later,
in Corollary 9.7, we will show that such a reduction is always possible).
If Γ has similar behaviour to G, then Γ contains very few triangles, which is promising. So we
apply the dense triangle removal lemma in order to get rid of all triangles. But what does that tell
us about G? The edges we removed from Γ did not belong to G. And in any case, how do we use an

23

approximate statement (that G and Γ have similar triangle-containing behaviour) to obtain an exact
conclusion (that G with a few edges removed has no triangles at all)?
The answer is that we removed edges from Γ in “clumps”. That is, we took pairs (U, V ) of vertex
sets (given by cells of the Szemer´edi partition) and removed all edges linking U to V . So the natural
way of removing edges from G is to remove the same clumps that we removed from Γ. After that, the
idea is that if G contains a triangle then it belongs to clumps that were not removed, which means
that Γ must contain a triple of dense regular clumps, and therefore many triangles, which implies that
G must also contain many triangles, a contradiction.
For this to work, it is vital that if a clump contains a very small proportion of the edges of Γ, then
it should also contain a very small proportion of the edges of G. More generally, the density of G in
a set of the form U × V should be about p times the density of Γ in the same set. Thus, we need
a result that allows us to approximate a function by one with a similar triangle count, but we also
need the new function to have similar densities inside every set of the form U × V when U and V are
reasonably large.
In the case of hypergraphs, we need a similar but more complicated statement. The precise nature
of the complexity is, rather surprisingly, not too important: the main point is that we shall need to
approximate a function dominated by a sparse random measure by a bounded function that has a
similar simplex count and similar densities inside all the sets from some set system that is not too
large.
In order to state the result precisely, we make the following deﬁnition.
Definition 4.9. Suppose that we have a finite set X and suppose that Φµ,1 is a collection of basic
anti-uniform functions derived from a collection S of ordered subsets of X and a sequence of measures
µ = (µ1 , . . . , µm ). Then, given a collection of subsets V of X, we define the set of basic anti-uniform
functions Φµ,1 (V) to be Φµ,1 ∪ {χV : V ∈ V}, where χV is the characteristic function of the set V .
We also need to modify the third of the key properties, so as to take account of the set system V.
P3 ′ . | µ−1, ξ | < λ whenever ξ is a product of at most d basic anti-uniform functions from Φµ,1 (V).
Our main abstract result regarding the transfer of structural theorems is the following. It says that
not only do the functions f and g reﬂect one another in the sense that they have similar subset counts,
but they may be chosen to have similar densities inside all the sets V from a collection V. The proof,
which we omit, is essentially the same as that of Theorem 4.5: the only diﬀerence is that the norm is
now deﬁned in terms of Φµ,1 (V), which gives us the extra information that | f, χV − g, χV | ≤ f −g
for every V ∈ V and hence the extra conclusion at the end.
Theorem 4.10. Let k be a positive integer and ǫ > 0 a constant. Let X be a finite set, S a homogeneous collection of ordered subsets of X, each of size k, and V a collection of subsets of X. Then there
are positive constants η and λ and positive integers d and m with the following property. If µ1 , . . . , µm
are such that P0, P1, P2 and P3 ′ hold for the constants η, λ and d, then, for |X| sufficiently large,
the following holds for µ = m−1 (µ1 + · · · + µm ): whenever 0 ≤ f ≤ µ, there exists g with 0 ≤ g ≤ 1
such that
Es∈S f (s1 ) . . . f (sk ) ≥ Es∈S g(s1 ) . . . g(sk ) − ǫ

24

and, for all V ∈ V,
|Ex∈V f (x) − Ex∈V g(x)| ≤ ǫ

|X|
.
|V |

We remark that the second part of the conclusion can be rewritten as
|Ex χV (x)f (x) − Ex χV (x)g(x)| ≤ ǫ,
which is precisely the statement that | f, χV − g, χV | ≤ ǫ.
Note that for P3′ to have a chance of holding, we cannot have too many sets in the collection
V. However, we can easily have enough sets for our purposes. For instance, the collection of pairs of
vertex sets in a graph with n vertices has size 4n ; this is far smaller than the number of graphs on n
vertices, which is exponential in n2 . More generally, an important role in the hypergraph regularity
lemma is played by k-uniform hypergraphs H formed as follows: take a (k − 1)-uniform hypergraph
K and for each set E of size k, put E into H if and only if all its subsets of size k − 1 belong to K.
Since there are far fewer (k − 1)-uniform hypergraphs than there are k-uniform hypergraphs, we have
no trouble applying our result.
Since our ultimate goal is to prove a probabilistic theorem, the task that remains to us is to prove
that certain random sets satisfy P0, P1, P2 and P3 (or P3′ ) with high probability. That this is so for
P0 follows easily from Chernoﬀ’s inequality. It remains to consider P1, P2 and P3.

5

Small correlation with a fixed function

One of our main aims in this paper is to show that, with high probability, | µ − 1, ξ | < λ for every
product ξ of at most d basic anti-uniform functions, when µ is chosen randomly with suitable density.
This is a somewhat complicated statement, since the set of basic anti-uniform functions depends on
our random variable µ. In this section we prove a much easier result, which will nevertheless be
useful to us later on: we shall show that, for any fixed bounded function ξ, | µ − 1, ξ | < λ with high
probability.
To prove this, we shall need a standard probabilistic estimate, Bernstein’s inequality, which allows
one to bound the sum of independent and not necessarily identically distributed random variables.
Lemma 5.1. Let Y1 , Y2 , . . . , Yn be independent random variables. Suppose that each Yi lies in the
interval [0, M ]. Let S = Y1 + Y2 + · · · + Yn . Then
P(|S − E(S)| ≥ t) ≤ 2 exp

−t2
V(Yj ) +

2

Mt
3

.

We are now ready to prove that µ − 1, ξ is bounded with high probability for any ﬁxed bounded
function ξ.
Lemma 5.2. Let X be a finite set and let U = Xp . Let µ be the associated measure of U . Then, for
any constants C and λ with C ≥ λ and any positive function ξ with ξ ∞ ≤ C,
2 p|X|/3C 2

P(| µ − 1, ξ | ≥ λ) ≤ 2e−λ

25

.

Proof. For each x ∈ X, µ(x)ξ(x) is a random variable that takes values in the interval [0, p−1 C]. The
expectation of µ(x)ξ(x) is ξ(x), so the expectation of µ − 1, ξ is 0. Also, the variance of µ(x)ξ(x) is
at most E(µ(x)2 ξ(x)2 ), which is ξ(x)2 p−1 , which is at most C 2 p−1 .
Let S =
x µ(x)ξ(x). Then the probability that | µ − 1, ξ | ≥ λ equals the probability that
|S − ES| ≥ λ|X|. Therefore, by Bernstein’s inequality,
P(| µ − 1, ξ | ≥ λ) ≤ 2 exp
= 2 exp

−(λ|X|)2
2 (C 2 p−1 |X| + Cλp−1 |X|/3)
−λ2 p|X|
2 (C 2 + Cλ/3)

≤ 2 exp −λ2 p|X|/3C 2 ,
where to prove the second inequality we used the assumption that C ≥ λ.

✷

Before we move on to the next section, it will be helpful to state Chernoﬀ’s inequality, the standard
estimate for the tails of the binomial distribution. As we have already noted, P0 is a straightforward
consequence of this lemma.
Lemma 5.3. Let 0 < p ≤ 1 and 0 < δ ≤

1
2

be real numbers and X a finite set. Then

P(||Xp | − p|X|| ≥ δp|X|) ≤ 2e−δ

6

2 p|X|/4

.

The set of basic anti-uniform functions has few extreme points

A slightly inaccurate description of what we are going to do next is that we shall show that if P1
and P2 hold with high probability, then so does P3. In order to understand how and why what we
shall actually do diﬀers from this, it is important to understand the diﬃculty that we now have to
overcome. The result of the previous section tells us that for a random measure µ and any given
function ξ, | µ − 1, ξ | is bounded with high probability. We now need to show that this is the case
for all functions ξ that are products of at most d basic anti-uniform functions. As we have already
commented, this is tricky, because which functions are basic anti-uniform functions depends on µ.
To get a clearer notion of the problem, let us look at a subcase of the general fact that we are trying
to prove, by thinking how we might try to show that, with high probability, µ1 − 1, ◦1 (f2 , . . . , fk )
is small whenever 0 ≤ fi ≤ µi for i = 2, 3, . . . , k. That is, for the time being we shall concentrate on
basic anti-uniform functions themselves rather than on products of such functions.
A question that will obviously be important to us is the following: for how many choices of functions
f2 , . . . , fk do we need to establish that | µ1 − 1, ◦1 (f2 , . . . , fk ) | is small? At ﬁrst glance, the answer
might seem to be inﬁnitely many, but one quickly realizes that a small uniform perturbation to the
functions f2 , . . . , fk does not make much diﬀerence to µ1 − 1, ◦1 (f2 , . . . , fk ) . So it will be enough to
look at some kind of net of the functions.
However, even this observation is not good enough, since the number of functions in a net will
deﬁnitely be at least exponentially large in p|X|. Although the probability we calculated in the
previous section is exponentially small in p|X|, the constant is small, whereas the constant involved
in the size of a net will not be small. So it looks as though there are too many events to consider.

26

It is clear that the only way round this problem is to prove that the set of basic anti-uniform
functions ◦1 (f2 , . . . , fk ) is somehow smaller than expected. And once one thinks about this for a bit,
one realizes that this may well be the case. So far, we have noted that ◦1 (f2 , . . . , fk ) is not much
aﬀected by small uniform perturbations to the functions fi . However, an important theme in additive
combinatorics is that convolutions tend to be robust under a much larger class of perturbations:
roughly speaking, a “quasirandom” perturbation of one of the fi is likely to have little eﬀect on
◦1 (f2 , . . . , fk ).
It is not immediately obvious how to turn this vague idea into a precise one, so for a moment let
us think more abstractly. We have a class Γ of functions, and a function ν, and we would like to
prove that ν, φ is small for every φ ∈ Γ. To do this, we would like to identify a much smaller class
of functions ∆ such that if ν, ψ is small for every ψ ∈ ∆ then ν, φ is small for every φ ∈ Γ. The
following very simple lemma tells us a suﬃcient (and also in fact necessary) condition on ∆ for us to
be able to make this deduction.
Lemma 6.1. Let Γ and ∆ be two closed sets of functions from X to R and suppose that both are
centrally symmetric. Then the following two statements are equivalent:
(i) For every function ν, max{| ν, φ | : φ ∈ Γ} ≤ max{| ν, ψ | : ψ ∈ ∆}.
(ii) Γ is contained in the convex hull of ∆.
Proof. The statement we shall use is just the easy direction of this equivalence, which is that (ii)
implies (i). To see this, let φ ∈ Γ. Then we can write φ as a convex combination i λi ψi of elements
of ∆, and that implies that | ν, φ | ≤ i λi | ν, ψi |. If | ν, ψ | ≤ t for every ψ ∈ ∆, then this is at
most t, which proves (i), since ν and φ were arbitrary.
Now let us suppose that Γ is not contained in the convex hull of ∆, and let φ be an element of Γ
that does not belong to this convex hull. Then the Hahn-Banach theorem and the fact that ∆ is closed
and centrally symmetric guarantee the existence of a function ν such that ν, φ > 1, but | ν, ψ | ≤ 1
for every ψ ∈ ∆, which contradicts (i).
✷
The reason Lemma 6.1 is useful is that it gives us a strategy for proving that | µ − 1, ξ | is small
for all products of at most d basic anti-uniform functions: try to show that these functions belong to
the convex hull of a much smaller set. In fact, this is not quite what we shall do. Rather, we shall
show that every ξ can be approximated by an element of the convex hull of a much smaller set. To
prepare for the more elaborate statement we shall use, we need another easy lemma.
The statement of the lemma is not quite what one might expect. The reason for this is that the
simplest notion of approximation, namely uniform approximation, is too much for us to hope to attain.
Instead, we go for a kind of weighted uniform approximation, where we allow the functions to diﬀer
quite a lot, but only in a few speciﬁed places.
Lemma 6.2. Let H be a non-negative function defined on X such that H 1 ≤ ǫ and H ∞ ≤
R. Let U = Xp and let µ be the associated measure of U . Then, with probability at least 1 −
2 exp(−ǫ2 p|X|/3R2 ), we have the estimate | µ − 1, φ − µ − 1, ψ | ≤ 3ǫ for every pair of functions φ
and ψ such that |φ − ψ| ≤ H.
Proof. The fact that H 1 ≤ ǫ implies that | 1, φ − 1, ψ | ≤ ǫ as well. Also, | µ, φ − ψ | ≤ µ, H .
Therefore, it remains to estimate the probability that µ, H > 2ǫ. Lemma 5.2 with λ = ǫ and C = R
implies that the probability that µ − 1, H > ǫ is at most 2 exp(−ǫ2 p|X|/3R2 ). Therefore, with
probability at least 1 − 2 exp(−ǫ2 p|X|/3R2 ), µ, H ≤ 2ǫ. The result follows.
✷
27

If we use Lemma 6.1 and Lemma 6.2 in combination, then we can show the following result.
Corollary 6.3. Let H be a non-negative function defined on X such that H 1 ≤ ǫ and H ∞ ≤ R.
Let U = Xp and let µ be the associated measure of U . Let Γ and ∆ be two sets of functions and
suppose that for every φ ∈ Γ there exists ψ in the convex hull of ∆ such that |φ − ψ| ≤ H. Then
max{| µ − 1, φ | : φ ∈ Γ} ≤ max{| µ − 1, ψ ′ | : ψ ′ ∈ ∆} + 3ǫ
with probability at least 1 − 2 exp(−ǫ2 p|X|/3R2 ).
Proof. By Lemma 6.2, the probability is at least 1−2 exp(−ǫ2 p|X|/3R2 ) that | µ−1, φ − µ−1, ψ | ≤ 3ǫ
whenever |φ − ψ| ≤ H. By the easy direction of Lemma 6.1, | µ − 1, ψ | ≤ max{| µ − 1, ψ ′ | : ψ ′ ∈ ∆}
for every ψ in the convex hull of ∆. This proves the result.
✷
How do we deﬁne an appropriate set of functions ∆? A simple observation gets us close to the set
we need, but we shall need to make a deﬁnition before we can explain it.
Definition 6.4. Let 0 < q ≤ p ≤ 1, U = Xp and let V = Uq/p . Let µ be the associated measure of
U and let ν be the associated measure of V considered as a set distributed as Xq . Let f be a function
with 0 ≤ f ≤ µ. Then the normalized restriction fν of f to V is the function defined by taking
fν (x) = (p/q)f (x) if x ∈ V and 0 otherwise.
The normalization is chosen to give us the following easy lemma. Note that the expectation below
is a “probabilistic” expectation rather than a mere average over a ﬁnite set.
Lemma 6.5. Let U = Xp be a set with associated measure µ and let V = Uq/p be a random subset of
U with associated measure ν. Then, for any function 0 ≤ f ≤ µ, f = EV fν .
Proof. For each x ∈ U we have
EV fν (x) = (p/q)f (x)P[x ∈ V ] = f (x),
and for each x ∈
/ U we have f (x) = EV fν (x) = 0.

✷

This lemma expresses f as a convex combination of normalized restrictions, which is potentially
useful to us, since if q/p is a small constant, then a typical contribution to this convex combination
comes from a restriction to a set that is quite a lot smaller than U . That will allow us to ﬁnd a small
net for the set of all possible restrictions, whose convex hull can then be used to approximate the set
of all possible functions f with 0 ≤ f ≤ µ.
Furthermore, we can use Lemma 6.5 to write convolutions and products of convolutions as convex
combinations as well, as the next lemma easily implies. The lemma itself is very easy, so we omit the
proof.
Lemma 6.6. For 1 ≤ i ≤ m, let fi be a fixed function and let gi be a random function such that
fi = Egi . Let κ(f1 , . . . , fm ) be a multilinear form in the functions f1 , . . . , fm . Then
κ(f1 , . . . , fm ) = Eκ(g1 , . . . , gm ).

28

The rough idea, and the third main idea of the paper, is to rewrite every product of convolutions
as an average of products of basic anti-uniform functions built out of normalized restrictions. Since
there are “fewer” of these, we will have fewer events that need to hold. We must, however, be careful
when we apply this idea. For a start, we cannot aﬀord to let q become too small. If q is too small,
then, given associated measures ν2 , . . . , νk of sets distributed as Xq , we can no longer guarantee that
the convolutions ∗1 (ν2 , · · · , νk ) are suﬃciently well-behaved for our purposes. Even when we choose
q to be large enough, there will still be certain rogue choices of sets. However, for q suﬃciently large,
we can take care of these rogue sets by averaging and showing that they make a small contribution.
Thus, there is a delicate balance involved: q has to be small enough to give rise to a small class of
functions, but large enough for these functions to have the properties required of them.
Another problem arises from the form of the basic anti-uniform functions. Recall that our starting
point is a collection of (randomly chosen) sets U1 , . . . , Um with associated measures µ1 , . . . , µm . The
basic anti-uniform functions we want to approximate are of the form ◦j (g, . . . , g, fj+1 , . . . , fk ), where
0 ≤ g ≤ 1 and 0 ≤ fh ≤ µih for some sequence (ij+1 , . . . , ik ) of integers between 1 and m. Therefore, we
must approximate capped convolutions of functions some of which are bounded above by 1 and some
of which are bounded above by associated measures of sparse random sets. This creates a diﬃculty
for us. It is still true that if V = Xq is a random set with associated measure ν, then g = EV gν , but
if we exploit that fact directly, then the number of sets V that we have to consider is on the order of
|X|
. Since we will take q/p to be a constant, this is much larger than exp(cp|X|) for any constant c
q|X|
and therefore too large to use in a probabilistic estimate given by a simple union bound. To get round
this problem we shall ﬁnd a much smaller set V such that g = EV ∈V gν .
We shall need the following piece of notation to do this. Suppose that the elements of the set X
are ordered in some arbitrary way as x1 , · · · , xn , say. Then, given a subset V = {xj1 , . . . , xjl } of X
and an integer a between 0 and n − 1, we deﬁne the set V + a to be the set formed by translating
the indices by a. That is, V + a = {xj1 +a , . . . , xjl +a } where the sums are taken modulo n. (This
“translation” operation has no mathematical signiﬁcance: it just turns out to be a convenient way of
deﬁning a small collection of sets.)
Let us write ν + a for the characteristic measure of V + a. Write gν+a for the function given by
|X|
|V | g(x) if x ∈ V + a and 0 otherwise. A proof almost identical to that of Lemma 6.5 implies that
g = Ea gν+a for any function g, and in particular for any function g such that 0 ≤ g ≤ 1. From this and
Lemma 6.5 itself it follows that if (W1 , . . . , Wj−1 ) are any subsets of X, and ωi is the characteristic
measure of Wi , then
∗j (g, . . . , g, fj+1 , . . . , fk ) = Ea1 ,...,aj−1 EVj+1 ,...,Vk ∗j (gω1 +a1 , . . . , gωj−1 +aj−1 , (fj+1 )νj+1 , . . . , (fk )νk ),
where for h > j the set Vh is distributed as (Uih )q/p . There is one practical caveat, in that this
identity holds when ω1 , . . . , ωj−1 are characteristic measures, but it is more natural for us to deal with
associated measures. However, if we assume that W1 , . . . , Wj−1 were chosen with probability q and
|Wi | = (1 + o(1))q|X|, then the distinction vanishes and the identity above holds (up to a o(1) term)
with associated measures rather than characteristic ones.
This observation is encouraging, because it represents the convolution ∗j (g, . . . , g, fj+1 , . . . , fk ) as
an average of convolutions from a small class of functions. However, it certainly does not solve our
problems completely, since we need a statement about capped convolutions. Of course, it would be
very surprising if it did solve our problems, since so far we have not said anything about the size of

29

q and the sets W1 , . . . , Wj−1 . In order to transfer the trivial observation above from convolutions to
capped convolutions, we shall need q to be suﬃciently large and the Wi to be “suﬃciently random”.

6.1

Sufficient randomness

First, let us describe two properties that are closely related to the properties P1 and P2 deﬁned
earlier, and discuss how they are related. The properties will apply to a sequence of measures
ν1 , . . . , νj−1 , νj+1 , . . . , νk and parameters η > 0 and j ≤ k.
Q1.

∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk ) − ◦j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )

Q2.

∗j (1, . . . , 1, νj+1 , . . . , νk )

∞

1

≤ η.

≤ 2.

The main diﬀerence between these new properties and the properties P1 and P2 is that we are not
quantifying over a whole set of sequences. For example, P1 is the property that Q1 holds with j = 1
for every sequence (µi2 , . . . , µik ) taken from a sequence (µ1 , . . . , µm ).
A less obvious diﬀerence is that, while we are ultimately interested in obtaining properties of the
measures µ1 , . . . , µm , we shall deduce these from probabilistic statements about typical sequences of
measures ν1 , . . . , νk chosen binomially with a smaller probability. This will be illustrated by the main
result of this section.
Let us deﬁne what we mean by “suﬃciently random” and then show that what we need can be
obtained if Q1 holds with suﬃciently high probability for suitable η. The next deﬁnition highlights
the property that we want to get out of the suﬃcient randomness: that capped convolutions should
be pretty similar to actual convolutions.
The randomness property we need of our sets Wi is roughly speaking that almost all sequences of
sets that appear in the averages we consider satisfy Q1 for some small η. That will allow us to prove a
statement about capped convolutions, because almost all the convolutions that appear in the average
in the observation above can then be approximated by their capped counterparts. Here is the formal
deﬁnition.
Definition 6.7. Let η > 0 be a real number, let 0 < q ≤ p ≤ 1 and let W1 , . . . , Wj−1 and Zj+1 , . . . , Zk
be subsets of X. We say that W1 , . . . , Wj−1 , Zj+1 , . . . , Zk are suﬃciently random if |Wh | = (1 +
o(1))q|X| for every h < j, |Zh | = (1 + o(1))p|X| for every h > j and, if ω1 , . . . , ωj−1 are the associated
measures of W1 , . . . , Wj−1 defined with weight q −1 , then the following statement holds.
• Let a sequence (a1 , . . . , aj−1 , Vj+1 , . . . , Vk ) be chosen randomly and independently such that ah ∈
Zn for every h < j, Vh = (Zh )q/p for every h > j and, for each h > j, let νh be the associated measure of Vh defined with weight q −1 . Then the probability that the (k − 1)-tuple
(ω1 + a1 , . . . , ωj−1 + aj−1 , νj+1 , . . . , νk ) satisfies Q1 is at least 1 − o(|X|−k ).
Strictly speaking, the deﬁnition of suﬃcient randomness depends on the parameters η, p and q,
but these will be clear from the context.
Our next main lemma says that if Q1 holds with suﬃciently high probability, then the probability
that W1 , . . . , Wj−1 , Zj+1 , . . . , Zk are suﬃciently random, if we choose them independently at random
in a suitable way, is also close to 1.

30

Lemma 6.8. Suppose that if ν1 , . . . , νk are the associated measures of sets V1 , . . . , Vk , each chosen
binomially with probability q ≥ p0 , then property Q1 holds with probability 1 − o(|X|−k ). For 1 ≥ p ≥
q ≥ p0 , let W1 , . . . , Wj−1 be independent random subsets of X with each Wh = Xq , and let Zj+1 , . . . , Zk
be independent random sets with each Zh = Xp . Then the probability that W1 , . . . , Wj−1 , Zj+1 , . . . , Zk
are sufficiently random is 1 − o(1).
Proof. Consider the following way of choosing k − 1 random sets. First we choose W1 , . . . , Wj−1
and Zj+1 , . . . , Zk as in the statement of the lemma. Chernoﬀ’s inequality easily implies that with
probability 1 − o(|X|−k ) we have |Wh | = (1 + o(1))q|X| for all h < j and |Zh | = (1 + o(1))p|X| for all
h > j. Next, we choose a1 , . . . , aj−1 , Vj+1 , . . . , Vk randomly and independently such that ah ∈ Zn for
every h < j and Vh = (Zh )q/p for every h > j. Then the sets W1 + a1 , . . . , Wj−1 + aj−1 , Vj+1 , . . . , Vk
are independent random sets, each distributed as Xq .
Let their associated measures be ω1 + a1 , . . . , ωj−1 + aj−1 , νj+1 , . . . , νk . Then, since q ≥ p0 , our
assumption tells us that this sequence of measures satisﬁes Q1 with probability 1−o(|X|−k ). Therefore,
with probability 1 − o(1), when we choose the Wi and the Zi , the probability that the sequence
ω1 + a1 , . . . , ωj−1 + aj−1 , νj+1 , . . . , νk satisﬁes Q1, conditional on that choice of the Wi and Zi , is at
least 1−o(|X|−k ). Hence, W1 , . . . , Wj−1 , Zj+1 , . . . , Zk are suﬃciently random with probability 1−o(1),
as claimed.
✷
In particular, if Zj+1 , . . . , Zk are binomial random subsets of X, each chosen with probability p,
then, with high probability, there is a choice of sets W1 , . . . , Wj−1 such that W1 , . . . , Wj−1 , Zj+1 , . . . , Zk
are suﬃciently random.

6.2

The proof for basic anti-uniform functions

Suppose that Lq = p ≥ q ≥ p0 for some large constant L. It will be by choosing this constant L
to be large enough that we will make our trick of using normalized restrictions work. Throughout
this section, we will assume that η > 0 is some parameter yet to be speciﬁed, and Zj+1 , . . . , Zk is a
sequence of sets, with associated measures ζj+1 , . . . , ζk deﬁned with weight p−1 , such that
(i) If j = 1, then Q1 holds for the sequence of measures (ζ2 , . . . , ζk ).
(ii) If j > 1, then Q2 holds for the sequence of measures (ζj+1 , . . . , ζk ).
(iii) There exist sets W1 , . . . , Wj−1 such that W1 , . . . , Wj−1 , Zj+1 , . . . , Zk are suﬃciently random (with
parameters j and η).
In the remainder of the section, we will show that if conditions (i), (ii) and (iii) hold (with parameters j and η for suitable η), then the set of basic anti-uniform functions deﬁned using ζj+1 , . . . , ζk has
a small net. To be more precise, we need some deﬁnitions. In what follows, we will write ωh,a for the
associated measure of Wh + a (or, more accurately, the translate by a of the associated measure ωh of
′
for
Wh ), where again these associated measures are deﬁned with weight q −1 . We will also write ωh,a
the characteristic measure of Wh + a.
Definition 6.9. Let Φ(ζj+1 , . . . , ζk ) be the set of functions ◦j (g, . . . , g, fj+1 , . . . , fk ), where 0 ≤ g ≤ 1
and 0 ≤ fh ≤ ζh for each h > j. Let Ψ(ζj+1 , . . . , ζk ) be the set of functions ◦j (f1 , . . . , fj−1 , fj+1 , . . . , fk )
′
for
such that the constituent functions fh have the following properties. If h < j, then 0 ≤ fh ≤ ωh,a
31

some a, and if h > j then 0 ≤ fh ≤ νh , where νh is the associated measure, defined with weight q −1 ,
of some set Vh ∈ (Zh )q/p such that |Vh | ≤ 2q|X|.
We shall now show that every function in Φ(ζj+1 , . . . , ζk ) can be approximated by a convex combination of functions in Ψ(ζj+1 , . . . , ζk ). This will be very useful to us, because Ψ(ζj+1 , . . . , ζk ) is a
much “smaller” set than Φ(ζj+1 , . . . , ζk ). However, we need to be rather careful about precisely what
we mean by “can be approximated by”.
Lemma 6.10. Let L and α < 1 be positive constants. If η is sufficiently small (depending on α) and
|X| is sufficiently large (depending on L and α), then there is a non-negative function H such that
H 1 ≤ α, H ∞ ≤ 2, and, for every function ◦j (g, . . . , g, fj+1 , . . . , fk ) ∈ Φ(ζj+1 , . . . , ζk ), there exists
a function σ in the convex hull of Ψ(ζj+1 , . . . , ζk ) such that
0 ≤ ◦j (g, . . . , g, fj+1 , . . . , fk ) − σ ≤ H.
Proof. Let us choose a random function ψ ∈ Ψ(ζj+1 , . . . , ζk ) as follows. Suppose that W1 , . . . , Wj−1 are
the sets given by condition (iii) and that for each h the associated measure of Wh is ωh (as in the deﬁ′
nition of suﬃcient randomness). We start by choosing a random sequence (ω1′ , . . . , ωj−1
, νj+1 , . . . , νk ).
′
′
Here, each ωh is chosen uniformly at random from the |X| measures ωh,a and each νh is the associated
measure of a set Vh , where the sets Vh are independent and distributed as (Zh )q/p . We then let ψ be
the function
′
, (fj+1 )νj+1 , . . . , (fk )νk )
◦j (gω1′ , . . . , gωj−1
if every Vh has size at most 2q|X|, and the zero function otherwise. Finally, we take σ to be the
expectation of ψ, which is certainly a convex combination of functions in Ψ(ζj+1 , . . . , ζk ).
Let us begin with the ﬁrst inequality. Here we shall prove the slightly stronger result that the
′
inequality holds even if we take ψ = ◦j (gω1′ , . . . , gωj−1
, (fj+1 )νj+1 , . . . , (fk )νk ) for all choices of Vh
(rather than setting it to be zero when one of the Vh is too large).
Let T be the function from R to R deﬁned by T (y) = min{y, 2} and let S(y) = y − T (y) =
max{y − 2, 0}. Then
◦j (g, . . . , g, fj+1 , . . . , fk ) = T (∗j (g, . . . , g, fj+1 , . . . , fk ))
′
= T (E(∗j (gω1′ , . . . , gωj−1
, (fj+1 )νj+1 , . . . , (fk )νk ))),
′
(the reason we use the characteristic measures
by Lemmas 6.5 and 6.6 and the fact that g = Ea gωh,a
′
ωh,a rather than the associated measures ωh,a here is so that this identity is exactly true rather than
merely approximately true with high probability). On the other hand,
′
′
, (fj+1 )νj+1 , . . . , (fk )νk )).
, (fj+1 )νj+1 , . . . , (fk )νk )) = ET (∗j (gω1′ , . . . , gωj−1
E(◦j (gω1′ , . . . , gωj−1

Since T is a concave function, the result follows from Jensen’s inequality.
Now let us deﬁne H and prove the second inequality. Since capped convolutions are smaller than
′
, (fj+1 )νj+1 , . . . , (fk )νk )),
convolutions and, as above, ∗j (g, . . . , g, fj+1 , . . . , fk )) = E(∗j (gω1′ , . . . , gωj−1
′
, (fj+1 )νj+1 , . . . , (fk )νk ) − ψ), which
the left-hand side of this inequality is at most E(∗j (gω1′ , . . . , gωj−1
is Eτ , where
′
τ = S(∗j (gω1′ , . . . , gωj−1
, (fj+1 )νj+1 , . . . , (fk )νk ))
32

′
if every Vh has size at most 2q|X|, and ∗j (gω1′ , . . . , gωj−1
, (fj+1 )νj+1 , . . . , (fk )νk ) otherwise.
′
′
If every Vh has size at most 2q|X|, then τ ≤ S(∗j (ω1 , . . . , ωj−1
, νj+1 , . . . , νk )), since S is an increasing function. If there is some set Vh which is too large, then we use the bound
′
∗j (gω1′ , . . . , gωj−1
, (fj+1 )νj+1 , . . . , (fk )νk ) ≤ |X|k ∗j (1, . . . , 1) = |X|k ,

|X|
≤ |X| and (fh )νh ≤ νh ≤ (p/q)ζh ≤ q −1 ≤ |X| for every h.
which follows since gωh′ ≤ ωh′ ≤ |W
h|
Since, by Chernoﬀ’s inequality, the probability that some one of the Vh has size larger than 2q|X| is
exponentially small in q|X|, the contribution of these bad terms is o(1) everywhere.
We also have the trivial bound

◦j (g, . . . , g, fj+1 , . . . , fk ) − σ ≤ 2.
′
Accordingly, if we set H = min{η + ES(∗j (ω1′ , . . . , ωj−1
, νj+1 , . . . , νk )), 2}, then, provided |X| is suﬃciently large, we have a function that satisﬁes the second inequality and trivially satisﬁes the inequality
H ∞ ≤ 2.
It remains to bound H 1 . Let η = α/4. The suﬃcient randomness assumption tells us that
when we choose our random sequence (ω1 , . . . , ωj−1 , νj+1 , . . . , νk ), the probability that it satisﬁes Q1
is 1 − o(|X|−k ). Since there are at most |X|k ways of choosing ω1 , . . . , ωj−1 , it follows that with
probability 1 − o(1), every single such choice results in a sequence that satisﬁes Q1. That is, we have
the inequality

∗j (ω1,a1 , . . . , ωj−1,aj−1 , νj+1 , . . . , νk ) − ◦j (ω1,a1 , . . . , ωj−1,aj−1 , νj+1 , . . . , νk )

1

≤ η.

The condition that |Wi | = (1 + o(1))q|X| implies that, for every 1 ≤ i ≤ k and every a ∈ |X|,
′ . Therefore, for |X| suﬃciently large,
ωi,a = (1 + o(1))ωi,a
′
′
′
′
∗j (ω1,a
, . . . , ωj−1,a
, νj+1 , . . . , νk ) − ◦j (ω1,a
, . . . , ωj−1,a
, νj+1 , . . . , νk )
1
1
j−1
j−1

1

≤ 2η,

for any νj+1 , . . . , νk such that every choice of ω1 , . . . , ωj−1 yields a sequence that satisﬁes Q1.
If νj+1 , . . . , νk are such that there exists (a1 , . . . , aj−1 ) for which (ω1,a1 , . . . , ωj−1,aj−1 , νj+1 , . . . , νk )
does not satisfy Q1, then we use a “trivial” bound instead. For each ﬁxed choice of (Vj+1 , . . . , Vk ) we
have
′
′
, νj+1 , . . . , νk )
E ∗j (ω1,a
, . . . , ωj−1,a
1
j−1

1

=

∗j (1, . . . , 1, νj+1 , . . . , νk )
k−j

≤ (p/q)

1

∗j (1, . . . , 1, ζj+1 , . . . , ζk ) 1 ,

where the expectation here is taken over all sequences (a1 , . . . , aj−1 ). The inequality follows from the
fact that 0 ≤ νh ≤ (p/q)ζh for each i. The constant η is at most 1, so applying assumption (i) if j = 1,
we ﬁnd that
∗1 (ζ2 , . . . , ζk )

1

≤ ◦1 (ζ2 , . . . , ζk )

1

+ ∗1 (ζ2 , . . . , ζk ) − ◦1 (ζ2 , . . . , ζk )

1

≤ 2 + η ≤ 3.

∗j (1, . . . , 1, ζj+1 , . . . , ζk )

1

≤ 2. In either case,

Similarly, applying assumption (ii) if j > 1, we have

′
′
E ∗j (ω1,a
, . . . , ωj−1,a
, νj+1 , . . . , νk )
1
j−1

33

1

≤ 3(p/q)k−1 ≤ 3Lk .

As |X| tends to inﬁnity, the probability that the ﬁrst bound does not hold for every (a1 , . . . , aj−1 )
tends to zero, and the second bound always holds. Therefore, if |X| is suﬃciently large, it follows that
H

1

′
′
′
′
≤ 2η + E ∗j (ω1,a
, . . . , ωj−1,a
, νj+1 , . . . , νk ) − ◦j (ω1,a
, . . . , ωj−1,a
, νj+1 , . . . , νk )
1
1
j−1
j−1

1

≤ 4η = α,
where the expectation is taken over all sequences containing those νj+1 , . . . , νk such that, for all choices
of a1 , . . . , aj−1 , (ω1,a1 , . . . , ωj−1,aj−1 , νj+1 , . . . , νk ) satisﬁes Q1. The result follows.
✷
What we have shown is not just that every element of Φ(ζj+1 , . . . , ζk ) can be approximated well
in L1 and reasonably well in L∞ by a convex combination of elements of Ψ(ζj+1 , . . . , ζk ), but rather
the stronger statement that the diﬀerence is bounded above by a fixed bounded function with small
L1 -norm. This will be important to us later.
The title of this section was “The set of basic anti-uniform functions has few extreme points.”
That is an oversimpliﬁcation: the next result is what we actually mean.
Lemma 6.11. Let 0 < α ≤ 1/2k and L ≥ 2 be a positive integer with p = Lq. Then, for |X| sufficiently
large depending on L and α, the following holds. Let Zj+1 , . . . , Zk be subsets of X with associated
measures ζj+1 , . . . , ζk defined with weight p−1 , and suppose that assumptions (i), (ii) and (iii) are
k−j

satisfied. Then there is a collection Ψ′ = Ψ′ (ζj+1 , . . . , ζk ) of at most |X|k−1 2p|X|
(2/α)(k−1)2q|X|
2q|X|
functions that take values in [0, 2], and non-negative functions H and H ′ with H 1 ≤ α, H ∞ ≤ 2,
H ′ 1 ≤ 3α(k − 1) and H ′ ∞ ≤ 2, such that for every function φ = ◦j (g, . . . , g, fj+1 , . . . , fk ) in
Φ(ζj+1 , . . . , ζk ) there is a function ψ in the convex hull of Ψ′ with ψ ≤ φ ≤ ψ + H + H ′ .
Proof. Choose a positive integer t such that α/2 ≤ t−1 ≤ α. Then there exists a non-negative
function g′ with 0 ≤ g′ ≤ 1 such that every value taken by g′ is a multiple of t−1 , and such that
0 ≤ g′ ≤ g ≤ g′ + α. Also, for every h and every function fh such that 0 ≤ fh ≤ ζh there exists a
function fh′ with 0 ≤ fh′ ≤ ζh taking values that are multiples of t−1 ζh such that 0 ≤ fh′ ≤ fh ≤ fh′ +αζh .
We would now like to show, for any such choice of g and fj+1 , . . . , fk , that the functions φ =
′ , . . . , f ′ ) are reasonably close. We shall consider
◦j (g, . . . , g, fj+1 , . . . , fk ) and φ′ = ◦j (g ′ , . . . , g ′ , fj+1
k
the two cases j = 1 and j > 1 separately.
If j = 1 then
k
′
(◦1 (f2′ , . . . , fh−1
, fh , . . . , fk ) − ◦1 (f2′ , . . . , fh′ , fh+1 , . . . , fk ))

φ − φ′ =
h=2
k

′
, fh , . . . , fk ) − ∗1 (f2′ , . . . , fh′ , fh+1 , . . . , fk ))
(∗1 (f2′ , . . . , fh−1

≤
h=2
k

′
, fh − fh′ , fh+1 , . . . , fk )
∗1 (f2′ , . . . , fh−1

=
h=2
k

≤

∗1 (ζ2 , . . . , ζh−1 , αζh , ζh+1 , . . . , ζk )
h=2

= α(k − 1)(∗1 (ζ2 , . . . , ζk )).

34

Since η ≤ 1, assumption (i) implies that
∗1 (ζ2 , . . . , ζk )

1

≤ 3,

so we ﬁnd that ◦1 (f2 , . . . , fk ) − ◦1 (f2′ , . . . , fk′ ) is bounded above by a function H ′ with L1 -norm at most
3α(k − 1). It is clearly also bounded above by 2.
Lemma 6.10 gives us H with H 1 ≤ α, H ∞ ≤ 2, and also ψ ∈ Ψ(ζ2 , . . . , ζk ) such that 0 ≤
◦1 (f2′ , . . . , fk′ ) − ψ ≤ H. Putting these two facts together implies the required bounds on H and H ′
for the case j = 1.
If j > 1 then a very similar argument shows that
φ − φ′ ≤ α(k − 1)(∗j (1, . . . , 1, ζj+1 , . . . , ζk )).
By assumption (ii), ∗j (1, . . . , 1, ζj+1 , . . . , ζk ) ∞ ≤ 2, so in this case we have a function H ′ with
L∞ -norm at most 2α(k − 1) ≤ 2 and therefore with L1 -norm at most 2α(k − 1).
All that remains is to count the number of functions in Ψ(ζj+1 , . . . , ζk ) that are normalized restric′ , . . . , f ′ ). It is here that we shall use the assumption
tions of functions of the form ◦j (g′ , . . . , g ′ , fj+1
k
that the sets Zh each have cardinality (1 + o(1))p|X| ≤ 2p|X|. There are at most |X|j−1 choices for
the set (a1 , . . . , aj−1 ), and for each j + 1 ≤ i ≤ k, because of the upper bound on the sizes of the Zi
choices for the set Vi . (Note that since p = Lq ≥ 2q, the largest
and Vi , there are at most |X| 2p|X|
2q|X|
binomial coeﬃcient is indeed this one.) Finally, each valuation of each function has at most t ≤ 2/α
possible results and each of the k − 1 functions has a domain of size at most 2q|X|. Therefore, the
number of normalized restrictions is at most
|X|k−1

2p|X|
2q|X|

k−j

(2/α)(k−1)2q|X| ,

as required.

6.3

✷

The proof for products of basic anti-uniform functions

To connect the results of the previous subsection with basic anti-uniform functions, take a sequence
U1 , . . . , Um of subsets of X with associated measures µ1 , . . . , µm . Then, for each j and each sequence
(ij+1 , . . . , ik ) of distinct indices between 1 and m, we shall apply the results with Zh = Uih and
ζh = µih . Then the functions in the set Φ(ζj+1 , . . . , ζk ) are basic anti-uniform functions.
In this section, it will be clear that we are talking about measures µ1 , . . . , µm , and therefore
it will be convenient to write Φ(ij+1 , . . . , ik ) and Ψ(ij+1 , . . . , ik ) instead of Φ(µij+1 , . . . , µik ) and
Ψ(µij+1 , . . . , µik ).
Our next task is to generalize Lemma 6.11 to a result that applies not just to basic anti-uniform
functions but also to products of at most d such functions. This is a formal consequence of Lemma
6.11. The exact nature of the bounds we obtain for J 1 and J ∞ is unimportant: what matters is
that the ﬁrst can be made arbitrarily small and the second is bounded. We need a deﬁnition.
Definition 6.12. If φ ∈ Φ(ij+1 , . . . , ik ), then define the proﬁle of φ to be the ordered set (ij+1 , . . . , ik ),
and if ξ is a product of d basic anti-uniform functions φh , then define the profile of ξ to be the set of
all d profiles of the φh . We will refer to d as the size of the profile.
35

Corollary 6.13. Let 0 < α ≤ 1/2k and L ≥ 2 be a positive integer with p = Lq. Then, for |X|
sufficiently large depending on L and α, the following holds. Suppose that A is a profile of size d and,
for every (ij+1 , . . . , ik ) in A, the sets Uij+1 , . . . , Uik satisfy assumptions (i), (ii) and (iii). Then there
2p|X| kd
(2/α)2kdq|X| functions that take values in [0, 2d ] and
2q|X|
J 1 ≤ dαk6d and J ∞ ≤ d6d , such that for every function

is a collection ∆ = ∆(A) of at most |X|kd

a non-negative function J = J(A) with
ξ that is a product of basic anti-uniform functions with profile A, there is a function ψ in the convex
hull of ∆ with ψ ≤ ξ ≤ ψ + J.

Proof. Every function ξ with proﬁle A is a product φ1 . . . φd , where each φi is a basic anti-uniform
function with some ﬁxed proﬁle. That is, each φi belongs to a ﬁxed set of the form Φ(ij+1 , . . . , ik ).
By Lemma 6.11 we can ﬁnd ψi such that ψi ≤ φi ≤ ψi + Ji , where ψi belongs to the convex hull of
k

(2/α)2kq|X| , and Ji is a ﬁxed function such that Ji
a set Ψ′i of size at most |X|k 2p|X|
2q|X|
Ji 1 ≤ 4αk.
It follows that i ψi ≤ ξ ≤ i (ψi + Ji ). But
ψi ≤

(ψi + Ji ) −
i=1

≤ 4 and

d

d

d

∞

i=1

Jh
h=1

(ψi + Ji ).
i=h

Since each ψi has L∞ -norm at most 2, the latter function has L1 -norm at most dαk6d and L∞ -norm
at most d6d , as claimed.
✷
We are now ready for the main result of this section. It will be convenient once again to give names
to certain assumptions.
R1(r, j). If Z1 , . . . , Zk are chosen independently from Xr and their associated measures are ζ1 , . . . , ζk , then
∗j (ζ1 , . . . , ζj−1 , ζj+1 , . . . , ζk ) − ◦j (ζ1 , . . . , ζj−1 , ζj+1 , . . . , ζk ) 1 ≤ η with probability 1 − o(|X|−k ).
R2(r). With the notation as in R1, the probability that ∗j (1, . . . , 1, ζj+1 , . . . , ζk )
is 1 − o(1).

∞

≤ 2 for every j ≥ 2

Note that R1(r, j) is saying that Q1 holds with high probability, and R2(r) is saying that Q2 holds
with high probability for every j (when the νi are the associated measures of random sets from Xr ).
Lemma 6.14. For any positive constant λ and positive integer d, there exist η, m and L such that the
following holds. Let 0 < p0 ≤ 1/L and suppose that assumptions R1(r, j) and R2(r) hold for every j
and for every r ≥ p0 . Let p ≥ Lp0 , let U1 , . . . , Um be chosen independently from Xp , and let µ1 , . . . , µm
be their associated measures. Then, with probability 1 − o(1), they satisfy property P3. That is, setting
µ = m−1 (µ1 + · · · + µm ), | µ − 1, ξ | < λ whenever ξ is a product of at most d basic anti-uniform
functions from Φµ,1 .
Proof. Let A be a proﬁle and suppose that i is not involved in A. Let Γ = Γ(A) be the set of all
products of at most d basic anti-uniform functions with proﬁle A. Let q = p/L for a constant L yet to
be determined. By assumption R1(q, j), Lemma 6.8 implies that for every sequence (ij+1 , . . . , ik ), the
probability that assumption (iii) holds with parameters p and q for the sets Uij+1 , . . . , Uik is 1 − o(1).
Therefore, the probability that it holds for all j and all sequences (ij+1 , . . . , ik ) in the proﬁle A is also
36

1 − o(1). By assumptions R1(p, 1) and R2(p), we also know that assumptions (i) and (ii) hold with
probability 1 − o(1) for any given (ij+1 , . . . , ik ) and, therefore, for all (ij+1 , . . . , ik ) in the proﬁle A.
We may therefore apply Corollary 6.13 to conclude that there exists a set ∆ = ∆(A) of at most
|X|kd

2p|X| kd
(2/α)2kdq|X|
2q|X|

functions such that, for every function ξ ∈ Γ, there exists ψ in ∆ with

|ξ − ψ| ≤ H, where H 1 ≤ dαk6d and H
that, with probability 1 − o(1),

∞

≤ d6d . If we let α = λ/12kd6d , Corollary 6.3 implies

max{| µi − 1, φ | : φ ∈ Γ} ≤ max{| µi − 1, ψ ′ | : ψ ′ ∈ ∆} +

λ
.
4

Note that this step depends critically on the fact that µi is entirely independent of the set ∆(A). It was
for this purpose that we chose m random sets U1 , . . . , Um rather than one single random set U . This
observation is also important in the next step, which is to prove that max{| µi −1, ψ ′ | : ψ ′ ∈ ∆} ≤ λ/4
with probability 1 − o(1).
By Lemma 5.2, since ψ ′ ∞ ≤ 2d for all ψ ′ ∈ ∆, the probability that | µi − 1, ψ ′ | > λ/4 is at most
2 exp(−λ2 p|X|/22d+10 ) for any given ψ ′ . Since p = Lq, we may estimate the number of elements in
∆(A) as follows.
kd

|X|

2p|X|
2q|X|

kd
2kdq|X|

(2/α)

kd

≤ |X|

6p|X|
2q|X|

2kdq|X|

≤ |X|kd (3L)2kdp|X|/L
kd

= |X|

72Lkd6d
λ

24kd6d
λ
2kd

2kdq|X|

24kd6d
λ

2kdp|X|/L

p|X|/L

.

If we choose L suﬃciently large (depending on k, d and λ), then we can arrange for the sum of the
probabilities, which is at most 2 exp(−λ2 p|X|/22d+10 )|∆(A)|, to be o(1).
We are almost done. We now wish to prove a result about µ = m−1 (µ1 + · · · + µm ). Applying our
result so far to all proﬁles simultaneously, we ﬁnd that with probability 1 − o(1), | µi − 1, ξ | ≤ λ/2
for every µi and ξ such that i is not involved in the proﬁle of ξ. Fix a particular ξ0 . If we choose i at
random, the probability that it is involved in the proﬁle of ξ0 is at most (k − 1)d/m. Furthermore, for
any i, we have the trivial bound | µi − 1, ξ0 | ≤ 2d+2 , since ξ0 ∞ ≤ 2d and, for |X| suﬃciently large,
µi − 1 1 ≤ 3. Therefore,
| µ − 1, ξ0 | ≤ Ei | µi − 1, ξ0 | ≤
provided m ≥ kd2d+3 /λ. The result follows.

6.4

(k − 1)d d+2 λ
2
+ ≤ λ,
m
2
✷

Obtaining P3′ as well

It is possible to add a ﬁxed set of bounded functions F to the collection of basic anti-uniform functions,
provided only that this set has size smaller than 2p|X|/L0 , where L0 is again some constant depending
only on k, λ and d, and the above proof continues to work. Indeed, adding such a collection can
increase the size of the set of products of basic anti-uniform functions by a factor of at most 2dp|X|/L0 .
37

Therefore, when we come to the ﬁnal line of the penultimate paragraph of the proof of the previous
lemma, provided L0 and L have been chosen small enough, the probability that the random measure
µi correlates with any given function is still small enough to guarantee that with high probability
max{| µi − 1, ψ ′ | : ψ ′ ∈ Γ′ } ≤ λ/4, where Γ′ is the set of functions formed from products of at most
d characteristic functions from F and basic anti-uniform functions whose proﬁle does not involve µi .
The remainder of the proof is the same, in that we add over all proﬁles and rule out the set of small
exceptions where the set Ui is involved in the proﬁle of ξ.
Later, when we come to apply this observation, F will be a collection of characteristic functions.
For example, to prove a stability version of Tur´
an’s theorem, the set F will be the collection of
characteristic measures of vertex subsets of {1, . . . , n}. This has size 2n . Therefore, provided p ≥ Cn−1 ,
for C suﬃciently large, we will have control over local densities.

7

Probabilistic estimates I: tail estimates

In this section, we shall focus on showing that property P2 holds with high probability. That is, we
shall show that under suitable conditions, with high probability ∗j (1, 1, . . . , 1, µij+1 , . . . , µik ) ∞ ≤ 2
for every j ≥ 2 and every sequence ij+1 , . . . , ik of distinct integers between 1 and m. It will be helpful
for the next section if we actually prove the following very slightly more general statement. For every
1 ≤ j ≤ k, every collection of measures ν1 , . . . , νk such that at least one of the measures other than
νj is the constant measure 1 and the rest are distinct measures of the form µij has the property that
∗j (ν1 , . . . , νk ) ∞ ≤ 23 .
Up to now, our argument has been general. Unfortunately, we must now be more speciﬁc about
the kind of sets that we are dealing with. We shall split into two cases. First, we shall look at systems
S with the following property.
Definition 7.1. A system S of ordered sequences of length k in a set X has two degrees of freedom
if, whenever s and t are two elements of S and there exist i = j such that si = ti and sj = tj , we have
s = t.
This includes the case when S is the set of arithmetic progressions in Zn , and higher-dimensional
generalizations concerning homothetic copies of a single set.
After that, we will look at graphs and hypergraphs. In this case, the required estimates are much
more diﬃcult. Thankfully, most of the hard work has already been done for us by Janson, Ruci´
nski
and, in one paper, Oleszkiewicz [28, 29, 30, 31, 32] (see also the paper of Vu, [65]). We shall return to
these estimates later.

7.1

The proof for systems with two degrees of freedom

Let U1 , . . . , Um be independent random sets chosen binomially and let their associated measures be
µ1 , . . . , µm . We are interested in quantities of the form ∗j (ν1 , . . . , νk )(x), where each νi (with i = j)
is equal to either the constant function 1 or to one of the measures µr . We also insist that no two of
the νi are equal to the same µr and that at least one of the νi is the constant function.
Suppose that the set of i such that νi is one of the µr is {a1 , . . . , al } and that νah = µbh for
h = 1, 2, . . . , l. Then we can interpret ∗j (ν1 , . . . , νk )(x) as follows. Recall that Sj (x) is the set of all
s = (s1 , . . . , sk ) ∈ S such that sj = x. Then ∗j (ν1 , . . . , νk )(x) is equal to p−l times the proportion of
38

s ∈ Sj (x) such that sah ∈ Ubh for every h = 1, . . . , l. This is because νah (sah ) = p−1 if sah ∈ Ubh and
0 otherwise.
Now let us regard sequences s ∈ S as ﬁxed and U1 , . . . , Um as random variables. For each s, let E(s)
be the event that sah ∈ Ubh for every h = 1, . . . , l (so E(s) is an event that depends on U1 , . . . , Um ).
We claim that if s and t are distinct sequences in Sj (x), then E(s) and E(t) are independent. The
reason for this is that we know that sj = tj , and our assumption that S has two degrees of freedom
therefore implies that there is no other i such that si = ti . It follows that the events sah ∈ Ubh and
tah ∈ Ubh are independent (since the sets Ui are chosen binomially) and hence that E(s) and E(t) are
independent (since the sets Ub1 , . . . , Ubl are independent).
Lemma 7.2. Let X be a finite set, let S be a homogeneous collection of ordered subsets of X, each
of size k, and suppose that S has two degrees of freedom. Let U1 , . . . , Uk be random subsets of X with
associated measures µ1 , . . . , µk , each chosen binomially with probability p. Let 1 ≤ j ≤ k and let L
be a subset of {1, 2, . . . , k} \ {j} of cardinality l < k − 1. For each i ≤ k, let νi = µi if i ∈ L and
1 otherwise. Let x ∈ Zn . Then the probability that ∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(x) ≤ 23 is at least
1 − 2 exp(−pl |Sj (x)|/16).
Proof. Let χi be the characteristic function of Ui . Suppose that L = {a1 , . . . , al }. Then
∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(x) = p−l Es∈Sj (x)

χi (si ).
i∈L

Now i∈L χi (si ) is the characteristic function of the event E(s) mentioned just before the statement of
this lemma, in the case when bh = ah for every h. As we have discussed, these events are independent.
Moreover, they each have probability pl . Therefore, Es∈Sj (x) i∈L χi (si ) is an average of |Sj (x)|
independent Bernoulli random variables of probability pl .
By Chernoﬀ’s inequality, Lemma 5.3, s∈Sj (x) i∈L χi (si ) ≤ 32 pl |Sj (x)| with probability at least
1 − 2 exp(−pl |Sj (x)|/16). Therefore, Es∈Sj (x) i∈L χi (si ) ≤ 23 pl with the same probability. This proves
the result.
✷
It is perhaps not immediately obvious how the bound for the probability in the last lemma relates
to sharp values for p in applications. To get a feel for this, consider the case when S is the set of k-term
arithmetic progressions in Zn . Then |Sj (x)| = n for every x and j as |X| = n. We want to be able to
take p to be around n−1/(k−1) . With this value, exp(−pl |Sj (x)|/16), takes the form exp(−cn1−l/(k−1) ).
In the worst case, when l = k − 2, this works out to be exp(−cn1/(k−1) ), which drops oﬀ faster than
any power of n. If we took l = k − 1 then we would no longer have an interesting statement: that is
why convolutions where every νi is equal to some µj must be treated in a diﬀerent way.

7.2

The proof for strictly balanced graphs and hypergraphs

We now turn to the more diﬃcult case of ﬁnding copies of a ﬁxed balanced graph or hypergraph.
Again, we are trying to show that ∗j (ν1 , . . . , νk )(x) is reasonably close to 1 with very high probability,
but now this quantity is a normalized count of certain graphs or hypergraphs. Normally when one has
a large deviation inequality, one expects the probability of large deviations to be exponentially small
in the expectation. In the graph case a theorem of roughly this variety may be proved for the lower
tail by using Janson’s inequality [28], but the behaviour of the upper tail is much more complex. The
39

best that can be achieved is a ﬁxed power of the expectation. The result that we shall use in this case
is due to Janson and Ruci´
nski [31]. Before we state it, we need some preliminary discussion.
To begin with, let us be precise about what we are taking as X and what we are taking as S. We
are counting copies of a ﬁxed labelled r-uniform hypergraph H. Let H have vertex set V of size m
and (labelled) edge set (e1 , . . . , er ). (That is, each ei is a subset of V of size r and we choose some
arbitrary ordering.) Let W be a set of size n (which we think of as large) and let X = W (r) , the set
of all subsets of W of order r.
Given any injection φ : V → W we can form a sequence (s1 , . . . , sk ) of subsets of W by setting
si = φ(ei ). We let S be the set of all sequences that arise in this way. The elements of S are copies of
H with correspondingly labelled edges.
If we ﬁx an edge e ∈ X and an index j, then Sj (e) is the set of all sequences (s1 , . . . , sk ) in S such
that sj = e. To obtain such a sequence, one must take a bijection from ej (which is a subset of V of
order r) to e (which is a subset of W of order r) and extend it to an injection φ from V to W . One
then sets si = φ(ei ) for each i.
Now let U1 , . . . , Um be independent random subsets of X, chosen binomially with probability p, and
let their associated measures be µ1 , . . . , µm . Suppose once again that ν1 , . . . , νk are measures, some of
which are constant and some of which are equal to distinct µi . Suppose that the non-trivial measures,
not including νj if it is non-trivial, are νa1 , . . . , νal , and suppose that νai = µbi for i = 1, 2, . . . , l. Then
the value ∗j (ν1 , . . . , νk )(e) of the jth convolution at e is equal to
µbi (sai ).

Es∈Sj (e)
1≤i≤l

This is p−l |Sj (e)|−1 times the number of sequences (s1 , . . . , sk ) ∈ S such that sj = e and sai ∈ Ubi for
every 1 ≤ i ≤ l. If we deﬁne H ′ to be the subhypergraph of H that consists of the edges ea1 , . . . , eal ,
then each such sequence is a so-called ej -rooted copy of H ′ in (e, X). That is, it is a copy of H ′ where
we insist that the vertices in ej map bijectively to the vertices in e. We are interested in the number of
rooted copies such that the edges fall into certain sparse random sets. This is not an easy calculation,
but it has been done for us by Janson and Ruci´
nski. In order to state the result we shall need, let us
deﬁne formally the random variable that we wish not to deviate much from its mean.
Notation. Let K be a labelled r-uniform hypergraph and f an edge in K. Let l be the number of edges
in K\{f } and let U1 , . . . , Ul be random binomial subhypergraphs of the complete r-uniform hypergraph
(r)
Kn on n vertices, each edge being chosen with probability p, with characteristic functions χ1 , . . . , χl .
(r)
Let Sf be the set consisting of all labelled ordered copies of K\{f } in Kn that are f -rooted at a given
edge e. Then the random variable YKf is given by
χi (si ).
s∈Sf 1≤i≤l

Strictly speaking YKf depends on e as well, but we omit this from the notation because it makes
no diﬀerence to the probabilities which edge e we choose. (So we could, for example, state the result
for e = {1, 2, . . . , r} and deduce it for all other e.)
The number of injections φ that extend a bijection from f to e is r!(n−r)(n−r −1) . . . (n−vK +1),
and for each one the probability that si ∈ Ui for every i is pl = peK −1 , so the expectation EYKf is
peK −1 r!(n − r)(n − r − 1) . . . (n − vK + 1).
40

The precise details will not matter to us much, but note that the order of magnitude is peK −1 nvK −r .
We are now ready to state the result of Janson and Ruci´
nski. It is actually a very special case of
a much more general result (Corollary 4.1 from [31]). To explain the general statement would lead us
too far astray so we restrict ourselves to stating the required corollary.
Lemma 7.3. Let K be a labelled r-uniform hypergraph and f a fixed edge. Then there exists a constant
c such that the random variable YKf satisfies
P YKf ≥

3
EY f
2 K

≤ 2nvK exp −c min (EYLf )1/vL .
L⊆K

A better, indeed almost sharp, result has recently been proved by Janson and Ruci´
nski [32].
Unfortunately, though the result almost certainly extends to hypergraphs, it is stated by these authors
only for graphs. However, the previous result is more than suﬃcient for our current purposes.
(r)
We are now ready to show that if X = Kn , S is the collection of labelled copies of a strictly
balanced hypergraph H in X and p ≥ n−1/mr (H) , then P2 holds with high probability. The proof is
essentially the same as it was for systems with two degrees of freedom, except that we have to use the
results of Janson and Ruci´
nski instead of Chernoﬀ’s inequality. Recall that an r-uniform hypergraph
−1
−1
H is strictly r-balanced if veH
> veK
for every proper subhypergraph K of H.
H −r
K −r
(r)

Lemma 7.4. Let H be a strictly r-balanced r-uniform hypergraph with k edges. Let X = Kn and let
S be the collection of labelled ordered copies of H in X. Let U1 , . . . , Uk be random subsets of X, each
chosen binomially with probability p, and let their characteristic measures be µ1 , . . . , µk . Let 1 ≤ j ≤ k
and let L be a subset of {1, 2, . . . , k} \ {j} of cardinality l < k − 1. For each i ≤ k, let νi = µi if i ∈ L
and 1 otherwise. Let e ∈ X. Then for p ≥ n−1/mr (H) there exist positive constants a and A such that
a
the probability that ∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(e) ≤ 23 is at least 1 − 2nvH e−An .
Proof. Let χi be the characteristic function of Ui . Then
∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(e) = p−l Es∈Sj (e)

χi (si ).
i∈L

The sum s∈Sj (e) i∈L χi (si ) counts the number of rooted copies of some proper subhypergraph K
of H. By Lemma 7.3, the probability that s∈Sj (e) i∈L χi (si ) ≥ 23 pl |Sj (e)| is at most
e

2nvK exp −c min (EYJ j )1/vJ
J⊆K

= 2nvK exp −c′ min (nvJ −r peJ −1 )1/vJ

.

J⊆K

−1
> evJJ −1
Since H is strictly r-balanced, we know that evH
−r for every J ⊆ K. Therefore, there is a
H −r
′
−1/m
r (H)
positive constant a such that if p ≥ n
, then for each J ⊆ K we have the inequality

nvJ −r peJ −1 ≥ nvJ −r n

−

vH −r
eH −1

(eJ −1)

≥

n

1−

vH −r
eH −1

eJ −1
vJ −r

vJ −r

′

≥ na .

Therefore,
min (nvJ −r peJ −1 )1/vJ ≥ na ,

J⊆K

a

for some a, and hence the probability that s∈Sj (e) i∈L χi (si ) ≥ 23 pl |Sj (e)| is at most 2nvH e−An for
some positive constants A and a. The lemma follows.
✷
41

8

Probabilistic estimates II: bounding L1 -differences

Our one remaining task is to show that property P1 holds with suﬃciently high probability. In other
words, we must show that if U1 , . . . , Um are subsets of X chosen binomially with suitable probability
p, and if their associated measures are µ1 , . . . , µm , then with high probability
∗j (µi1 , . . . , µij−1 , µij+1 , . . . , µik ) − ◦j (µi1 , . . . , µij−1 , µij+1 , . . . , µik )

1

≤η

whenever j is an integer between 1 and k and i1 , . . . , ij−1 , ij+1 , . . . , ik are distinct integers between 1
and m. Of course, if we can prove this for one choice of j and i1 , . . . , ij−1 , ij+1 , . . . , ik then we have
proved it for all, since m and k are bounded. So without loss of generality let us prove it for j = 1
and for the sequence (2, . . . , k). That is, we shall prove that with high probability
∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk )

1

≤ η.

Our results will also imply the stronger statement R1(p, 1), which was required for Lemma 6.14.
The basic approach is to show that with high probability the sets U2 , . . . , Uk−1 have certain properties that we can exploit, and that if they have those properties then the conditional probability that
∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk ) 1 ≤ η is also high. This strategy is almost forced on us: there are
some choices of U2 , . . . , Uk−1 that would be disastrous, and although they are rare we have to take
account of their existence.
To get some idea of what the useful properties are, let us suppose that we have chosen U2 , . . . , Uk−1 ,
let us ﬁx x ∈ X, and let us think about the random variable ∗1 (µ2 , . . . , µk )(x) (which, given our choices,
depends just on the random set Uk ). This is, by deﬁnition,
Es∈S1 (x) µ2 (s2 ) . . . µk−1 (sk−1 )µk (sk ).
At this point we need an extra homogeneity assumption. We would like to split up the above expectation according to the value of sk , but that will lead to problems if diﬀerent values of sk are taken
diﬀerent numbers of times. Let us suppose that for each y the number of s ∈ S1 (x) such that sk = y,
which is just the cardinality of the set S1 (x) ∩ Sk (y), only ever takes one of two values, one of which
is 0.
In the case of arithmetic progressions of length k in Zp , with p prime, S1 (x) ∩ Sk (y) consists
of a unique arithmetic progression (degenerate if x = y), the progression with common diﬀerence
(k − 1)−1 (y − x) that starts at x. In the case of, say, K5 s in a complete graph, where s1 and s10
represent disjoint edges of K5 , S1 (e) ∩ S10 (e′ ) will be empty if e and e′ are edges of Kn that share
a vertex, and will have cardinality n − 4 if they are disjoint. In general, in all natural examples this
homogeneity assumption is satisﬁed. Moreover, the proportion of y for which S1 (x) ∩ Sk (y) = ∅ tends
to be O(1/n) and tends to correspond to degenerate cases (when those are not allowed).
With the help of this assumption, we can rewrite the previous expression as follows. Let us write
K(x) for the set of y such that S1 (x) ∩ Sk (y) = ∅. Then
∗1 (µ2 , . . . , µk )(x) = Es∈S1 (x) µ2 (s2 ) . . . µk−1 (sk−1 )µk (sk )
= Ey∈K(x) µk (y)Es∈S1 (x)∩Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 ).
Writing W (x, y) for Es∈S1 (x)∩Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 ), we can condense this to Ey∈K(x) µk (y)W (x, y).
42

Now we are thinking of µ2 , . . . , µk−1 as ﬁxed, and of the expressions we write as random variables that depend on the random measure µk . Note that the expectation of ∗1 (µ2 , . . . , µk )(x) is
∗1 (µ2 , . . . , µk−1 , 1)(x). By the results of the previous section, we are free to assume that this is at
most 3/2 for every x.
Our plan is to prove that the expectation of ∗1 (µ2 , . . . , µk )(x) − ◦1 (µ2 , . . . , µk )(x) is small for each
x, which will show that the expectation of ∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk ) 1 is small. Having done
that, we shall argue that it is highly concentrated about its expectation.
Now, as we have seen, the random variable ∗1 (µ2 , . . . , µk )(x) is equal to Ey∈K(x) µk (y)W (x, y),
which is a sum of independent random variables Vy , where Vy = (p|K(x)|)−1 W (x, y) with probability
p and 0 otherwise. The expectation Ey∈K(x) W (x, y) of this sum is ∗1 (µ2 , . . . , µk−1 , 1)(x), which we
are assuming to be at most 3/2. If we also know that each Vy is small, then the chances that this
sum is bigger than 2 are very small. From this it is possible to deduce that the expectation of
∗1 (µ2 , . . . , µk )(x) − ◦1 (µ2 , . . . , µk )(x) is small. The following technical lemma makes these arguments
precise.
In the statement of the next lemma, we write Ey∈K for the average over K, and E for the probabilistic expectation (over all possible choices of µk with their appropriate probabilities).
Lemma 8.1. Let 0 ≤ p ≤ 1 and let 0 < α ≤ 1. Let K be a set and for each y ∈ K let Vy be a
random variable that takes the value Cy > 0 with probability p and 0 otherwise. Suppose that the Vy
are independent and that each Cy is at most α. Let S = y∈K Vy and suppose that ES ≤ 3/2. Let
T = max{S − 2, 0}. Then ET ≤ 14αe−1/14α .
Proof. If we increase the number of random variables or any of the values Cy , then the expectation of
T increases. Therefore, we are done if we can prove the result in the case where ES = 3/2.
We shall use the elementary identity
∞

∞

P[S ≥ 2 + t]dt.

P[T ≥ t]dt =

ET =

0

0

Since ES = 3/2, if S ≥ 2 + t it follows that S − ES ≥ t + 1/2. Let us bound the probability of this
event using Bernstein’s inequality (Lemma 5.1).
For this we need to bound y V(Vy ), which is at most y E(Vy2 ), which is at most α y E(Vy ),
by our assumption about the upper bound for each Cy . But this is αES = 3α/2. Therefore,
P[S ≥ 2 + t] ≤ 2 exp

−(t + 1/2)2
2(3α/2 + α(t + 1/2)/3)

.

Writing s = t + 1/2, this gives us 2 exp(−s2 /(3α + 2αs/3)). When s ≥ 1/2 (as it is everywhere in
the integral we are trying to bound), this is at most 2 exp(−s2 /(6αs + 2αs/3)) ≤ 2 exp(−s/7α), so we
have an upper bound of
∞

2

exp(−s/7α)ds = 14αe−1/14α ,

1/2

which proves the lemma.

✷

Corollary 8.2. Suppose that µ2 , . . . , µk−1 are fixed and that W (x, y) ≤ αp|K(x)| for every x and y
and ∗1 (µ2 , . . . , µk−1 , 1)(x) ≤ 3/2 for every x. Then
E(∗1 (µ2 , . . . , µk )(x) − ◦1 (µ2 , . . . , µk )(x)) ≤ 14αe−1/14α
43

for every x.
Proof. As noted above, ∗1 (µ2 , . . . , µk )(x) is a sum of independent random variables Vy that take the
value (p|K(x)|)−1 W (x, y) with probability p and 0 otherwise. By our hypothesis about W (x, y),
we can take Cy = α for each y and apply the previous lemma. Then S = ∗1 (µ2 , . . . , µk )(x) and
T = ∗1 (µ2 , . . . , µk )(x) − ◦1 (µ2 , . . . , µk )(x), so the result follows.
✷
The next result but one is our main general lemma, after which we shall have to argue separately
for diﬀerent kinds of system. We shall use the following concentration of measure result, which is an
easy and standard consequence of Azuma’s inequality.
Lemma 8.3. Let X (t) be the collection of all subsets of size t of a finite set X. Let c, λ > 0 and let
F be a function defined on X (t) such that |F (U ) − F (V )| ≤ c whenever |U ∩ V | = t − 1. Then if a
random set U ∈ X (t) is chosen, the probability that |F (U ) − EF | ≥ λ is at most 2 exp(−λ2 /2c2 t).
Most of the conditions of the next lemma have been mentioned in the discussion above, but we
repeat them for convenience (even though the resulting statement becomes rather long).
Lemma 8.4. Let X be a finite set and let S be a homogeneous collection of ordered subsets of X, each
of size k. Let σ be a positive integer and suppose that, for all x, y ∈ X, |S1 (x) ∩ Sk (y)| ∈ {0, σ}. For
each x, let K(x) be the set of y such that S1 (x) ∩ Sk (y) = ∅, and suppose that all the sets K(x) have
the same size.
Let µ2 , . . . , µk−1 be fixed measures such that ∗1 (µ2 , . . . , µk−1 , 1)(x) and ∗k (1, µ2 , . . . , µk−1 )(x) are
at most 3/2 for every x ∈ X. For each x, y ∈ X, let
W (x, y) = Es∈S1 (x)∩Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 )
and suppose that W (x, y) ≤ αp|K(x)| for every x and y.
Let Uk be a random set chosen binomially with probability p, let µk be its associated measure, and
let η = 28αe−1/14α . Then
P[ ∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk )

1

> η] ≤ 2|X|e−η

2 p|X|/144

+ 2e−p|X|/4 .

Proof. Corollary 8.2 and linearity of expectation imply that
E ∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk )

1

≤ 14αe−1/14α = η/2.

Let us write Z for the random variable ∗1 (µ2 , . . . , µk ) − ◦1 (µ2 , . . . , µk ) 1 . To complete the proof, we
shall show that Z is highly concentrated about its mean.
To do this, we condition on the size of the set Uk and apply Lemma 8.3. Suppose, then, that
|Uk | = t. We must work out by how much we can change Z if we remove an element of Uk and add
another.
Since the function x → max{x − 2, 0} is 1-Lipschitz, the amount by which we can change Z is at
most the amount by which we can change Y = ∗1 (µ2 , . . . , µk ) 1 . But
∗1 (µ2 , . . . , µk )

1

= Ex Es∈S1 (x) µ2 (s2 ) . . . µk−1 (sk−1 )µk (sk )
= Ey µk (y)Es∈Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 )
= Ey µk (y) ∗k (1, µ2 , . . . , µk−1 )(y).
44

We are assuming that ∗k (1, µ2 , . . . , µk−1 )(y) is never more than 3/2, and µk (y) is always either p−1 or
0, so changing one element of Uk cannot change Y by more than 3(p|X|)−1 . (The division by |X| is
because we are taking an average over y rather than a sum over y.)
Lemma 8.3 now tells us that the probability that Z − EZ ≥ η/2 given that |Uk | = t is at most
2 exp(−η 2 p2 |X|2 /72t). It follows that if t ≤ 2p|X| then the probability is at most 2 exp(−η 2 p|X|/144).
By Chernoﬀ’s inequality, the probability that t > 2p|X| is at most 2 exp(−p|X|/4). Putting these two
facts together and adding over all possible values of t, we obtain the result stated.
✷
Our aim is to prove that property P1 holds with high probability for a given small constant
η > 0. Therefore, it remains to prove that, under suitable conditions on p, we have the bound
W (x, y) ≤ αp|K(x)| for every x, y ∈ X such that S1 (x) ∩ Sk (y) is non-empty, where α is also a given
small constant. Here, the argument once again depends on the particular form of the set of sequences
S.
In the case of sets with two degrees of freedom, this is trivial. Let us suppose that |K(x)| = t for
every x ∈ X. By deﬁnition, Si (x) ∩ Sj (y) is either empty or a singleton for every 1 ≤ i < j ≤ k and
every x, y ∈ X. It follows, when S1 (x) ∩ Sk (y) is non-empty, that
W (x, y) = Es∈S1 (x)∩Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 )
= µ2 (r2 ) . . . µk−1 (rk−1 )
≤ p−(k−2) ,
where r = (x, r2 , . . . , rk−1 , y) is the unique element of S that belongs to S1 (x) ∩ Sk (y). This is smaller
than αpt as long as p ≥ (αt)−1/(k−1) . Recall that in a typical instance, such as when S is the set
of k-term arithmetic progressions in Zn for some prime n, t will be very close to n (or in that case
actually equal to n), and we do indeed obtain a bound of the form Cn−1/(k−1) that is within a constant
of best possible.
Thus, we have essentially already ﬁnished the proof of a sparse random version of Szemer´edi’s
theorem, and of several other similar theorems. We will spell out the details of these applications later
in the paper. Now, however, let us turn to the more diﬃcult task of verifying the hypothesis about
W in the case of graphs and hypergraphs.
Let H be a strictly r-balanced r-uniform hypergraph. Recall that mr (H) is the ratio (eH −1)/(vH −
(r)
r). The signiﬁcance of mr (H) is that if Gn,p is a random r-uniform hypergraph on n vertices, with
each edge chosen with probability p, then the expected number of labelled copies of H containing
(r)
any given edge of Gn,p is approximately peH −1 nvH −r (the “approximately” being the result of a few
degenerate cases), so we need p ≥ n−1/mr (H) for this expected number to be at least 1, which, at least
in the density case, is a trivial necessary condition for our theorems to hold. Our main aim now is to
prove that W (x, y) ≤ αp|K(x)| holds when p ≥ Cn−1/mr (H) , where C is a constant that depends only
on α and the hypergraph H.
In the next result, we shall take p to equal Cn−1/mr (H) and prove that the conclusion holds provided
C is suﬃciently large. However, it turns out that we have to split the result into two cases. In the
ﬁrst case, we also need to assume that C is smaller than nc for some small positive constant c, or else
the argument breaks down. However, when C is larger than this (so not actually a constant) we can
quote results of Janson and Ruci´
nski to ﬁnish oﬀ the argument. (Some of our results, in particular
colouring theorems, are monotone, in the sense that the result for p implies the result for all q ≥ p.
In such cases we do not need to worry about large p.)
45

Lemma 8.5. Let H be a strictly r-balanced r-uniform hypergraph and let S be the collection of labelled
(r)
ordered copies of H in the complete r-uniform hypergraph Kn . Then, for any positive constants α
and A, there exist constants c > 0 and C0 such that, if n is sufficiently large, C0 ≤ C ≤ nc , and
(r)
p = Cn−1/mr (H) , then, with probability at least 1 − n−A , if U2 , . . . , Ue−1 are random subgraphs Gn,p of
(r)
Kn with associated measures µ2 , . . . , µe−1 ,
W (x, y) = Es∈S1(x)∩Se (y) µ2 (s2 ) . . . µe−1 (se−1 ) ≤ αp|K(x)|,
for all x, y ∈ X, where we have written e for eH .
Proof. Let χi be the characteristic function of Ui for each i ≤ eH . Let σ be the size of each non-empty
set S1 (x) ∩ Se (y) and suppose |K(x)| = t for each x. Then
W (x, y) = σ −1 p−(eH −2)

χ2 (s2 ) . . . χe−1 (se−1 ).
s∈S1 (x)∩Se (y)

But s∈S1 (x)∩Se (y) χ2 (s2 ) . . . χe−1 (se−1 ) is the number of sequences (s1 , . . . , se ) ∈ S such that s1 = x,
se = y and si ∈ Ui for i = 2, 3, . . . , e − 1. Therefore, our aim is to prove that with high probability this
number is at most αptσpeH −2 = αpeH −1 σt. Let h be the number of vertices in the union of the ﬁrst
and eth edges. Then σ is almost exactly nvH −h and t is almost exactly nh−r , so it is enough to prove
that with high probability the number of such sequences is at most (α/2)peH −1 nvH −r = (α/2)C eH −1 .
To do this, let us estimate from above the probability that there are at least (vH ℓ)vH such sequences.
(r)
It will be convenient to think of each sequence in S1 (x) ∩ Se (y) as an embedding φ from H to Kn
such that, writing f1 , . . . , fe for the edges of H, we have φ(f1 ) = x and φ(fe ) = y. Let us call φ good
if in addition φ(ei ) ∈ Ui for i = 2, 3, . . . , e − 1. Now if there are (vH ℓ)vH good embeddings, then there
must be a sequence φ1 , . . . , φℓ of good embeddings such that each φi (H) contains at least one vertex
that is not contained in any of φ1 (H), . . . , φi−1 (H). That is because the number of vertices in the
union of the images of the embeddings has to be at least vH ℓ, since the number of embeddings into a
set of size u is certainly no more than uvH , and because each embedding has vH vertices.
Let us ﬁx a sequence of embeddings φ1 , . . . , φℓ such that each one has a vertex in its image that
is not in the image of any previous one. Let v1 , . . . , vm be the sequence of vertices obtained by listing
all the vertices of φ1 (H) in order (taken from an initial ﬁxed order of the vertices of H), then all
the vertices of φ2 (H) that have not yet been listed, again in order, and so on. For each i ≤ ℓ, let
Vi be the set of vertices in φi (H) but no earlier φj (H). We shall now estimate the probability that
every φi is good. If we already know that φ1 , . . . , φi−1 are all good, then what we need to know is
how many edges belong to φi (H) that do not belong to φj (H) for any j < i. Let wi = |Vi | be the
number of vertices that belong to φi (H) and to no earlier φj (H), and let di be the number of edges.
Then the conditional probability that φi is good is pdi . It follows that the probability that φ1 , . . . , φℓ
are all good is pd1 +···+dℓ . The number of possible sequences of embeddings of this type is at most
mvH ℓ nm , since there are at most nm sequences v1 , . . . , vm , and once we have chosen v1 , . . . , vm there
are certainly no more than mvH ways of choosing the embedding φi (assuming that its image lies in
the set {v1 , . . . , vm }). Therefore, the probability that there exists a good sequence of ℓ embeddings of
this type is at most mvH ℓ pd1 +···+dℓ nw1+···+wℓ .
At this point, we use the hypothesis that H is strictly balanced. Since wi ≤ vH − h ≤ vH − (r + 1),
eH − 1
eH − 1 − di
<
,
vH − r − wi
vH − r
46

which implies that di /wi > mr (H). In fact, since there are only ﬁnitely many possibilities for wi and
di , it tells us that there is a constant c′ > 0 depending on H only such that di ≥ mr (H)(wi + c′ ).
′
Since p = Cn−1/mr (H) , this tells us that pdi ≤ C di n−(wi +c ) , and hence that
′

mvH ℓ pd1 +···+dℓ nw1+···+wℓ ≤ mvH ℓ C d1 +···+dℓ n−ℓc .
To complete the proof, let us show how to choose C, just to be sure that the dependences are
correct. We start by choosing ℓ such that ℓc′ ≥ 2A. Bearing in mind that m ≤ vH ℓ and that
d1 + · · · + dℓ ≤ eH ℓ, we place on C the upper bound C ≤ (vH ℓ)−vH ℓ nA/eH ℓ , which ensures that
′
mvH ℓ C d1 +···+dℓ n−ℓc ≤ n−A . Finally, we need C to be large enough for (α/2)C eH −1 to be greater
than (vH ℓ)vH , since then the probability that there are at least (α/2)C eH −1 sequences is at most n−A ,
✷
which is what we were trying to prove. Thus, we need C to be at least (2(vH ℓ)vH /α)1/(eH −1) .
To handle the case where C ≥ nc , we shall again need to appeal to the work of Janson and
Ruci´
nski on upper tail estimates. The particular random variable we will be interested in, which
concerns hypergraphs which are rooted on two edges, is deﬁned as follows.
Notation. Let K be an r-uniform hypergraph and f1 , f2 edges in K. Let l be the number of edges in
K\{f1 , f2 } and let U1 , . . . , Ul be random binomial subhypergraphs of the complete r-uniform hypergraph
(r)
Kn on n vertices, each edge being chosen with probability p, with characteristic functions χ1 , . . . , χl .
(r)
Let Sf1 ,f2 be the set consisting of all labelled ordered copies of K\{f1 , f2 } in Kn that are rooted at
given edges e1 and e2 . Then the random variable YKf1 ,f2 is given by
χi (si ).
s∈Sf1 ,f2 1≤i≤l

The necessary tail estimate (which is another particular case of Corollary 4.1 in [31]) is now the
following. Note that EYKf1 ,f2 is essentially peK −2 nvK −h , where h is the size of f1 ∪ f2 .
Lemma 8.6. Let K be an r-uniform hypergraph and f1 , f2 fixed edges. Then there exists a constant
c such that the random variable YKf1 ,f2 satisfies, for γ ≥ 2,
P YKf1 ,f2 ≥ γEYKf1 ,f2 ≤ 2nvK exp −c min γEYLf1 ,f2

1/vL

L⊆K

.

The required estimate for p ≥ n−1/mk (H)+c is now an easy consequence of this lemma.
Lemma 8.7. Let H be a strictly r-balanced r-uniform hypergraph and let S be the collection of labelled
(r)
ordered copies of H in the complete r-uniform hypergraph Kn . Then, for any positive constants α
and c, there exist constants b and B such that, if n is sufficiently large, C ≥ nc , and p = Cn−1/mr (H) ,
b
(r)
(r)
then, with probability at least 1 − 2nvH e−Bn , if U2 , . . . , Ue−1 are random subgraphs Gn,p of Kn with
associated measures µ2 , . . . , µe−1 ,
W (x, y) = Es∈S1(x)∩Se (y) µ2 (s2 ) . . . µe−1 (se−1 ) ≤ αp|K(x)|,
for all x, y ∈ X, where we have written e for eH .

47

Proof. Let χi be the characteristic function of Ui for each i ≤ eH . Let σ be the size of each nonempty set S1 (x) ∩ Se (y) and suppose |K(x)| = t for each x. Note that EYHe1 ,eH = peH −2 σ. We may
apply Lemma 8.6 with γ = αpt to tell us that s∈S1 (x)∩Se (y) χ2 (s2 ) . . . χe−1 (se−1 ) ≥ γpeH −2 σ with
probability at most
2nvH exp −c min γEYLe1 ,eH

1/vL

= 2nvH exp −c min γnvL −h peL −2

L⊆H

L⊆H

1/vL

,

where h is the size of e1 ∪ eH . Note that, as t is almost exactly nh−r , γnvL −h peL −2 ≥ (α/2)nvL −r peL −1 .
Since H is strictly r-balanced, for any proper subgraph L of H,
nvL −r peL −1 ≥

n

1−

vH −r
eH −1

eL −1
vL −r

vL −r

′

≥ nb .
b

Since also nvH −r peH −1 ≥ nǫ , the required bound holds with probability at least 1 − 2nvH e−Bn for
some constants B and b. Since
W (x, y) = σ −1 p−(eH −2)

χ2 (s2 ) . . . χe−1 (se−1 ),
s∈S1 (x)∩Se (y)

the result now follows for n suﬃciently large.

9

✷

Summary of our results so far

We are about to discuss several applications of our main results. In this brief section, we prepare for
these applications by stating the abstract results that follow from the work we have done so far. Since
not every problem one might wish to solve will give rise to a system of sequences S that either has
two degrees of freedom or concerns copies of a strictly balanced graph or hypergraph, we begin by
stating suﬃcient conditions on S for theorems of the kind we are interested in to hold. We have of
course already done this, but since some of our earlier conditions implied other ones, there is scope
for stating the abstract results more concisely. That way, any further applications of our methods will
be reduced to establishing two easily stated probabilistic estimates, and showing that suitable robust
versions of the desired results hold in the dense case.
Having done that, we remark that we have proved that the estimates hold when S has two degrees
of freedom or results from copies of a strictly balanced graph or hypergraph. So in these two cases, if
the robust results hold in the dense case, then we can carry them over unconditionally to the sparse
random case.
The proofs in this section require little more than the putting together of results from earlier in
the paper.

9.1

Conditional results

Recall that a system S of sequences s = (s1 , . . . , sk ) with values in a ﬁnite set X is homogeneous if
for every j ≤ k and every x ∈ X the set Sj (x) = {s ∈ S : sj = x} has the same size. Let S be a
homogeneous system of sequences with elements in a ﬁnite set X, and let us assume that no sequence
in S has repeated elements. We shall also assume that all non-empty sets of the form S1 (x) ∩ Sk (y)
48

have the same size. Coupled with our ﬁrst homogeneity assumption, this implies that for each x the
number of y such that S1 (x) ∩ Sk (y) is non-empty is the same.
We are about to state and prove a theorem that is similar to Theorem 4.5, but with conditions
that are easier to check and a conclusion that is more directly what we want to prove. The ﬁrst
condition is what we proved in Lemmas 7.2 and 7.4. We suppose that X is a given ﬁnite set, S is a
given homogeneous system of sequences with terms in X, and p0 is a given probability.
Condition 1. Let U1 , . . . , Uk be independent random subsets of X, each chosen binomially with probability p ≥ p0 , and let µ1 , . . . , µk be their associated measures. Let 1 ≤ j ≤ k and for each i = j let
νi equal either µi or the constant measure 1 on X, with at least one νi equal to the constant measure.
Then with probability at least 1 − o(|X|−k ),
∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(x) ≤ 3/2
for every x ∈ X.
Recall that if L is the set of i such that νi = µi , then ∗j (ν1 , . . . , νj−1 , νj+1 , . . . , νk )(x) is p−|L|
times the number of s ∈ Sj (x) such that si ∈ Ui for every i ∈ L. Since the expected number of such
sequences is p|L| |Sj (x)|, Condition 1 is saying that their number is not too much larger than its mean.
(One would usually expect a concentration result that said that their number is, with high probability,
close to its mean.)
The second condition tells us that the hypotheses of Lemma 8.4 hold. Again we shall take X, S
and p as given.
Condition 2. Let U2 , . . . , Uk−1 be independent random subsets of X, each chosen binomially with
probability p ≥ p0 , and let µ2 , . . . , µk−1 be their associated measures. Let α > 0 be an arbitrary
positive constant. For each x, let t be the number of y such that S1 (x) ∩ Sk (y) is non-empty. Then
with probability at least 1 − o(|X|−k ),
W (x, y) = Es∈S1 (x)∩Sk (y) µ2 (s2 ) . . . µk−1 (sk−1 ) ≤ αpt
for every x, y such that S1 (x) ∩ Sk (y) is non-empty.
This is not a concentration assumption. For instance, in the case of systems with two degrees of
freedom, it follows trivially from the fact that |S1 (x) ∩ Sk (y)| ≤ 1 and each µi (si ) is at most p−1 . In
more complicated cases, we end up wishing to prove that a certain integer-valued random variable
with mean n−c has a probability n−A of exceeding a large constant C.
We are now ready to state our main conditional results. Note that in all of these it is necessary to
assume that the probability q with which we choose our random set U is smaller than some positive
constant δ. For colouring theorems this is not a problem, because these properties are always monotone.
It is therefore enough to know that the property holds almost surely for a particular probability q to
know that it holds almost surely for all probabilities larger than q.
For density theorems, we can also overcome this diﬃculty by partitioning any random set with
large probability into a number of smaller random sets each chosen with probability less than δ. With
high probability, each of these smaller random sets will satisfy the required density theorem. If we
take a subset of the original set above a certain density, then this subset must have comparable density
within at least one of the sets of the partition. Applying the required density theorem within this set,
49

we can ﬁnd the required substructure, be it a k-term arithmetic progression or a complete graph of
order t.
Alternatively, if we know a (robust) sparse density theorem for a small value of p, we can deduce
it for a larger value q as follows. We can pick a random set V = Xp by ﬁrst choosing U = Xq and
then choosing V = Up/q . Since the result is true for almost every V = Xp , it will be the case that for
almost every U = Xq , almost every V = Up/q will satisfy the result. It follows by a simple averaging
argument that for almost every U = Xq the robust version of the density theorem holds again.
Unfortunately, for structural results, no simple argument of this variety seems to work and we will
have to deal with each case as it comes.
Theorem 9.1. Suppose that S, X and p0 satisfy Conditions 1 and 2. Suppose also that there exist
positive constants ρ and β such that for every subset B ⊂ X of density at least ρ there are at least β|S|
sequences s = (s1 , . . . , sk ) ∈ S such that si ∈ B for every i. Then, for any ǫ > 0, there exist positive
constants C and δ with the following property. Let U be a random subset of X, with elements chosen
independently with probability Cp0 ≤ q ≤ δ. Then, with probability 1 − o(1), every subset A of U of
density at least ρ + ǫ contains at least (β − ǫ)pk |S| sequences such that si ∈ A for every i.
Proof. Basically the result is true because Theorem 4.5 proves the conclusion conditional on the four
key properties set out before the statement of Theorem 4.5, and our probabilistic arguments in the
last few sections show that these properties follow from Conditions 1 and 2. Indeed, we would already
be done if it were not for one small extra detail: we need to deal with the fact that Theorem 4.5 has
a conclusion that concerns m random sets U1 , . . . , Um , whereas we want a conclusion that concerns a
single random set U .
Let η, λ, d and m be as required by Theorem 4.5. Condition 1 implies that property P2 holds with
probability 1 − o(|X|−k ). Lemma 8.4 tells us that property P1 holds with probability 1 − o(|X|−k )
provided that Conditions 1 and 2 hold, for some α that depends on η. Property P0 plainly holds with
high probability. Finally, Lemma 6.14 tells us that if properties P0, P1 and P2 hold with probability
1 − o(|X|−k ), then property P3 holds with probability 1 − o(1). Thus, with probability 1 − o(1), we
have all four properties.
It follows from Theorem 4.5 that if U1 , . . . , Um are independent random subsets of X, each chosen
binomially with probability p ≥ p0 , and µ1 , . . . , µm are their associated measures, then, with probability 1 − o(1), Es∈S h(s1 ) . . . h(sk ) ≥ β − ǫ whenever 0 ≤ h ≤ m−1 (µ1 + · · · + µm ) and h 1 ≥ ρ + 3ǫ/4.
Let U = U1 ∪ · · · ∪ Um . Then U is a random set with each element chosen independently with
probability q = 1 − (1 − p)m ≥ mp(1 − ǫ/8), provided δ (and hence p) is suﬃciently small. Let µ be
the associated measure of U , let 0 ≤ f ≤ µ and suppose that f 1 ≥ ρ + ǫ. Then replacing f by
the smaller function h = min{f, m−1 (µ1 + · · · + µm )} we have h 1 ≥ ρ + 3ǫ/4, which implies that
Es∈S h(s1 ) . . . h(sk ) ≥ β − ǫ, which in turn implies that Es∈S f (s1 ) . . . f (sk ) ≥ β − ǫ.
✷
Conditions 1 and 2 also imply an abstract colouring result and an abstract structural result in a
very similar way.
Theorem 9.2. Suppose that S, X and p0 satisfy Conditions 1 and 2. Suppose also that r is a positive
integer and β a positive constant such that for every colouring of X with r colours there are at least
β|S| sequences s = (s1 , . . . , sk ) ∈ S such that each si has the same colour. Then there exist positive
constants C and δ with the following property. Let U be a random subset of X, with elements chosen
independently with probability Cp0 ≤ q ≤ δ. Then, with probability 1 − o(1), every colouring of U with
50

r colours contains at least 2−(k+2) βpk |S| sequences s = (s1 , . . . , sk ) ∈ S such that each si has the same
colour and each si is an element of U .
The only further ingredient needed to prove this theorem is Theorem 4.8. Other than this, the
proof is much the same as that of Theorem 9.1.
Theorem 9.3. Suppose that S, X and p0 satisfy Conditions 1 and 2 and let V be a collection of 2o(p|X|)
subsets of X. Then, for any ǫ > 0, there exist positive constants C and δ with the following property.
Let U be a random subset of X, with elements chosen independently with probability Cp0 ≤ q ≤ δ, and
associated measure µ. Then, with probability 1 − o(1), for every function f : X → R with 0 ≤ f ≤ µ
there exists a function g : X → R with 0 ≤ g ≤ 1 such that
Es∈S f (s1 ) . . . f (sk ) ≥ Es∈S g(s1 ) . . . g(sk ) − ǫ
and, for all V ∈ V,
|

f (x) −
x∈V

g(x)| ≤ ǫ|X|.
x∈V

The main extra point to note here is that Conditions 1 and 2 imply not just property P3 but also
property P3′ . This allows us to apply Theorem 4.10.

9.2

The critical exponent

The aim of this paper has been to prove results that are, in terms of p, best possible to within a
constant. A preliminary task is to work out the probability below which we cannot hope to prove a
result. (For density problems, it is easy to prove that below this probability the result is not even true.
For natural colouring problems, it usually seems to be the case that the result is not true, but the
known proofs are far from trivial.) To within a constant, the probability in question is the probability
p such that the following holds: for each j ≤ k and each x ∈ X the expected number of elements s ∈ S
such that sj = x (that is, such that s ∈ Sj (x)), and si belongs to Xp for each i = j is equal to 1.
In concrete situations, X will be one of a family of sets of increasing size, and S will be one of a
corresponding family of sets of sequences. Then it is usually the case that the probability p calculated
above is within a constant of |X|−α for some rational number α that does not depend on which member
of the family one is talking about. In this situation, we shall call α the critical exponent for the family
of problems. Our results will then be valid for all p that exceed C|X|−α for some constant C. We shall
denote the critical exponent by αS , even though strictly speaking it depends not on an individual S
but on the entire family of sets of sequences.
To give an example, if S consists of all non-degenerate edge-labelled copies of K4 in Kn , then the
expected number of copies with a particular edge in a particular place, given that that edge belongs to
U , is 2(n − 2)(n − 3)p5 (since each Sj (e) has size 2(n − 2)(n − 3) and there are ﬁve edges that must be
chosen). Setting that equal to 1 tells us that p is within a constant of n−2/5 , so the critical exponent
is 2/5. (This is a special case of the formula 1/mk (K) = (vK − k)/(eK − 1).)
This calculation is exactly what we do in general: if each element of S is a sequence of length k
and we are given that x ∈ Xp , then the expected number of elements of Sj (x) that have all their terms
in Xp is pk−1 |Sj (x)|. This equals 1 when p = |Sj (x)|−1/(k−1) . If |Sj (x)| = C|X|θ for some θ that is
independent of the size of the problem, then the critical exponent is therefore θ/(k − 1).

51

If we can prove a robust density theorem for S, and can show that Conditions 1 and 2 hold when
p0 = C|X|−αS for some constant C, then we have proved a result that is best possible to within a
constant. For colouring theorems, we cannot be quite so sure that the result is best possible, but in
almost all examples where the 0-statement has been proved, it does indeed give a bound of the form
c|X|−αS .

9.3

Unconditional results

In this section we concentrate on the two kinds of sequence system for which we have proved that
Conditions 1 and 2 hold when p0 = C|X|−αS .
Recall that S has two degrees of freedom if Si (x) ∩ Sj (y) is either empty or a singleton whenever
i = j. A good example of such a system is the set of k-term arithmetic progressions in Zp for some
prime p. We say that S is a set of copies of a hypergraph if K is a k-uniform hypergraph with edges
(k)
a1 , . . . , ae , X is the complete k-uniform hypergraph Kn , and S is the set of all sequences of the form
(φ(a1 ), . . . , φ(ae )), where φ is an injection from the vertices of K to {1, 2, . . . , n}.
As above, we assume that S has the additional homogeneity property that S1 (x) ∩ Sk (y) always
has the same size when it is non-empty. (In the hypergraph case, e plays the role of k and k has a
diﬀerent meaning: thus, the property in that case is that S1 (x) ∩ Se (y) always has the same size when
it is non-empty.) And in the hypergraph case, we make the further assumption that the hypergraph K
is strictly balanced, which means that for every proper subhypergraph J ⊂ K we have the inequality
eK −1
eK −1
eJ −1
vJ −k < vK −k . When this happens, we write mk (K) as shorthand for vK −k .
Given a system S with two degrees of freedom, let t be the size of each Sj (x), and suppose that
t = |X|γ . Then the critical exponent of S is γ/(k − 1). (Note that |X|−αS = t−1/(k−1) .) When
S is a set of copies of a strictly balanced hypergraph K, the critical exponent is 1/mk (K). It is
straightforward to show that sparse density results cannot hold for random subsets of X chosen with
probability c|X|−αS if c is a suﬃciently small positive constant. Broadly speaking, we shall show
that they do hold for random subsets chosen with probability C|X|−αS when C is a suﬃciently large
positive constant.
Let us call a system S good if the above properties hold. That is, roughly speaking, a good system
is a system with certain homogeneity properties that either has two degrees of freedom or comes from
copies of a graph or hypergraph. We shall also assume that |X| is suﬃciently large. When we say
“there exists a constant C,” this should be understood to depend only on k in the case of systems of
two degrees of freedom, and only on K in the case of copies of a strictly balanced hypergraph, together
with parameters such as density or the number of colours in a colouring that have been previously
mentioned in the statement.
Theorem 9.4. Let X be a finite set and let S be a good system of ordered subsets of X. Suppose
that there exist positive constants ρ and β such that for every subset B ⊂ X of density at least ρ there
are at least β|S| sequences s = (s1 , . . . , sk ) ∈ S such that si ∈ B for every i. Then, for any ǫ > 0,
there exist positive constants C and δ with the following property. Let U be a random subset of X,
with elements chosen independently with probability C|X|−αS ≤ p ≤ δ. Then, with probability 1 − o(1),
every subset A of U of order at least (ρ + ǫ)|U | contains at least (β − ǫ)pk |S| sequences such that si ∈ A
for every i.
Proof. By Theorem 9.1, all we have to do is check Conditions 1 and 2. Condition 1 is given to us
by Lemma 7.2 when S has two degrees of freedom, and by Lemma 7.4 when S is a system of copies
52

of a graph or hypergraph, even when C = 1. (In the case where S has two degrees of freedom,
see the remarks following Lemma 7.2 for an explanation of why the result implies Condition 1 when
p = |X|−αS .)
When S has two degrees of freedom, Condition 2 holds as long as p−(k−2) ≤ αpt, as we have already
remarked. This tells us that p needs to be at least (αt)−1/(k−1) . In this case, t = |Sj (x)| for each x and
j, so (αt)−1/(k−1) is within a constant of |X|−αs , as required. When S comes from copies of a strictly
balanced graph or hypergraph, Lemmas 8.5 and 8.7 give us Condition 2, again with p = C|X|−αS . ✷
Exactly the same proof (except that we use Theorem 9.2 instead of Theorem 9.1) gives us the
following general sparse colouring theorem.
Theorem 9.5. Let X be a finite set and let S be a good system of ordered subsets of X. Suppose that r
is a positive integer and that β is a positive constant such that for every colouring of X with r colours
there are at least β|S| sequences s = (s1 , . . . , sk ) ∈ S such that each si has the same colour. Then
there exist positive constants C and δ with the following property. Let U be a random subset of X,
with elements chosen independently with probability C|X|−αS ≤ p ≤ δ. Then, with probability 1 − o(1),
every colouring of U with r colours contains at least 2−(k+2) βpk |S| sequences s = (s1 , . . . , sk ) ∈ S such
that each si has the same colour and each si is an element of U .
Finally, we have the following general sparse structural theorem.
Theorem 9.6. Let X be a finite set and let S be a good system of ordered subsets of X. Then, for any
ǫ > 0, there exist positive constants C and δ with the following property. Let U be a random subset
of X, with elements chosen independently with probability C|X|−αS ≤ p ≤ δ, let µ be the associated
measure of U and let V be a collection of 2o(p|X|) subsets of X. Then, with probability 1 − o(1), for
every function f with 0 ≤ f ≤ µ there exists a function g with 0 ≤ g ≤ 1 such that
Es∈S f (s1 ) . . . f (sk ) ≥ Es∈S g(s1 ) . . . g(sk ) − ǫ
and, for all V ∈ V,
|

f (x) −
x∈V

g(x)| ≤ ǫ|X|.
x∈V

In applications, we often want g to take values in {0, 1} rather than [0, 1]. This can be achieved
by a simple and standard modiﬁcation of the above result.
Corollary 9.7. Let X be a finite set and let S be a good system of ordered subsets of X. Then, for
any ǫ > 0, there exist positive constants C and δ with the following property. Let U be a random subset
of X, with elements chosen independently with probability C|X|−αS ≤ p ≤ δ, let µ be the associated
measure of U and let V be a collection of 2o(p|X|) subsets of X. Then, with probability 1 − o(1), for
every function f with 0 ≤ f ≤ µ there exists a function h taking values in {0, 1} such that
Es∈S f (s1 ) . . . f (sk ) ≥ Es∈S h(s1 ) . . . h(sk ) − ǫ
and, for all V ∈ V,
|

f (x) −
x∈V

h(x)| ≤ ǫ|X|.
x∈V

53

Proof. The basic idea of the argument is to choose a function g that satisﬁes the conclusion of Theorem
9.6 with ǫ replaced by ǫ/2, and to let h(x) = 1 with probability g(x) and 0 with probability 1−g(x), all
choices being made independently. Then concentration of measure tells us that with high probability
the estimates are not aﬀected very much.
Note ﬁrst that the expectation of Es∈S h(s1 ) . . . h(sk ) is Es∈S g(s1 ) . . . g(sk ). By how much can
changing the value of h(x) change the value of Es∈S h(s1 ) . . . h(sk )? Well, if x is one of s1 , . . . , sk then
h(s1 ) . . . h(sk ) can change by at most 1 and otherwise it does not change. The probability that x is one
of s1 , . . . , sk is k/|X|, by the homogeneity of S (which tells us that each sj is uniformly distributed). By
Azuma’s inequality, it follows that the probability that |Es∈S g(s1 ) . . . g(sk )−Es∈S h(s1 ) . . . h(sk )| ≥ ǫ/2
is at most 2 exp(−ǫ2 |X|/8k2 ). This gives us the ﬁrst conclusion with very high probability.
The second is obtained in a similar way. For each V ∈ V the probability that | x∈V h(x) −
2
o(p|X|) sets
x∈V g(x)| ≥ ǫ|X|/2 is, by Azuma’s inequality, at most 2 exp(−ǫ |X|/8). Since there are 2
in V, a union bound gives the second conclusion with very high probability as well.
✷

10
10.1

Applications
Density results

As a ﬁrst example, let us prove Theorem 1.12, the sparse analogue of Szemer´edi’s theorem. We shall
consider Szemer´edi’s theorem as a statement about arithmetic progressions mod p in dense subsets of
Zp for a prime p. We do this because the set of k-term arithmetic progressions in Zp is a homogeneous
system with two degrees of freedom. However, once we have the result for this version of Szemer´edi’s
theorem, we can easily deduce it for the more conventional version concerning a sparse random subset
of [n]. We simply choose a prime p between 2n and 4n, pick a sparse random subset U of Zp , and then
apply the result to subsets of U that happen to be subsets of {1, 2, . . . , n}, since arithmetic progressions
in these subsets will not wrap around. Similar arguments allow us to replace [n] by Zp for our later
applications, so we mention once and for all now that for each application it is easy to deduce from
the result we state a result for sparse subsets of intervals (or grids in the multidimensional case).
Since we wish to use the letter p to denote a probability, we shall now let n be a large prime.
By Theorem 9.1, all we have to do is check the robust version of Szemer´edi’s theorem, which can
be proved by a simple averaging argument, originally observed by Varnavides [64] (who stated it for
3-term progressions).
Theorem 10.1. Let k be an integer and δ > 0 a real number. Then there exists an integer n0 and
c > 0 such that if n is a prime greater than or equal to n0 and B is a subset of Zn with |B| ≥ δn then
B contains at least cn2 k-term arithmetic progressions.
Proof. Let m be such that every subset of {1, 2, . . . , m} of density δ/2 contains a k-term arithmetic
progression. Now let B be a subset of Zn of density δ. For each a and d with d = 0, let Pa,d be
the mod-n arithmetic progression {a, a + d, . . . , a + (m − 1)d}. If we choose Pa,d at random, then the
expected density of B inside Pa,d is δ, so with probability at least δ/2 it is at least δ/2. It follows with
probability at least δ/2 that Pa,d contains an arithmetic progression that is contained in B. Since Pa,d
contains at most m(m − 1) k-term arithmetic progressions, it follows that with probability at least
δ/2 at least 1/m(m − 1) of the k-term progressions inside Pa,d are contained in B. But every k-term

54

arithmetic progression is contained in the same number of progressions Pa,d . Therefore, the number
n(n−1)
n2
≥ 2δ m
✷
of progressions in B is at least 2δ m(m−1)
2.
Very similar averaging arguments are used to prove the other robust density results we shall need
in this subsection, so we shall be sketchy about the proofs and sometimes omit them altogether.
The next result is the sparse version of Szemer´edi’s theorem. Recall that we write Xp for a random
subset of X where each element is chosen independently with probability p, and we say that a set
I is (δ, k)-Szemer´edi if every subset of I with cardinality at least δ|I| contains a k-term arithmetic
progression.
Theorem 10.2. Given δ > 0 and a natural number k ≥ 3, there exists a constant C such that if
p ≥ Cn−1/(k−1) , then the probability that (Zn )p is (δ, k)-Szemer´edi is 1 − o(1).
Proof. In the case where p is not too large, this follows immediately from Theorems 9.4 and 10.1.
The result for larger probabilities can be deduced by using the argument given before Theorem 9.1.
Alternatively, note that a subset of relative density δ within a subset of [n]p has density δp in [n]. So
if p is larger than a ﬁxed constant λ (as it will be in the case not already covered by Theorem 9.4),
we can just apply Szemer´edi’s theorem itself.
✷
A simple corollary of Theorem 10.2 is a sparse analogue of van der Waerden’s theorem [63] on
arithmetic progressions in r-colourings of [n]. Note that this theorem was proved much earlier by R¨
odl
and Ruci´
nski [47] and is known to be tight.
Let us now prove sparse versions of two generalizations of Szemer´edi’s theorem. The ﬁrst generalization is the multidimensional Szemer´edi theorem, due to Furstenberg and Katznelson [15]. We shall
state it in its robust form, which is in fact the statement that Furstenberg and Katznelson directly
prove. (It also follows from the non-robust version by means of an averaging argument.)
Theorem 10.3. Let r be a positive integer and δ > 0 a real number. If P ⊂ Zr is a fixed set, then
there is a positive integer n0 and a constant c > 0 such that, for n ≥ n0 , every subset B of the grid [n]r
with |B| ≥ δnr contains cnr+1 subsets of the form a + dP , where a ∈ [n]r and d is a positive integer.
Just as with Szemer´edi’s theorem, this statement is equivalent to the same statement for subsets
of Zrn . So let P be a subset of Zr and let (x1 , . . . , xk ) be an ordering of the elements of P . Let S be
the set of sequences of the form sa,d = (a + x1 d, . . . , a + xk d) with d = 0. Then S is homogeneous
and has two degrees of freedom. Moreover, if n is large enough, then no two elements of sa,d are the
same. From the conclusion of Theorem 10.3 it follows that there are at least c|S| sequences in S with
all their terms in B. We have therefore checked all the conditions for Theorem 9.4, so we have the
following sparse version of the multidimensional Szemer´edi theorem. (As before, the result for larger
p follows easily from the result for smaller p.) We deﬁne a subset I of Zrn to be (δ, P )-Szemer´edi if
every subset of I with cardinality at least δ|I| contains a homothetic copy a + dP of P .
Theorem 10.4. Given integers r and k, a real number δ > 0 and a subset P ⊂ Zr of order k, there
exists a constant C such that if p ≥ Cn−1/(k−1) , then the probability that (Zrn )p is (δ, P )-Szemer´edi is
1 − o(1).
The second generalization of Szemer´edi’s theorem we wish to look at is the polynomial Szemer´edi
theorem of Bergelson and Leibman [2]. Their result is the following.
55

Theorem 10.5. Let δ > 0 be a real number, let k be a positive integer and let P1 , . . . , Pk be polynomials
with integer coefficients that vanish at zero. Then there exists an integer n0 such that if n ≥ n0 and
B is a subset of [n] with |B| ≥ δn then B has a subset of the form {a, a + P1 (d), . . . , a + Pk (d)}.
We will focus on the speciﬁc case where the polynomials are xr , 2xr , . . . , (k − 1)xr (so k has been
replaced by k − 1). In this case, the theorem tells us that we can ﬁnd a k-term arithmetic progression
with common diﬀerence that is a perfect rth power. We restrict to this case, because it is much easier
to state and prove an appropriate robust version for this case than it is for the general case.
Note that if a, a + dr , · · · , a + (k − 1)dr ∈ [n], then d ≤ (n/k)1/r . This observation and another easy
averaging argument enable us to replace Theorem 10.5 by the following equivalent robust statement
about subsets of Zn (see, for example, [25]).
Corollary 10.6. Let k, r be integers and δ > 0 a real number. Then there exists an integer n0 and
a constant c > 0 such that if n ≥ n0 and B is a subset of Zn with |B| ≥ δn then B contains at least
cn1+1/r pairs (a, d) such that a, a + dr , · · · , a + (k − 1)dr ∈ B and d ≤ (n/k)1/r .
Let us say that a subset I of Zn is (δ, k, r)-Szemer´edi if every subset of I with cardinality at least
δ|I| contains a k-term progression of the form a, a + dr , . . . , a + (k − 1)dr with d ≤ (n/k)1/r .
Theorem 10.7. Let k, r be integers and δ > 0 a real number. Then there exists a constant C such
that if p ≥ Cn−1/(k−1)r , then the probability that (Zn )p is (δ, k, r)-Szemer´edi is 1 − o(1).
Proof. Let X = Zn and S be the collection of progressions of the form a, a + dr , . . . , a + (k − 1)dr
with d ≤ (n/k)1/r . Because of this restriction on d, S has two degrees of freedom. It is also obviously
homogeneous. The size of each Sj (x) is n1/r to within a constant, so the critical exponent is γ/(k − 1)
with γ = 1/r. Therefore, provided p is at most some constant λ, the result follows from Theorem 9.4
and Corollary 10.6. For p larger than λ, the result follows from the polynomial Szemer´edi theorem
itself.
✷
Note that the particular case of this theorem when k = 2 was already proved by Nguyen [41]. To see
that this result is sharp, note that the number of k-term progressions with rth power diﬀerence in the
random set is roughly pk n1+1/r . This is smaller than the number of vertices pn when p = n−1/(k−1)r .
We will now move on to proving sparse versions of Tur´
an’s theorem for strictly k-balanced kuniform hypergraphs. As we mentioned in the introduction, some of the dense results are not known,
but this does not matter to us, since our aim is simply to show that whatever results can be proved
in the dense case carry over to the sparse random case when the probability exceeds the critical
probability.
(k)
For a k-uniform hypergraph K, let ex(n, K) denote the largest number of edges a subgraph of Kn
can have without containing a copy of K. As usual, we need a robust result that says that once a
graph has more edges than the extremal number for K, by a constant proportion of the total number
(k)
of edges in Kn , then it must contain many copies of K. The earliest version of such a supersaturation
result was proved by Erd˝os and Simonovits [8]. The proof is another easy averaging argument along
the lines of the proof of Theorem 10.1.
Theorem 10.8. Let K be a k-uniform hypergraph. Then, for any ǫ > 0, there exists δ > 0 such that
if L is a k-uniform hypergraph on n vertices and
e(L) > ex(n, K) + ǫnk ,
56

then L contains at least δnvK copies of K.
Let πk (K) be the limit as n tends to inﬁnity of ex(n, K)/ nk . We will say that a k-uniform
hypergraph H is (K, ǫ)-Tur´
an if any subset of the edges of H of size
(πk (K) + ǫ)e(H)
(k)

contains a copy of K. Recall that Gn,p is a random k-uniform hypergraph on n vertices, where each
edge is chosen with probability p, and when K is strictly k-balanced mk (K) = (eK − 1)/(vK − k).
Theorem 10.9. For every ǫ > 0 and every strictly k-balanced k-uniform hypergraph K, there exists
(k)
a constant C such that if p ≥ Cn−1/mk (K) , then the probability that Gn,p is (K, ǫ)-Tur´
an is 1 − o(1).
Proof. For p smaller than a ﬁxed constant λ, the result follows immediately from Theorems 9.4 and
10.8. For p ≥ λ, we may apply the argument discussed before Theorem 9.1. That is, we may partition
(k)
Gn,p into a small set of random graphs, each of which has density less than λ and each of which is
(k)
+ ǫ, then this subgraph
(K, ǫ)-Tur´
an. If now we have a subgraph of Gn,p of density at least ex(n,K)
(nk)
must have at least this density in one of the graphs from the partition. Applying the fact that this
subgraph is (K, ǫ)-Tur´
an implies the result.
✷
In particular, this implies Theorem 1.10, which is the particular case of this theorem where K is
1
+ o(1) n2 , where χ(K) is the
a strictly balanced graph. Then ex(n, K) is known to be 1 − χ(K)−1
chromatic number of K.

10.2

Colouring results

We shall now move on to colouring results that do not follow from their corresponding density versions.
Let us begin with Ramsey’s theorem. As ever, the main thing we need to check is that a suitable
robust version of the theorem holds. And indeed it does: it is a very simple consequence of Ramsey’s
theorem that was noted by Erd˝os [7].
Theorem 10.10. Let H be a hypergraph and let r be a positive integer. Then there exists an integer
(k)
n0 and a constant c > 0 such that, if n ≥ n0 , any colouring of the edges of Kn with r colours is
guaranteed to contain cnvH monochromatic copies of H.
(k)

Once again the proof is the obvious averaging argument: choose m such that if the edges of Km
are coloured with r colours, there must be a monochromatic copy of H, and then a double count shows
(k)
that for every r-colouring of the edges of Kn there are at least vnH / vmH monochromatic copies of H.
Recall that, given a k-uniform hypergraph K and a natural number r, a hypergraph is (K, r)Ramsey if every r-colouring of its edges contains a monochromatic copy of K. We are now ready to
prove Theorem 1.9, which for convenience we restate here.
Theorem 10.11. Given a natural number r and a strictly k-balanced k-uniform hypergraph K, there
(k)
exists a positive constant C such that if p ≥ Cn−1/mk (K) , then the probability that Gn,p is (K, r)Ramsey is 1 − o(1).

57

Proof. For a suﬃciently large constant C, the result for p = Cn−1/mk (K) follows from Theorems 9.5
and 10.10. For q > p, the result follows from the monotonicity of the Ramsey property. To see this,
(k)
choose a random hypergraph Gn,q and then choose a subhypergraph by randomly selecting each edge
(k)
(k)
of Gn,q with probability p/q. The resulting hypergraph is distributed as Gn,p , so with probability
(k)
(k)
1 − o(1) it is (K, r)-Ramsey. But then any r-colouring of Gn,q will yield an r-colouring of this Gn,p ,
which always contains a monochromatic copy of K.
✷
With only slightly more eﬀort we can obtain a robust conclusion. Theorem 9.5 tells us that with
(k)
high probability the number of monochromatic copies of K in any r-colouring of Gn,p is cpeK nvK for
some constant c > 0, and then an averaging argument implies that with high probability the number
(k)
of monochromatic copies in an r-colouring of Gn,q is cq eK nvK .
We shall now take a look at Schur’s theorem [56], which states that if the set {1, . . . , n} is rcoloured, then there exist monochromatic subsets of the form {x, y, x + y}. As with our results
concerning Szemer´edi’s theorem, it is more convenient to work in Zn . To see that this implies the
equivalent theorem in [n], let [n]p be a random subset of [n] made from the union of two smaller
random subsets, each chosen with probability q such that p = 2q − q 2 . Call these sets U1 and U2 .
Then the subset of Z2n formed by placing the set U1 in the position {1, . . . , n} and the set −U2 in the
set {−1, . . . , −n} (the overlap n = −n is irrelevant to the argument, since it is unlikely to be in the
set) will produce a random subset of Z2n where each element is chosen with probability q. If a sparse
version of Schur’s theorem holds in Z2n , then with high probability, any 2r-colouring of this random
set yields cq 3 n2 monochromatic sets {x, y, x + y} for some constant c > 0.
Consider now an r-colouring of the original set U1 ∪ U2 in r colours C1 , . . . , Cr . This induces a
colouring of U1 ∪ −U2 ⊂ Z2n with 2r colours C1 , . . . , C2r : if x ∈ U1 and is coloured with colour Ci
in [n], then we continue to colour it with colour Ci , whereas if x ∈ −U2 and −x has colour Ci in [n],
then we colour it with colour Ci+r . We have already noted that this colouring must contain many
monochromatic sets {x, y, x+y}, and each one corresponds to a monochromatic set (either {x, y, x+y}
or {−x, −y, −(x + y)}) in the original colouring.
The robust version of Schur’s theorem can be deduced from one of the standard proofs, which itself
relies on Ramsey’s theorem for triangles and many colours.
Theorem 10.12. Let r be a positive integer. Then there exists an integer n0 and a constant c such
that, if n ≥ n0 , any r-colouring of {1, . . . , n} contains at least cn2 monochromatic triples of the form
{x, y, x + y}.
We shall say that a subset I of the integers is r-Schur if for every r-colouring of the points of I
there is a monochromatic triple of the form {x, y, x + y}. The r = 2 case of the following theorem was
already known: it is a result of Graham, R¨
odl and Ruci´
nski [23].
Theorem 10.13. For every positive integer r there exists a constant C such that if p ≥ Cn−1/2 , then
the probability that (Zn )p is r-Schur is 1 − o(1).
Proof. Let X = Zn \{0} and S be the collection of subsets of X of the form {x, y, x+y} with all of x, y
and x+y distinct. Since any two of x, y and x+y determine the third, it follows that |Si (a)∩Sj (b)| ≤ 1
whenever i, j ∈ {1, 2, 3}, i = j, and a, b ∈ X. Therefore, S has two degrees of freedom. Furthermore,
each Si (a) has size n − 3. By Theorem 10.12, there exists a constant c such that, for n suﬃciently
large, any r-colouring of Zn contains at least cn2 monochromatic subsets of the form {x, y, x + y}.
58

Applying Theorem 9.5, we see that there exist positive constants C and c′ such that, with probability
1 − o(1) a random subset U of Zn chosen with probability p = Cn−1/2 satisﬁes the condition that, in
any r-colouring of U , there are at least c′ p3 n2 monochromatic subsets of the form {x, y, x + y}. In
particular, U is r-Schur. Once again, the result for larger probabilities follows easily.
✷
As we mentioned in the introduction, it is quite a bit harder to prove 0-statements for colouring
statements than it is for density statements. However, 0-statements for partition regular systems have
been considered in depth by R¨
odl and Ruci´
nski [48], and their result implies that Theorem 10.13 is
sharp.
A far-reaching generalization of Schur’s theorem was proved by Rado [42]. It is likely that our
methods could be used to prove other cases of Rado’s theorem, but we have not tried to do so here,
since we would have to impose a condition on the conﬁgurations analogous to the strictly balanced
condition for graphs and hypergraphs.

10.3

The hypergraph removal lemma

Rather than jumping straight into studying hypergraphs, we shall begin by stating a slight strengthening of the triangle removal lemma for graphs. This strengthening follows from its proof via Szemer´edi’s
regularity lemma and gives us something like the “robust” version we need in order to use our methods
to obtain a sparse result. If G is a graph and X and Y are sets of vertices, we shall write G(X, Y ) for
the set of edges that join a vertex in X to a vertex in Y , e(X, Y ) for the cardinality of G(X, Y ) and
d(X, Y ) for e(X, Y )/|X||Y |.
Theorem 10.14. For every a > 0 there exists a constant K with the following property. For every
graph G with n vertices, there is a partition of the vertices of G into k ≤ K sets V1 , . . . , Vk , each of
size either ⌊n/k⌋ or ⌈n/k⌉, and a set E of edges of G with the following properties.
1. The number of edges in E is at most an2 .
2. E is a union of sets of the form G(Vi , Vj ).
3. E includes all edges that join a vertex in Vi to another vertex in the same Vi .
4. Let G′ be G with the edges in E removed. For any h, i, j, if there are edges in all of G′ (Vh , Vi ),
G′ (Vi , Vj ) and G′ (Vh , Vj ), then the number of triangles xyz with x ∈ Vh , y ∈ Vi and z ∈ Vj is at
least a3 |Vh ||Vi ||Vj |/128.
In particular, this tells us that after we remove just a few edges we obtain a graph that contains
either no triangles or many triangles. Let us brieﬂy recall the usual statement of the dense triangle
removal lemma and see how it follows from Theorem 10.14.
Corollary 10.15. For every a > 0 there exists a constant c > 0 with the following property. For every
graph G with n vertices and at most cn3 triangles it is possible to remove at most an2 edges from G
in such a way that the resulting graph contains no triangles.
Proof. Apply Theorem 10.14 to a and let c = a3 /200K 3 . Now let G be a graph with n vertices. Let
V1 , . . . , Vk and E be as given by Theorem 10.14 and remove from G all edges in E. If we do this, then
by Condition 1 we remove at most an2 edges from G. If there were any triangle left in G, then by
59

Condition 4 there would have to be at least a3 ⌊n/k⌋3 /128 > cn3 triangles left in G, a contradiction.
This implies the result.
✷
Here now is a sketch of how to deduce a sparse triangle removal lemma from Theorem 10.14.
We begin by proving a sparse version of Theorem 10.14 itself. Given a random graph U with edge
probability p ≥ Cn−1/2 , for suﬃciently large C, let H be a subgraph of U . Now use Corollary 9.7 to
ﬁnd a dense graph G such that the triangle density of G is roughly the same as the relative triangle
density of H in U (that is, if H has αp3 n3 triangles, then G has roughly αn3 triangles) and such that
for every pair of reasonably large sets X, Y of vertices the density dG (X, Y ) is roughly the same as
the relative density of H inside U (X, Y ) (that is, the number of edges of G(X, Y ) is roughly p−1 times
the number of edges of H(X, Y )).
Now use Theorem 10.14 to ﬁnd a partition of the vertex set of G (which is also the vertex set of
H) into sets V1 , . . . , Vk and to identify a set EG of edges to remove from G. By Condition 2, EG is
a union of sets of the form G(Vi , Vj ). Deﬁne EH to be the union of the corresponding sets H(Vi , Vj )
and remove all edges in EH from H. If it happens that G(Vi , Vj ) is empty, then adopt the convention
that we remove all edges from H(Vi , Vj ). Note that because the relative densities in dense complete
bipartite graphs are roughly the same, the number of edges in EH is at most 2apn2 . Let G′ be G with
the edges in EG removed and let H ′ be H with the edges in EH removed.
Suppose now that H ′ contains a triangle xyz and suppose that x ∈ Vh , y ∈ Vi and z ∈ Vj . Then
none of G′ (Vh , Vi ), G′ (Vi , Vj ) and G′ (Vh , Vj ) is empty, by our convention above, so Condition 4 implies
that G′ contains at least a3 |Vh ||Vi ||Vj |/128 triangles with x ∈ Vh , y ∈ Vi and z ∈ Vj . Since triangle
densities are roughly the same, it follows that H ′ contains at least a3 p3 |Vh ||Vi ||Vj |/256 triangles.
Roughly speaking, what this tells us is that Theorem 10.14 transfers to a sparse random version.
From that it is easy to deduce a sparse random version of Corollary 10.15. However, instead of giving
the full details of this, we shall prove (in a very similar way) a more general theorem, namely a sparse
random version of the simplex removal lemma for hypergraphs, usually known just as the hypergraph
removal lemma.
The dense result is due to Nagle, R¨
odl, Schacht and Skokan [40, 51], and independently to the
second author [21]. A gentle introduction to the hypergraph removal lemma that focuses on the case
of 3-uniform hypergraphs can be found in [20]. The result is as follows.
Theorem 10.16. For every δ > 0 and every integer k ≥ 2, there exists a constant ǫ > 0 such that, if
(k)
(k)
G is a k-uniform hypergraph containing at most ǫnk+1 copies of Kk+1 , it may be made Kk+1 -free by
removing at most δnk edges.
(k)

A simplex is a copy of Kk+1 . As in the case of graphs, where simplices are triangles, it will be
necessary to state a rather more precise and robust result. This is slightly more complicated to do
than it was for graphs. However, it is much less complicated than it might be: it turns out not to be
necessary to understand the statement of the regularity lemma for hypergraphs.
Let us make the following deﬁnition. Let H be a k-uniform hypergraph, and let J1 , . . . , Jk be
disjoint (k − 1)-uniform hypergraphs with the same vertex set as H. We shall deﬁne H(J1 , . . . , Jk )
to be the set of all edges A = {a1 , . . . , ak } ∈ H such that {a1 , . . . , ai−1 , ai+1 , . . . , ak } ∈ Ji for every i.
(Note that if k = 2 then the sets J1 and J2 are sets of vertices, so we are obtaining the sets G(X, Y )
deﬁned earlier.)
Now suppose that we have a simplex in H with vertex set (x1 , . . . , xk+1 ). For every subset
{u, v} of [k + 1] of size 2, let us write Juv for the (unique) set Ji that contains the (k − 1)-set
60

{xj : j ∈
/ {u, v}}. Then for each u the set H(Ju1 , . . . , Ju,u−1 , Ju,u+1 , . . . , Ju,k+1 ) is non-empty. We
make this remark in order to make the statement of the next theorem slightly less mysterious. It
is an analogue for k-uniform hypergraphs of Theorem 10.14. For convenience, we shall abbreviate
H(Ju1 , . . . , Ju,u−1 , Ju,u+1 , . . . , Ju,k+1 ) by H(Juv : v ∈ [k + 1], v = u). (It might seem unnecessary to
write “v ∈ [k + 1]” every time. We do so to emphasize the asymmetry: the set depends on u, while v
is a dummy variable.)
Theorem 10.17. For every a > 0 there exists a constant K with the following property. For every
[n]
k-uniform hypergraph H with vertex set [n], there is a partition of k−1
into at most K subsets
J1 , . . . , Jm , with sizes differing by a factor of at most 2, and a set E of edges of H with the following
properties.
1. The number of edges in E is at most ank .
2. E is a union of sets of the form H(Ji1 , . . . , Jik ).
3. E includes all edges in any set H(Ji1 , . . . , Jik ) for which two of the ih are equal.
4. Let H ′ be H with the edges in E removed. Suppose that for each pair of unequal integers u, v ∈
[k + 1] there is a set Juv from the partition such that the hypergraphs H ′ (Juv : v ∈ [k + 1], v = u)
are all non-empty. Then the number of simplices with vertices (x1 , . . . , xk+1 ) such that the edge
(x1 , . . . , xu−1 , xu+1 , . . . , xk+1 ) belongs to H ′ (Juv : v ∈ [k + 1], v = u) for every u is at least
(1/2)(a/4)k+1 cK nk+1 , where cK is a constant that depends on K (and hence on a).
Let us now convert this result into a sparse version.
Theorem 10.18. For every a > 0 there exist constants C, K and δ with the following property. Let
U be a random k-uniform hypergraph with vertex set [n], and with each edge chosen independently
with probability Cn−1/k ≤ p ≤ δ. Then with probability 1 − o(1) the following result holds. For every
[n]
k-uniform hypergraph F ⊂ U , there is a partition of k−1
into at most K subsets J1 , . . . , Jm , with
sizes differing by a factor of at most 2, and a set EF of edges of F with the following properties.
1. The number of edges in EF is at most apnk .
2. EF is a union of sets of the form F (Ji1 , . . . , Jik ).
3. EF includes all edges in any set F (Ji1 , . . . , Jik ) for which two of the ih are equal.
4. Let F ′ be F with the edges in EF removed. Suppose that for each pair of unequal integers u, v ∈
[k + 1] there is a set Juv from the partition such that the hypergraphs F ′ (Juv : v ∈ [k + 1], v = u)
are all non-empty. Then the number of simplices with vertices (x1 , . . . , xk+1 ) such that the edge
(x1 , . . . , xu−1 , xu+1 , . . . , xk+1 ) belongs to F ′ (Juv : v ∈ [k + 1], v = u) for every u is at least
(1/4)(a/8)k+1 cK pk+1 nk+1 , where cK is a constant that depends on K.
Proof. We have essentially seen the argument in the case of graphs. To start with, let us apply
Corollary 9.7 with S as the set of labelled simplices, f as p−1 times the characteristic function of F ,
(k)
V as the collection of all sets of the form Kn (J1 , . . . , Jk ) where each Ji is a collection of sets of size
k − 1 (that is, the set of ordered sequences of length k in [n] such that removing the ith vertex gives

61

you an element of Ji ), and ǫ = (1/4)(a/8)k+1 cK , where K and cK come from applying Theorem 10.17
with a/2 rather than a. With this choice, ǫ will also be less than a/2K k .
k−1
Note that αS = 1/k in this case, and that the cardinality of V is at most 2kn , so the corollary
applies. From that we obtain a hypergraph H (with characteristic function equal to the function h
provided by the corollary) such that p−(k+1) times the number of simplices in F is at least the number
of simplices in H minus ǫnk+1 , and such that the number of edges in H(J1 , . . . , Jk ) diﬀers from p−1
times the number of edges in F (J1 , . . . , Jk ) by at most ǫnk for every (J1 , . . . , Jk ).
We now apply Theorem 10.17 to H with a replaced by a/2. Let EH be the set of edges that we
obtain and let H ′ be H with the edges in EH removed.
[n]
Let J1 , . . . , Jm be the sets that partition k−1
, and remove all edges from F that belong to a set
F (Ji1 , . . . , Jik ) such that the edges of H(Ji1 , . . . , Jik ) belong to EH (including when H(Ji1 , . . . , Jik ) is
empty). Let EF be the set of removed edges and let F ′ be F after the edges are removed.
Since m ≤ K, there are at most K k k-tuples (Ji1 , . . . , Jik ). For each such k-tuple the number
of edges in H(Ji1 , . . . , Jik ) diﬀers from p−1 times the number of edges in F (Ji1 , . . . , Jik ) by at most
ǫnk . Therefore, since EH and EF are unions of sets of the form H(Ji1 , . . . , Jik ) and F (Ji1 , . . . , Jik ),
respectively, and since |EH | ≤ ank /2, it follows that |EF | ≤ (a/2 + ǫK k )pnk ≤ apnk . This gives us
Condition 1. Conditions 2 and 3 are trivial from the way we constructed EF . So it remains to prove
Condition 4.
Suppose, then, that for all u, v ∈ [k + 1] there is a set Juv such that there are edges in all of the
hypergraphs F ′ (Juv : v ∈ [k + 1], v = u) for u = 1, 2, . . . , k + 1. Then there must be edges in all the
hypergraphs H ′ (Juv : v ∈ [k + 1], v = u) as well, or we would have removed the corresponding sets of
edges from F . By Condition 4 of the dense result applied to H, it follows that H ′ contains at least
(1/2)(a/8)k+1 cK nk+1 simplices, which implies that H does as well, which implies that F contains at
least ((1/2)(a/8)k+1 cK − ǫ)pk+1 nk+1 simplices, which gives us the bound stated.
✷
Now let us deduce the simplex removal lemma. This is just as straightforward as it was for graphs.
Corollary 10.19. For every a > 0 there exist constants C and c > 0 with the following property.
Let U be a random k-uniform hypergraph with vertex set [n], and with each edge chosen independently
with probability p ≥ Cn−1/k . Then with probability 1 − o(1) the following result holds. Let F be a
subhypergraph of U that contains at most cpk+1 nk+1 simplices. Then it is possible to remove at most
apnk edges from F and make it simplex free.
Proof. Let c = (1/8)(a/8)k+1 cK , where cK is the constant given by Theorem 10.18, and apply that
theorem to obtain a set EF , which we shall take as our set E. Then E contains at most apnk edges,
so it remains to prove that when we remove the edges in E from F we obtain a hypergraph F ′ with
no simplices.
Suppose we did have a simplex in F ′ . Let its vertex set be {x1 , . . . , xk+1 }. For each {u, v} ⊂ [k + 1]
of size 2, let Juv be the set from the partition given by Theorem 10.18 that contains the (k − 1)-set
{xi : i ∈
/ {u, v}}. Then, as we commented before the statement of Theorem 10.17 (though then we
were talking about H), for each u the set F ′ (Juv : v ∈ [k + 1], v = u) is non-empty. Therefore, by
Theorem 10.18, F ′ , and hence F , contains at least (1/4)(a/8)k+1 cK pk+1 nk+1 simplices. By our choice
of c, this is a contradiction.
This argument works for Cn−1/k ≤ p ≤ δ. However, since δ is a constant, we may, for p > δ,
simply apply the hypergraph removal lemma itself to remove all simplices.
✷
62

10.4

The stability theorem

As a ﬁnal application we will discuss the stability version of Tur´
an’s theorem, Theorem 1.11. The
original stability theorem, due to Simonovits [57], is the following.
Theorem 10.20. For every δ > 0 and every graph H with χ(H) ≥ 3, there exists an ǫ > 0 such that
1
any H-free graph with at least 1 − χ(H)−1
− ǫ n2 edges may be made (χ(H)− 1)-partite by removing
at most δn2 edges.
Unfortunately, this is not quite enough for our purposes. We would like to be able to say that a
graph that does not contain too many copies of H may be made (χ(H) − 1)-partite by the deletion of
few edges. To prove this, we appeal to the following generalization of the triangle removal lemma.
Theorem 10.21. For every δ > 0 and every graph H, there exists a constant ǫ > 0 such that, if G
is a graph containing at most ǫnvH copies of H, then it may be made H-free by removing at most δn2
edges.
Combining the two previous theorems gives us the robust statement we shall need.
Theorem 10.22. For every δ > 0 and every graph H with χ(H) ≥ 3, there exists a constant ǫ such
1
− ǫ n2 edges may be made
that any graph with at most ǫnvH copies of H and at least 1 − χ(H)−1
(χ(H) − 1)-partite by removing at most δn2 edges.
To prove Theorem 1.11, the statement of which we now repeat, we will follow the procedure
described at the end of Section 3.
Theorem 10.23. Given a strictly 2-balanced graph H with χ(H) ≥ 3 and a constant δ > 0, there exist
positive constants C and ǫ such that in the random graph Gn,p chosen with probability p ≥ Cn−1/m2 (H) ,
where m2 (H) = (eH −1)/(vH −2), the following holds with probability tending to 1 as n tends to infinity.
1
− ǫ p n2 edges may be made (χ(H)−1)-partite
Every H-free subgraph of Gn,p with at least 1 − χ(H)−1
by removing at most δpn2 edges.
Proof. Fix δ > 0. An application of Theorem 10.22 gives us ǫ > 0 such that any graph with at
1
− 2ǫ n2 edges may be made (χ(H) − 1)-partite by
most ǫnvH copies of H and at least 1 − χ(H)−1
removing at most δn2 /2 edges.
Let t = χ(H)−1. Apply Corollary 9.7 with S the set of all labelled copies of H in Kn and V the set
of all vertex subsets of {1, . . . , n}. This yields constants C and λ such that, for Cn−1/m2 (H) ≤ p ≤ λ,
the following holds with probability tending to 1 as n tends to inﬁnity. Let G be a random graph where
each edge is chosen with probability p. Let µ be its characteristic measure. Then, if f is a function with
0 ≤ f ≤ µ, there exists a {0, 1}-valued function j such that Es∈S f (s1 ) . . . f (se ) ≥ Es∈S j(s1 ) · · · j(se )−ǫ
and, for all V ∈ V, |Ex∈V f (x) − Ex∈V j(x)| ≤ η |X|
|V | , where η = min(ǫ, δ/2t).
1
Let A be a H-free subgraph of G with 1 − χ(H)−1
− ǫ p n2 edges and let 0 ≤ f ≤ µ be p−1
times its characteristic function. Apply the transference principle to ﬁnd the function j, which is the
characteristic measure of a graph J. The number of copies of H in J is at most ǫnvH . Otherwise, we
would have
Es∈S f (s1 ) . . . f (se ) ≥ Es∈S j(s1 ) · · · j(se ) − ǫ > 0,

63

1
χ(H)−1 −
most δn2 /2

implying that A was not H-free. Moreover, the number of edges in J is at least 1 −

2ǫ

n
2

.

Therefore, by the choice of ǫ, J may be made (χ(H) − 1)-partite by removing at
edges.
|X|
for
each
Let V1 , . . . , Vt be the partite pieces. By transference, |Ex∈Vi f (x) − Ex∈Vi j(x)| ≤ η |V
i|
1 ≤ i ≤ t. Therefore, if we remove all of the edges of A from each set in Vi , we have removed at most
t

t

j(x) + tη|X| ≤

f (x) ≤
i=1 x∈Vi

i=1 x∈Vi

δ
+ tη n2 ≤ δn2 .
2

Moreover, the graph that remains is (χ(H) − 1)-partite, so we are done.
It only remains to consider the case when p > λ. However, as observed in [34], for p constant, the
theorem follows from an application of the regularity lemma. This completes the proof.
✷
As a ﬁnal note, we would like to mention that the method used in the proof of Theorem 10.23 should
work quite generally. To take one more example, let K be the Fano plane. This is the hypergraph
formed by taking the seven non-zero vectors of dimension three over the ﬁeld with two elements and
making xyz an edge if x + y + z = 0. The resulting graph has seven vertices and seven edges. It is
known [4] that the extremal number of the Fano plane is approximately 43 n3 . Since the Fano plane
is strictly 3-balanced, Theorem 10.9 implies that if U is a random 3-uniform hypergraph chosen with
probability p ≥ Cn−2/3 , then, with high probability, U is such that any subgraph of U with at least
3
4 + ǫ |U | edges contains the Fano plane.
Moreover, it was proved independently by Keevash and Sudakov [33] and F¨
uredi and Simonovits
[14] that the extremal example is formed by dividing the ground set into subsets A and B of nearly
equal size and taking all triples that intersect both as edges. The stability version of this result says
that, for all δ > 0, there exists ǫ > 0 such that any 3-uniform hypergraph on n vertices with at least
n
3
4 −ǫ
3 edges that does not contain the Fano plane may be partitioned into two parts A and B
such that there are at most δn3 edges contained entirely within A or B. The same proof as that of
Theorem 10.23 then implies the following theorem.
Theorem 10.24. Given a constant δ > 0, there exist positive constants C and ǫ such that in the
(3)
random graph Gn,p chosen with probability p ≥ Cn−2/3 , the following holds with probability tending to
(3)
1 as n tends to infinity. Every subgraph of Gn,p with at least 34 − ǫ e(G) edges that does not contain
the Fano plane may be made bipartite, in the sense that all edges intersect both parts of the partition,
by removing at most δpn3 edges.

11

Concluding remarks

One question that the results of this paper leave open is to decide whether or not the thresholds we
have proved are sharp. By saying that a threshold is sharp, we mean that the window over which the
phase transition happens becomes arbitrarily small as the size of the ground set becomes large. For
example, a graph property P has a sharp threshold at pˆ = pˆ(n) if, for every ǫ > 0,
lim P(Gn,p satisﬁes P) =

n→∞

0, if p < (1 − ǫ)ˆ
p,
1, if p > (1 + ǫ)ˆ
p.

Connectedness is a simple example of a graph property for which a sharp threshold is known. The
appearance of a triangle, on the other hand, is known not to be sharp. A result of Friedgut [10]
64

gives a criterion for judging whether a threshold is sharp or not. Roughly, this criterion says that
if the property is globally determined, it is sharp, and if it is locally determined, it is not. This
intuition allows one to conclude fairly quickly that connectedness should have a sharp threshold and
the appearance of any particular small subgraph should not.
For the properties that we have discussed in this paper it is much less obvious whether the bounds
are sharp or not. Many of the properties are not even monotone, which is crucial if one wishes to apply
Friedgut’s criterion. Nevertheless, the properties do not seem to be too pathological, so perhaps there
is some small hope that the sharpness of their thresholds can be proved. There has even been some
success in this direction already. Recall that the threshold at which Gn,p becomes 2-colour Ramsey
with respect to triangles is approximately n−1/2 . A diﬃcult result of Friedgut, R¨
odl, Ruci´
nski and
Tetali [11] states that this threshold is sharp. That is, there exists cˆ = cˆ(n) such that, for every ǫ > 0,
lim P(Gn,p is (K3 , 2)-Ramsey) =

n→∞

0, if p < (1 − ǫ)ˆ
cn−1/2 ,
1, if p > (1 + ǫ)ˆ
cn−1/2 .

Unfortunately, the function cˆ(n) is not known to tend towards a constant. It could, at least in principle,
wander up and down forever between the two endpoints. Nevertheless, we believe that extending this
result to cover all (or any) of the theorems in this paper is important.
There are other improvements that it might well be possible to make. We proved our graph and
hypergraph results for strictly balanced graphs and hypergraphs, while the results of Schacht [55] and
Friedgut, R¨
odl and Schacht [12] apply to all graphs and hypergraphs. On the other hand, our methods
allow us to prove structural results such as the stability theorem which do not seem to follow from
their approach. It seems plausible that some synthesis of the two approaches could allow us to extend
these latter results to general graphs and hypergraphs in a tidy fashion.2
In our approach, restricting to strictly balanced graphs and hypergraphs was very convenient,
since it allowed us to cap our convolutions only at the very last stage (that is, when all the functions
involved had sparse random support). In more general cases, capping would have to take place “all
the way down”. It seems likely that this can be done, but that a direct attempt to generalize our
methods would be messy.
A more satisfactory approach would be to ﬁnd a neater way of proving our probabilistic estimates.
The process of capping is a bit ugly: a better approach might be to argue that with high probability
we can say roughly how the modulus of an uncapped convolution is distributed, and use that in an
inductive hypothesis. (It seems likely that the distribution is approximately Poisson.)
Thus, it seems that the problem of extending our methods to general graphs and hypergraphs and
the problem of ﬁnding a neater proof of the probabilistic estimates go hand in hand.

References
[1] J. Balogh, R. Morris and W. Samotij, Independent sets in hypergraphs, to appear in J. Amer.
Math. Soc.
2

In subsequent work, Samotij [53] showed how to adapt Schacht’s method so that it also applies to structural statements such as Theorem 1.11. However, it still remains an open problem to extend the methods of this paper to all graphs
and hypergraphs.

65

[2] V. Bergelson and A. Leibman, Polynomial extensions of van der Waerden’s and Szemer´edi’s theorems, J. Amer. Math. Soc. 9 (1996), 725–753.
[3] B. Bollob´
as, Extremal Graph Theory, Dover Publications, Inc., Mineola, NY, 2004. Reprint of
the 1978 original.
[4] D. de Caen and Z. F¨
uredi, The maximum size of 3-uniform hypergraphs not containing a Fano
plane, J. Combin. Theory Ser. B 78 (2000), 274–276.
[5] D. Conlon, Combinatorial theorems relative to a random set, to appear in Proceedings of the 2014
ICM.
[6] D. Conlon, W. T. Gowers, W. Samotij and M. Schacht, On the KLR conjecture in random graphs,
to appear in Israel J. Math.
[7] P. Erd˝os, On the number of complete subgraphs contained in certain graphs, Magyar Tud. Akad.
Mat. Kutat´
o Int. K¨
ozl. 7 (1962), 459–464.
[8] P. Erd˝os and M. Simonovits, Supersaturated graphs and hypergraphs, Combinatorica 3 (1983),
181–192.
[9] P. Frankl and V. R¨
odl, Large triangle-free subgraphs in graphs without K4 , Graphs Combin. 2
(1986), 135–144.
[10] E. Friedgut, Sharp thresholds of graph properties, and the k-sat problem, J. Amer. Math. Soc.
12 (1999), 1017–1054.
[11] E. Friedgut, V. R¨
odl, A. Ruci´
nski and P. Tetali, A sharp threshold for random graphs with
a monochromatic triangle in every edge coloring, Mem. Amer. Math. Soc. 179 (2006), no. 845,
vi+66pp.
[12] E. Friedgut, V. R¨
odl and M. Schacht, Ramsey properties of discrete random structures, Random
Structures Algorithms 37 (2010), 407–436.
[13] Z. F¨
uredi, Random Ramsey graphs for the four-cycle, Discrete Math. 126 (1994), 407–410.
[14] Z. F¨
uredi and M. Simonovits, Triple systems not containing a Fano conﬁguration, Combin. Probab.
Comput. 14 (2005), 467–484.
[15] H. Furstenberg and Y. Katznelson, An ergodic Szemer´edi Theorem for commuting transformations, J. Analyse Math. 34 (1978), 275–291.
[16] S. Gerke, Y. Kohayakawa, V. R¨
odl and A. Steger, Small subsets inherit sparse ǫ-regularity, J.
Combin. Theory Ser. B 97 (2007), 34–56.
[17] S. Gerke, H. J. Pr¨omel, T. Schickinger, A. Steger and A. Taraz, K4 -free subgraphs of random
graphs revisited, Combinatorica 27 (2007), 329–365.
[18] S. Gerke, A. Steger and T. Schickinger, K5 -free subgraphs of random graphs, Random Structures
Algorithms 24 (2004), 194–232.
66

[19] W. T. Gowers, A new proof of Szemer´edi’s theorem, Geom. Funct. Anal. 11 (2001), 465–588.
[20] W. T. Gowers, Quasirandomness, counting and regularity for 3-uniform hypergraphs, Combin.
Probab. Comput. 15 (2006), 143–184.
[21] W. T. Gowers, Hypergraph regularity and the multidimensional Szemer´edi theorem, Ann. of
Math. 166 (2007), 897–946.
[22] W. T. Gowers, Decompositions, approximate structure, transference, and the Hahn–Banach theorem, Bull. London Math. Soc. 42 (2010), 573–606.
[23] R. Graham, V. R¨
odl and A. Ruci´
nski, On Schur properties of random subsets of integers, J.
Number Theory 61 (1996), 388–408.
[24] B. Green and T. Tao, The primes contain arbitrarily long arithmetic progressions, Ann. of Math.
167 (2008), 481–547.
[25] M. Hamel and I. Laba, Arithmetic structures in random sets, Integers 8 (2008), A04, 21pp.
[26] P. E. Haxell, Y. Kohayakawa and T. Luczak, Tur´
an’s extremal problem in random graphs: forbidding even cycles, J. Combin. Theory Ser. B 64 (1995), 273–287.
[27] P. E. Haxell, Y. Kohayakawa and T. Luczak, Tur´
an’s extremal problem in random graphs: forbidding odd cycles, Combinatorica 16 (1996), 107–122.
[28] S. Janson, Poisson approximation for large deviations, Random Structures Algorithms 1 (1990),
221–229.
[29] S. Janson, K. Oleszkiewicz and A. Ruci´
nski, Upper tails for subgraph counts in random graphs,
Israel J. Math. 142 (2004), 61–92.
[30] S. Janson and A. Ruci´
nski, The infamous upper tail, Random Structures Algorithms 20 (2002),
317–342.
[31] S. Janson and A. Ruci´
nski, The deletion method for upper tail estimates, Combinatorica 24
(2004), 615–640.
[32] S. Janson and A. Ruci´
nski, Upper tails for counting objects in randomly induced subhypergraphs
and rooted random graphs, Ark. Mat. 49 (2011), 79–96.
[33] P. Keevash and B. Sudakov, The Tur´
an number of the Fano plane, Combinatorica 25 (2005),
561–574.
[34] Y. Kohayakawa, Szemer´edi’s regularity lemma for sparse graphs, in Foundations of computational
mathematics (Rio de Janeiro, 1997), 216–230, Springer, Berlin, 1997.
[35] Y. Kohayakawa, T. Luczak and V. R¨
odl, Arithmetic progressions of length three in subsets of a
random set, Acta Arith. 75 (1996), 133–163.
[36] Y. Kohayakawa, T. Luczak and V. R¨
odl, On K4 -free subgraphs of random graphs, Combinatorica
17 (1997), 173–213.
67

[37] Y. Kohayakawa, V. R¨
odl and M. Schacht, The Tur´
an theorem for random graphs, Combin. Probab.
Comput. 13 (2004), 61–91.
[38] T. Luczak, Randomness and regularity, in International Congress of Mathematicians, Vol. III,
899–909, Eur. Math. Soc., Z¨
urich, 2006.
[39] T. Luczak, A. Ruci´
nski and B.Voigt, Ramsey properties of random graphs, J. Combin. Theory
Ser. B 56 (1992), 55–68.
[40] B. Nagle, V. R¨
odl and M. Schacht, The counting lemma for regular k-uniform hypergraphs,
Random Structures Algorithms 28 (2006), 113–179.
[41] H. Nguyen, On two-point conﬁgurations in a random set, Integers 9 (2009), 41–45.
[42] R. Rado, Note on combinatorial analysis, Proc. London Math. Soc. 48 (1941), 122–160.
[43] F. P. Ramsey, On a problem of formal logic, Proc. London Math. Soc. 30 (1930), 264–286.
[44] O. Reingold, L. Trevisan, M. Tulsiani and S. Vadhan, Dense subsets of pseudorandom sets, in
Proceedings of the 2008 49th Annual IEEE Symposium on Foundations of Computer Science, 76–85,
IEEE Computer Society, Washington DC, 2008.
[45] V. R¨
odl and A. Ruci´
nski, Lower bounds on probability thresholds for Ramsey properties, in
Combinatorics, Paul Erd˝os is Eighty, Vol. 1, 317–346, Bolyai Soc. Math. Studies, J´
anos Bolyai
Math. Soc., Budapest, 1993.
[46] V. R¨
odl and A. Ruci´
nski, Random graphs with monochromatic triangles in every edge coloring,
Random Structures Algorithms 5 (1994), 253–270.
[47] V. R¨
odl and A. Ruci´
nski, Threshold functions for Ramsey properties, J. Amer. Math. Soc. 8
(1995), 917–942.
[48] V. R¨
odl and A. Ruci´
nski, Rado partition theorem for random subsets of integers, Proc. London
Math. Soc. 74 (1997), 481–502.
[49] V. R¨
odl and A. Ruci´
nski, Ramsey properties of random hypergraphs, J. Combin. Theory Ser. A
81 (1998), 1–33.
[50] V. R¨
odl, A. Ruci´
nski and M. Schacht, Ramsey properties of random k-partite, k-uniform hypergraphs, SIAM J. Discrete Math. 21 (2007), 442–460.
[51] V. R¨
odl and J. Skokan, Regularity lemma for uniform hypergraphs, Random Structures Algorithms
25 (2004), 1–42.
[52] K. F. Roth, On certain sets of integers, J. London Math. Soc. 28 (1953), 104–109.
[53] W. Samotij, Stability results for random discrete structures, Random Structures Algorithms 44
(2014), 269–289.
[54] D. Saxton and A. Thomason, Hypergraph containers, to appear in Invent. Math.
68

[55] M. Schacht, Extremal results for discrete random structures, preprint.
¨
[56] I. Schur, Uber
die Kongruenz xm + y m = z m (mod p), Jber. Deutsch. Mat. Verein. 25 (1916),
114–117.
[57] M. Simonovits, A method for solving extremal problems in graph theory, stability problems, in
Theory of Graphs (Proc. Colloq., Tihany, 1966), 279–319, Academic Press, New York, 1968.
[58] T. Szab´
o and V. H. Vu, Tur´
an’s theorem in sparse random graphs, Random Structures Algorithms
23 (2003), 225–234.
[59] E. Szemer´edi, On sets of integers containing no k elements in arithmetic progression, Acta Arith.
27 (1975), 199–245.
[60] E. Szemer´edi, Regular partitions of graphs, in Probl`emes combinatoires et th´eorie des graphes
(Orsay 1976), Colloq. Internat. CNRS, 260, 399–401, CNRS, Paris, 1978.
[61] T. Tao, A variant of the hypergraph removal lemma, J. Combin. Theory Ser. A 113 (2006),
1257–1280.
[62] Paul Tur´
an, Egy gr´
afelm´eleti sz´els˝
o´ert´ekfeladatr´ol, Mat. Fiz. Lapok 48 (1941), 436–452.
[63] B. L. van der Waerden, Beweis einer Baudetschen Vermutung, Nieuw. Arch. Wisk. 15 (1927),
212–216.
[64] P. Varnavides, On certain sets of positive density, J. London Math. Soc. 34 (1959), 358–360.
[65] V. H. Vu, A large deviation result on the number of small subgraphs of a random graph, Combin.
Probab. Comput. 10 (2001), 79–94.

69

